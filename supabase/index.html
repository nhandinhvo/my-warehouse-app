<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="icon.ico?v=1" type="image/x-icon">
    <title>Quản Lý Kho ABE</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- XLSX for Excel import/export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Supabase JS client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* Màu nền dự phòng */

            /* Đường dẫn tới ảnh của bạn */
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            position: relative;
            /* RẤT QUAN TRỌNG: Để body là container cho lớp phủ ảo */
            z-index: 1;
            /* Đảm bảo body nằm trên lớp phủ nếu có bất kỳ z-index nào khác */
        }

        /* === BỔ SUNG: CSS CHO TAB GHI CHÚ === */
        .note-card {
            background-color: #fefce8;
            /* Màu vàng nhạt (yellow-50) */
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #facc15;
            /* Viền vàng đậm (yellow-400) */
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .note-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        .note-card .note-content {
            flex-grow: 1;
            margin-bottom: 1rem;
            white-space: pre-wrap;
            /* Giữ lại các khoảng trắng và xuống dòng */
            word-wrap: break-word;
        }

        #validation-modal #stock-modal-title {
            display: none;
        }

        .note-card .note-content-edit {
            width: 100%;
            min-height: 100px;
            background-color: #fefce8;
            border: 1px dashed #eab308;
            border-radius: 4px;
            padding: 8px;
        }

        .note-card .note-footer {
            font-size: 0.75rem;
            color: #71717a;
            /* ainc-500 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.5rem;
            border-top: 1px solid #fde047;
            /* yellow-300 */
        }

        .note-card .note-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: #a16207;
            /* yellow-700 */
            padding: 4px;
        }

        .note-card .note-actions button:hover {
            color: #422006;
            /* yellow-900 */
        }

        /* === Lớp phủ (Overlay) bán trong suốt trên ảnh nền === */
        body::before {
            content: "";
            /* Bắt buộc phải có */
            position: fixed;
            /* Hoặc absolute, fixed thường tốt hơn cho ảnh nền toàn màn hình */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Thay đổi màu và độ trong suốt của lớp phủ
            Đổi lớp phủ thành màu đen nhẹ để làm dịu ảnh nền sáng hơn */
            background-color: rgba(0, 0, 0, 0.25);
            /* Màu đen với độ trong suốt 25% */
            z-index: -1;
            /* Đặt lớp phủ NẰM DƯỚI nội dung chính của body */
        }

        /* === BỔ SUNG: CSS CHO DANH SÁCH CHỌN LOẠI GIAO DỊCH TRONG MODAL === */
        #transaction-type-list {
            display: grid;
            grid-template-columns: 1fr;
            /* Một cột */
            gap: 0.75rem;
            /* Khoảng cách giữa các mục */
            margin-top: 1.5rem;
            /* Khoảng cách với tiêu đề */
            margin-bottom: 1.5rem;
        }

        .transaction-type-label {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.25rem;
            border: 1px solid #e5e7eb;
            /* Viền xám nhạt */
            border-radius: 0.75rem;
            /* Bo góc */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: #f9fafb;
            /* Màu nền xám rất nhạt */
        }

        /* Ẩn radio button gốc đi */
        .transaction-type-label input[type="radio"] {
            display: none;
        }

        .transaction-type-label:hover {
            border-color: #9ca3af;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.05);
        }

        .transaction-type-label .icon-wrapper {
            font-size: 1.25rem;
            margin-right: 1rem;
            width: 2rem;
            /* Đảm bảo icon thẳng hàng */
            text-align: center;
        }

        .transaction-type-label .text-wrapper .title {
            font-weight: 600;
            /* Chữ đậm hơn */
            font-size: 1rem;
            color: #1f2937;
        }

        .transaction-type-label .text-wrapper .description {
            font-size: 0.875rem;
            color: #6b7280;
        }

        /* === ĐỊNH NGHĨA MÀU SẮC KHI ĐƯỢC CHỌN (QUAN TRỌNG NHẤT) === */
        /* Khi radio được chọn, thay đổi giao diện của label */

        /* 1. Nhập kho (Xanh lá) */
        .transaction-type-label input[type="radio"]:checked {
            --type-color: #10b981;
            /* Green-500 */
            --type-bg-color: #ecfdf5;
            /* Green-50 */
            --type-border-color: #10b981;
            --type-text-color: #065f46;
            /* Green-800 */
        }

        /* 2. Xuất kho (Đỏ) */
        .transaction-type-label input[value="export"]:checked {
            --type-color: #ef4444;
            /* Red-500 */
            --type-bg-color: #fef2f2;
            /* Red-50 */
            --type-border-color: #ef4444;
            --type-text-color: #991b1b;
            /* Red-800 */
        }

        /* 3. Trả hàng (Tím) */
        .transaction-type-label input[value="return"]:checked {
            --type-color: #8b5cf6;
            /* Violet-500 */
            --type-bg-color: #f5f3ff;
            /* Violet-50 */
            --type-border-color: #8b5cf6;
            --type-text-color: #5b21b6;
            /* Violet-800 */
        }

        /* 4. Đặt hàng (Cam) */
        .transaction-type-label input[value="order"]:checked {
            --type-color: #f97316;
            /* Orange-500 */
            --type-bg-color: #fff7ed;
            /* Orange-50 */
            --type-border-color: #f97316;
            --type-text-color: #9a3412;
            /* Orange-800 */
        }

        /* 5. Dự kiến (Xanh dương) */
        .transaction-type-label input[value="forecast"]:checked {
            --type-color: #3b82f6;
            /* Blue-500 */
            --type-bg-color: #eff6ff;
            /* Blue-50 */
            --type-border-color: #3b82f6;
            --type-text-color: #1e40af;
            /* Blue-800 */
        }

        /* Áp dụng các biến màu khi được chọn */
        .transaction-type-label:has(input[type="radio"]:checked) {
            background-color: var(--type-bg-color);
            border-color: var(--type-border-color);
            box-shadow: 0 0 0 2px var(--type-bg-color);
        }

        .transaction-type-label:has(input[type="radio"]:checked) .icon-wrapper,
        .transaction-type-label:has(input[type="radio"]:checked) .text-wrapper .title {
            color: var(--type-color);
        }

        .transaction-type-label:has(input[type="radio"]:checked) .text-wrapper .description {
            color: var(--type-text-color);
        }

        /* === Các phần tử chứa nội dung chính (ví dụ: các card, bảng, thanh tìm kiếm) === */
        .dashboard-card,
        .bg-white {
            /* Màu nền của các hộp là trắng với độ trong suốt 65% */
            background-color: rgba(255, 255, 255, 0.65);
            /* Trắng với độ trong suốt 65% */

            /* BẮT BUỘC có để tạo hiệu ứng kính mờ và bo góc */
            backdrop-filter: blur(8px) saturate(180%);
            -webkit-backdrop-filter: blur(8px) saturate(180%);
            border-radius: 12px;
            /* Đảm bảo bo tròn */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.3);
            /* Viền trắng trong suốt */
        }


        /* Màu chữ cho tiêu đề H1 */
        h1.text-gray-800 {
            color: #1f2937 !important;
            /* Đổi thành màu tối */
            text-shadow: none !important;
            /* Bỏ bóng đổ nếu không cần */
        }

        /* Màu chữ cho icon trong H1 */
        h1.text-gray-800 .fa-warehouse {
            color: #3b82f6 !important;
            /* Giữ nguyên màu xanh dương */
        }

        /* Màu chữ cho các tab navigation */
        .tab-btn {
            color: #ffffff !important;
            /* Mặc định đổi sang màu trắng */
            text-shadow: 0.5px 0.5px 1px rgba(0, 0, 0, 0.3);
            /* Bóng nhẹ */
        }

        .tab-btn.active {
            color: #87ceeb !important;
            /* Ví dụ: màu xanh da trời nhạt hơn */
            border-bottom-color: #87ceeb !important;
            /* Viền dưới cũng đổi màu */
            text-shadow: none;
            /* Bỏ bóng cho tab active nếu không cần */
        }

        .tab-btn:hover {
            color: #e0f2f7 !important;
            /* Ví dụ: màu trắng xanh */
        }

        /* Màu chữ cho nút Đăng xuất */
        #logout-btn {
            color: #ffffff !important;
            /* Màu trắng */
            background-color: rgba(108, 117, 125, 0.7) !important;
            /* Màu xám đen hơi trong suốt */
            border: 1px solid rgba(255, 255, 255, 0.3);
            /* Viền trắng trong suốt */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
        }

        #logout-btn:hover {
            background-color: rgba(108, 117, 125, 1) !important;
            /* Đậm hơn khi hover */
        }

        /* Màu chữ và hiệu ứng nổi bật cho thông báo cập nhật tồn kho */
        .announcement-text {
            color: #ffd700 !important;
            /* Gold color - màu vàng nổi bật */
            font-weight: 700 !important;
            /* Tăng độ đậm */
            font-size: 1.1em !important;
            /* Tăng kích thước */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
            /* Thêm bóng đổ rõ hơn */
            animation: blink 1.5s linear infinite;
            /* Điều chỉnh tốc độ nhấp nháy */
        }


        /* Modal transitions */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal:not(.is-open) {
            opacity: 0;
            visibility: hidden;
        }

        .modal.is-open {
            opacity: 1;
            visibility: visible;
        }

        .table-fixed th,
        .table-fixed td {
            padding: 12px 16px;
            /* Đảm bảo không có các dòng này nếu chúng còn sót lại */
            /* overflow: hidden; */
            /* text-overflow: ellipsis; */
            /* white-space: nowrap; */
            vertical-align: top;
        }

        /* BẮT ĐẦU CSS MỚI CHO CÁC LOẠI CỘT TRONG BẢNG */
        /* Đây là cách để TẤT CẢ các cột có thể xuống dòng */
        .table-fixed th,
        .table-fixed td {
            padding: 12px 16px;
            vertical-align: top;
            /* Căn nội dung lên trên cùng nếu xuống dòng */
            white-space: normal;
            /* **BẬT XUỐNG DÒNG MẶC ĐỊNH CHO TẤT CẢ CỘT** */
            word-wrap: break-word;
            /* Cho phép ngắt từ nếu quá dài */
            min-width: 100px;
            /* Một chiều rộng tối thiểu chung cho tất cả các cột để tránh quá hẹp */
        }

        /* Tùy chỉnh min-width cho các cột cụ thể nếu muốn rộng hơn */
        .table-fixed .name-col {
            min-width: 180px;
            /* Rộng hơn cho tên sản phẩm/khách hàng */
        }

        .table-fixed .note-col {
            min-width: 220px;
            /* Rộng hơn nữa cho ghi chú */
        }

        /* Loại bỏ class .fixed-min-width-col này khỏi các thẻ <th>/
<td>
    vì bây giờ tất cả đều xuống dòng. Hoặc nếu bạn vẫn muốn một số cột bị cắt,
    chúng ta sẽ cần điều chỉnh riêng chúng sau.
    Với yêu cầu hiện tại "dữ liệu ở các cột tự xuống dòng để thấy",
    chúng ta sẽ loại bỏ sự cần thiết của class này. */

        /* KẾT THÚC CSS MỚI CHO CÁC LOẠI CỘT TRONG BẢNG */
        /* Allow notes to wrap */
        .table-fixed .note-col {
            white-space: normal;
        }

        /* === BỔ SUNG: CSS CỤ THỂ CHO BẢNG TRONG MODAL CHI TIẾT GIAO DỊCH === */
        /* Container của bảng trong modal chi tiết giao dịch */
        #history-detail-modal .max-h-[60vh] {
            overflow-x: auto;
        }

        #history-detail-modal table {
            table-layout: auto;
            width: auto;
            min-width: 100%;
        }

        #history-detail-modal table th,
        #history-detail-modal table td {
            white-space: nowrap;
            overflow: visible;
            text-overflow: clip;
        }

        /* Riêng cột Ghi Chú (notes) vẫn có thể xuống dòng nếu cần */
        #history-detail-modal table .note-col {
            white-space: normal;
        }

        /* === KẾT THÚC BỔ SUNG CSS CỤ THỂ === */


        /* Button hover effects */
        .btn {
            transition: all 0.2s ease-in-out;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Dashboard card hover effects */
        .dashboard-card {
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Stock modal specific styling */
        #stock-modal-content {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        #stock-form {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }

        #stock-modal .table-wrapper {
            flex-grow: 1;
            overflow-y: auto;
        }

        #stock-items-container td {
            overflow: visible;
        }

        /* Active tab button styling */
        .tab-btn.active {
            border-bottom-color: #de1d10;
            color: #3b82f6;
        }

        /* Icon alignment in buttons */
        .btn-with-icon .fas {
            vertical-align: middle;
            line-height: 1;
            margin-top: -1px;
            margin-bottom: -1px;
        }

        /* Tab bar layout */
        .tab-bar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            border-bottom: 1px solid #e0e0e0;
        }

        /* Hide elements in view mode */
        .view-mode.hidden {
            display: none !important;
        }

        /* Hide input/select elements in view mode */
        .shipment-carrier-input.hidden,
        .shipment-tracking-input.hidden,
        .shipment-notes-input.hidden,
        .shipment-status-select.hidden {
            display: none;
        }

        /* === BỔ SUNG: CSS CHO MỤC ĐƯỢC TÔ SÁNG TRONG POPUP CHỌN SẢN PHẨM === */
        .highlighted-item {
            background-color: #FBBF24 !important;
            /* Màu vàng (amber-400 của Tailwind) */
            color: #1f2937 !important;
            /* Màu chữ tối để dễ đọc */
        }

        /* Hide save/edit buttons correctly */
        .action-buttons-cell .save-shipment-btn.hidden,
        .action-buttons-cell .edit-shipment-btn.hidden {
            display: none !important;
        }

        .marquee-container {
            position: relative;
            white-space: nowrap;
            overflow: hidden;
        }

        .marquee-text {
            display: inline-block;
            animation: marquee 15s linear infinite;
        }

        @keyframes marquee {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        /* Hiệu ứng nhấp nháy (Announcements) */
        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.2;
                /* Nhấp nháy xuống 20% opacity */
            }

            100% {
                opacity: 1;
            }
        }

        /* Sidebar */
        #sidebar {
            width: 256px;
            /* w-64 */
            min-width: 256px;
            /* Để tránh co lại */
            /* Các thuộc tính khác đã có trong HTML bằng Tailwind classes */
        }

        /* Các nút tab trong sidebar */
        .sidebar-tab-btn {
            color: #d1d5db;
            /* gray-300 */
            transition: all 0.2s ease-in-out;
        }

        .sidebar-tab-btn:hover {
            background-color: #374151;
            /* gray-700 */
            color: #ffffff;
        }

        .sidebar-tab-btn.active {
            background-color: #3b82f6;
            /* blue-600, màu của tab active */
            color: #ffffff;
            font-weight: 600;
            /* semi-bold */
            border-left: 4px solid #bfdbfe;
            /* blue-200, tạo điểm nhấn */
            padding-left: calc(1.5rem - 4px);
            /* Điều chỉnh padding để bù viền */
        }
    </style>
</head>

<body>
    <div id="global-error-banner"
        class="hidden fixed top-0 left-0 right-0 bg-red-600 text-white p-4 text-center z-[1000]">
        <p><i class="fas fa-exclamation-triangle mr-2"></i><strong id="global-error-message"></strong></p>
        <p class="text-sm mt-1">Vui lòng kiểm tra lại kết nối mạng hoặc cài đặt dự án.</p>
    </div>

    <div class="flex h-screen bg-gray-100">

        <aside id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col shadow-lg overflow-y-auto">


            <nav class="flex-grow mt-4 space-y-2">
                <button id="tab-notes" class="sidebar-tab-btn w-full text-left px-6 py-3 flex items-center text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
                    <i class="fas fa-sticky-note mr-3"></i> Trang chủ
                </button>
                <button id="tab-products" class="sidebar-tab-btn w-full text-left px-6 py-3 flex items-center text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
                    <i class="fas fa-boxes-stacked mr-3"></i> Sản phẩm
                </button>
                <button id="open-stock-manual-btn"
                        class="sidebar-tab-btn w-full text-left px-6 py-3 flex items-center text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
                        <i class="fas fa-plus-circle mr-3"></i> Tạo Phiếu Lẻ
                    </button>
                <div class="mt-8 pt-4 border-t border-gray-700 mx-6 text-gray-500 text-sm">Giao dịch</div>
                <button id="tab-import" class="sidebar-tab-btn w-full text-left px-6 py-3 flex items-center text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
                    <i class="fas fa-arrow-down mr-3"></i> Nhập kho
                </button>
                <button id="tab-export" class="sidebar-tab-btn w-full text-left px-6 py-3 flex items-center text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
                    <i class="fas fa-arrow-up mr-3"></i> Xuất kho
                </button>
                <button id="tab-return" class="sidebar-tab-btn w-full text-left px-6 py-3 flex items-center text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
                    <i class="fas fa-undo mr-3"></i> Trả hàng
                </button>
                <button id="tab-order" class="sidebar-tab-btn w-full text-left px-6 py-3 flex items-center text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
                    <i class="fas fa-shopping-cart mr-3"></i> Đặt hàng
                </button>
                <button id="tab-forecast" class="sidebar-tab-btn w-full text-left px-6 py-3 flex items-center text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
                    <i class="fas fa-lightbulb mr-3"></i> Dự kiến
                </button>
                <button id="tab-shipping" class="sidebar-tab-btn w-full text-left px-6 py-3 flex items-center text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
                    <i class="fas fa-truck mr-3"></i> Vận chuyển
                </button>
            </nav>

            <div class="p-4 border-t border-gray-700 flex flex-col items-center justify-center">
                <p class="text-xs text-gray-400 mb-2">User ID: <span id="user-id-display"></span></p>
                <button id="logout-btn" class="w-full btn bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-sign-out-alt mr-2"></i> Đăng xuất
                </button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-auto p-4 md:p-8">

            <header class="mb-6 flex flex-col items-center">
                <div class="flex flex-col md:flex-row items-center justify-between w-full">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 flex items-center mb-2 md:mb-0">
                        <i class="fas fa-warehouse mr-3 text-blue-600"></i>Hệ Thống Quản Lý Kho
                    </h1>
                    <p class="announcement-text text-blue-600 font-semibold text-base whitespace-nowrap">
                        Web đang trong quá trình nâng cấp.
                    </p>
                </div>
            </header>

            <main id="content-area-main" class="flex-1 overflow-y-auto">
                <div id="panel-products">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div id="total-products-card" class="dashboard-card bg-white p-6 rounded-xl shadow-md border">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                                    <i class="fas fa-box-open fa-lg"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Tổng số sản phẩm</p>
                                    <p id="total-products" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                        <div id="total-quantity-card" class="dashboard-card bg-white p-6 rounded-xl shadow-md border">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                                    <i class="fas fa-boxes-stacked fa-lg"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Tổng số lượng tồn</p>
                                    <p id="total-quantity" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                        <div id="low-stock-card"
                            class="dashboard-card bg-white p-6 rounded-xl shadow-md border cursor-pointer">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-orange-100 text-orange-600 mr-4">
                                    <i class="fas fa-exclamation-circle fa-lg"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Sắp hết hàng (&lt;=20)</p>
                                    <p id="low-stock-count" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                        <div id="out-of-stock-card"
                            class="dashboard-card bg-white p-6 rounded-xl shadow-md border cursor-pointer">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-red-100 text-red-600 mr-4">
                                    <i class="fas fa-times-circle fa-lg"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Hết hàng</p>
                                    <p id="out-of-stock-count" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-md mb-6 flex flex-col gap-4">
                        <div class="flex flex-col md:flex-row md:items-center gap-4 flex-wrap w-full mb-4">
                            <div class="flex items-center gap-2 text-base">
                                <span>Hiển thị</span>
                                <select id="products-per-page-select" class="p-2 border border-gray-300 rounded-lg h-[40px]">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="-1">Tất cả</option>
                                </select>
                                <span>dữ liệu</span>
                            </div>

                            <div class="relative flex-grow">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i
                                        class="fas fa-search"></i></span>
                                <input type="search" id="search-input" placeholder="Tìm kiếm tất cả...."
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-[40px]">
                            </div>

                            <div class="relative w-56"> <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i
                                        class="fas fa-tags"></i></span>
                                <select id="category-filter"
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none h-[40px]">
                                    <option value="">Tất cả nhóm hàng</option>
                                </select>
                            </div>

                            <div class="relative w-48">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i
                                        class="fas fa-circle-dot"></i></span>
                                <select id="product-status-filter"
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none h-[40px]">
                                    <option value="active">Đang bán</option>
                                    <option value="inactive">Ngưng bán</option>
                                    <option value="all">Tất cả</option>
                                </select>
                            </div>

                            <div class="relative w-full md:w-36">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i
                                        class="fas fa-sort-numeric-down"></i></span>
                                <input type="number" id="min-quantity-filter" placeholder="Tồn từ" min="0"
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-[40px]">
                            </div>

                            <div class="relative w-full md:w-36">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i
                                        class="fas fa-sort-numeric-up"></i></span>
                                <input type="number" id="max-quantity-filter" placeholder="Tồn đến" min="0"
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-[40px]">
                            </div>
                        </div>

                        <div id="general-action-buttons" class="flex flex-wrap gap-2 justify-center w-full">
                            <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls">
                            <button id="open-product-modal-btn"
                                class="btn bg-blue-600 text-white font-semibold h-[40px] px-4 rounded-lg flex items-center justify-center text-center max-w-[180px] whitespace-nowrap"><i
                                    class="fas fa-plus mr-2"></i> Thêm Sản Phẩm</button>
                            <button id="import-excel-btn"
                                class="btn bg-teal-500 text-white font-semibold h-[40px] px-4 rounded-lg flex items-center justify-center text-center max-w-[180px] whitespace-nowrap"><i
                                    class="fas fa-file-excel mr-2"></i> Nhập Sản Phẩm</button>



                            <button id="export-excel-btn"
                                class="btn bg-green-600 text-white font-semibold h-[40px] px-4 rounded-lg flex items-center justify-center text-center max-w-[180px] whitespace-nowrap"><i
                                    class="fas fa-file-download mr-2"></i> Xuất Excel</button>

                            <button id="toggle-bulk-edit-products-btn"
                                class="btn bg-yellow-500 text-white font-semibold h-[40px] px-4 rounded-lg flex items-center justify-center text-center max-w-[180px] whitespace-nowrap"><i
                                    class="fas fa-pencil-alt mr-2"></i> Chỉnh Sửa</button>
                        </div>
                    </div>
                    <div id="product-bulk-actions-bar"
                        class="bg-blue-50 p-4 rounded-xl shadow-md mb-6 hidden items-center justify-between gap-4">
                        <span class="text-blue-800 font-semibold flex items-center">
                            Đã chọn <span id="selected-products-count" class="mx-1 text-lg">0</span> sản phẩm
                        </span>
                        <div class="flex items-center gap-3">
                            <button id="bulk-deactivate-products-btn"
                                class="btn bg-red-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center"
                                disabled>
                                <i class="fas fa-ban mr-2"></i> Ngưng bán đã chọn
                            </button>
                            <button id="bulk-activate-products-btn"
                                class="btn bg-green-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center"
                                disabled>
                                <i class="fas fa-check-circle mr-2"></i> Kích hoạt lại đã chọn
                            </button>
                            <button id="bulk-delete-products-btn"
                                class="btn bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center hidden"
                                disabled>
                                <i class="fas fa-trash-alt mr-2"></i> Xóa đã chọn
                            </button>
                            <button id="bulk-order-products-btn"
                                class="btn bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center"
                                disabled>
                                <i class="fas fa-truck mr-2"></i> Đặt hàng đã chọn
                            </button>
                            <button id="cancel-bulk-edit-products-btn"
                                class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                                Hủy
                            </button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                        <table class="w-full table-auto text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 text-center w-[5%] product-select-col hidden"><input
                                            type="checkbox" id="product-select-all-checkbox">
                                    </th>
                                    <th class="p-3 font-semibold text-gray-600 w-[8%]">Nhóm Hàng</th>
                                    <th class="p-3 font-semibold text-gray-600 w-[30%]">Tên Sản Phẩm</th>
                                    <th class="p-3 font-semibold text-gray-600 w-[8%]">Mã SP</th>
                                    <th class="p-3 font-semibold text-gray-600 text-right w-[12%]">Đơn Giá</th>
                                    <th class="p-3 font-semibold text-gray-600 w-[14%] note-col">Ghi Chú</th>
                                    <th class="p-3 text-center font-semibold text-gray-600 w-[5%]">Tồn</th>
                                    <th class="p-3 text-center font-medium text-blue-600">Đặt Hàng</th>
                                    <th class="p-3 text-center font-medium text-purple-600">Dự Xuất</th>
                                    <th class="p-3 text-center font-semibold text-gray-600 w-[10%]">Hành Động</th>
                                </tr>
                            </thead>
                            <tbody id="product-table-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                        <div id="loading-spinner" class="p-8 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p>Đang tải dữ liệu...</p>
                        </div>
                    </div>
                    <div id="products-pagination-controls"
                        class="flex justify-between items-center gap-4 my-4 p-4 bg-white rounded-xl shadow-md mt-4">
                    </div>
                </div>

                <div id="panel-history" class="hidden">
                    <div
                        class="bg-white p-4 rounded-xl shadow-md mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="flex items-center gap-4 w-full md:w-auto">
                            <div class="flex items-center gap-2">
                                <span>Hiển thị</span>
                                <select id="history-per-page-select" class="p-2 border border-gray-300 rounded-lg">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="-1">Tất cả</option>
                                </select>
                                <span>dữ liệu</span>
                            </div>
                            <div class="relative w-full md:w-auto flex-grow">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i class="fas fa-search"></i></span>
                                <input type="search" id="history-search-input" placeholder="Tìm kiếm trong tab này..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <div class="flex items-center gap-2 flex-wrap justify-center">
                            <button id="add-to-shipping-btn" class="btn bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center hidden" disabled>
                                <i class="fas fa-truck-fast mr-2"></i> Đưa vào Vận chuyển (<span id="selected-history-count-shipping">0</span>)
                            </button>

                            <button id="export-history-btn" class="btn bg-green-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-file-download mr-2"></i> Xuất Excel
                            </button>

                            <button id="delete-selected-history-btn" class="btn bg-red-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center" disabled>
                                <i class="fas fa-trash-alt mr-2"></i> Xóa Đã Chọn (<span id="selected-history-count-delete">0</span>)
                            </button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md overflow-x-auto">

                        <table class="w-full table-fixed text-left">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="p-3 text-center w-[5%]"><input type="checkbox"
                                            id="history-select-all-checkbox">
                                    </th>
                                    <th class="p-3 font-semibold text-gray-600 w-[15%]">Ngày</th>
                                    <th class="p-3 font-semibold text-gray-600 w-[10%]">Loại Phiếu</th>
                                    <th class="p-3 font-semibold text-gray-600 w-[20%] name-col">Khách hàng</th>
                                    <th class="p-3 text-center font-semibold text-gray-600 w-[8%]">Mã Hàng</th>
                                    <th class="p-3 text-center font-semibold text-gray-600 w-[8%]">Số Lượng</th>
                                    <th class="p-3 font-semibold text-gray-600 w-[24%] note-col">Ghi chú</th>
                                    <th class="p-3 text-center font-semibold text-gray-600 w-[10%]">Hành Động</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="divide-y divide-gray-200"></tbody>

                        </table>
                        <div id="loading-history-spinner" class="p-8 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p>Đang tải lịch sử...</p>
                        </div>
                    </div>
                    <div id="history-pagination-controls"
                        class="flex justify-between items-center gap-4 my-4 p-4 bg-white rounded-xl shadow-md mt-4">
                    </div>
                </div>
                <div id="panel-shipping" class="hidden">
                    <div
                        class="bg-white p-4 rounded-xl shadow-md mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="flex items-center gap-4 flex-wrap w-full md:w-auto">
                            <div class="flex items-center gap-2">
                                <span>Hiển thị</span>
                                <select id="shipping-per-page-select" class="p-2 border border-gray-300 rounded-lg h-[40px]">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="-1">Tất cả</option>
                                </select>
                                <span>dữ liệu</span>
                            </div>
                            <div class="relative flex-grow">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i
                                        class="fas fa-search"></i></span>
                                <input type="search" id="shipping-search-input" placeholder="Tìm khách hàng, mã vận đơn..."
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-[40px]">
                            </div>
                        </div>

                        <div class="flex items-center gap-2 flex-wrap justify-center">
                            <button id="export-shipping-btn" class="btn bg-green-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-file-download mr-2"></i> Xuất Excel
                            </button>
                            <button id="delete-selected-shipping-btn"
                                class="btn bg-red-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center text-center text-sm flex-1 max-w-[190px] whitespace-nowrap"
                                disabled><i class="fas fa-trash-alt mr-2"></i> Xóa Đã Chọn (<span
                                    id="selected-shipping-count-delete">0</span>)</button>
                        </div>
                    </div>


                    <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                        <table class="w-full table-auto text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 text-center w-[5%]"><input type="checkbox" id="shipping-select-all-checkbox">
                                    </th>
                                    <th class="p-3 font-semibold text-gray-600 w-[10%]">Ngày tạo</th>
                                    <th class="p-3 font-semibold text-gray-600 w-[15%]">Khách hàng</th>
                                    <th class="p-3 font-semibold text-gray-600 w-[15%]">Đơn vị vận chuyển</th>
                                    <th class="p-3 font-semibold text-gray-600 w-[15%]">Mã vận đơn</th>
                                    <th class="p-3 font-semibold text-gray-600 w-[15%]">Ghi chú</th>
                                    <th class="p-3 font-semibold text-gray-600 w-[12%]">Trạng thái</th>
                                    <th class="p-3 text-center font-semibold text-gray-600 w-[10%]">Hành Động</th>
                                </tr>
                            </thead>
                            <tbody id="shipping-table-body" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                        <div id="loading-shipping-spinner" class="p-8 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p>Đang tải dữ liệu vận chuyển...</p>
                        </div>
                    </div>
                    <div id="shipping-pagination-controls"
                        class="flex justify-between items-center gap-4 my-4 p-4 bg-white rounded-xl shadow-md mt-4">
                    </div>
                </div>
                <div id="panel-notes" class="hidden">
                    <div class="mb-6 flex justify-between items-center">
                        <button id="add-note-btn" class="btn bg-yellow-400 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-500">
                                <i class="fas fa-plus mr-2"></i>Thêm Ghi Chú Mới
                            </button>
                    </div>
                    <div id="notes-container"
                        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    </div>
                    <div id="loading-notes-spinner" class="p-8 text-center text-white">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Đang tải ghi chú...</p>
                    </div>
                    <div id="gemini-search-section" class="mt-8">
    <div class="bg-white p-6 rounded-xl shadow-md border">
        <h3 class="text-xl font-bold text-gray-800 flex items-center mb-4">
            <i class="fas fa-search-dollar mr-3 text-purple-600"></i>
            Hỏi đáp về Kho hàng
        </h3>
        <div class="flex items-center gap-3 mb-4">
            <input type="search" id="gemini-search-input" placeholder="Ví dụ: còn bao nhiêu đôi 3 chấu vàng?"
                class="w-full pl-4 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 h-[44px]">
            <button id="gemini-search-btn"
                class="btn bg-purple-600 text-white font-semibold h-[44px] px-6 rounded-lg flex items-center justify-center whitespace-nowrap">
                <i class="fas fa-paper-plane mr-2"></i> Gửi
            </button>
        </div>
        <div id="gemini-search-results" class="mt-4 p-4 bg-gray-50 rounded-lg min-h-[50px]">
            <p class="text-gray-500">Nhập câu hỏi của bạn để tìm kiếm trong kho...</p>
        </div>
    </div>
</div>
                </div>
            </main>
        </div>
    </div>

    <div id="product-modal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all" id="product-modal-content">

            <form id="product-form" class="p-6">
                <input type="hidden" id="product-id">
                <h2 id="modal-title" class="text-2xl font-bold mb-6">Thêm Sản Phẩm Mới</h2>
                <div class="mb-4">
                    <label for="product-category" class="block text-sm font-medium text-gray-700 mb-1">Nhóm Hàng
                        (Chọn hoặc gõ để thêm mới)</label><input list="category-list-datalist" id="product-category"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <datalist id="category-list-datalist"></datalist>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700 mb-1">Tên
                            Hàng</label><input type="text" id="product-name" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="product-code" class="block text-sm font-medium text-gray-700 mb-1">Mã
                            Hàng</label><input type="text" id="product-code" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="product-price" class="block text-sm font-medium text-gray-700 mb-1">Đơn Giá
                            (₫)</label><input type="number" id="product-price" required min="0"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="product-quantity" class="block text-sm
                            font-medium text-gray-700 mb-1">Tồn
                            kho ban đầu</label><input type="number" id="product-quantity" required min="0"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="product-ordered" class="block text-sm font-medium text-gray-700 mb-1">SL Đặt
                            hàng</label><input type="number" id="product-ordered" min="0"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="product-forecast" class="block text-sm
                            font-medium text-gray-700 mb-1">SL Dự kiến xuất</label><input type="number"
                            id="product-forecast" min="0"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="product-notes"
                        class="block text-sm font-medium text-gray-700 mb-1">Ghi Chú</label><textarea
                        id="product-notes" rows="3"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Thông tin thêm về sản phẩm..."></textarea>
                </div>

                <div class="mb-6 flex items-center">
                    <input type="checkbox" id="product-is-active" class="form-checkbox h-5 w-5 text-blue-600">
                    <label for="product-is-active" class="ml-2 text-sm font-medium text-gray-700">Đang kinh
                        doanh</label>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="close-product-modal-btn"
                        class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg">Hủy</button>
                    <button type="submit" id="save-product-btn"
                        class="btn bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg">Lưu</button>
                </div>

            </form>
        </div>
    </div>
    <div id="stock-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
       <div class="bg-white rounded-xl shadow-2xl w-full max-w-[1500px] transform transition-all relative" 
    id="stock-modal-content">
    <button type="button" id="close-stock-modal-x-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none z-10">
        <i class="fas fa-times fa-lg"></i>
    </button>
            <form id="stock-form" class="p-6"><input type="hidden" id="editing-transaction-id">

                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div id="stock-date-wrapper" class="flex-1">

                        <label for="stock-date" class="block text-sm font-medium text-gray-700 mb-1">Ngày Lập
                            Phiếu</label><input type="date" id="stock-date" required
                            class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div id="single-customer-wrapper" class="flex-1">
                        <label for="stock-single-customer"
                            class="block text-sm font-medium text-gray-700 mb-1">Khách hàng</label><input
                            type="search" id="stock-single-customer" placeholder="Nhập tên khách hàng hoặc nhà cung cấp"
                            class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="flex-1">
                        <label for="stock-item-search" class="block text-sm font-medium text-gray-700 mb-1">Lọc
                            nhanh trong phiếu</label><input type="search" id="stock-item-search"
                            placeholder="Tìm tên, mã hàng..."
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="table-wrapper border rounded-lg mb-4">
                    <table class="w-full">

                        <thead class="bg-gray-100">
                            <tr>
                                <th id="date-col-header"
                                    class="p-2 text-left text-sm font-semibold text-gray-600 w-[8%]">Ngày</th>
                                <th id="customer-col-header"
                                    class="p-2 text-left text-sm font-semibold text-gray-600 w-[10%]">Khách hàng
                                </th>
                                <th class="p-2 text-left text-sm font-semibold text-gray-600 w-[11%]">Nhóm Hàng
                                </th>
                                <th class="p-2 text-left text-sm font-semibold text-gray-600 w-[34%]">Tên Hàng
                                </th>
                                <th class="p-2 text-left text-sm font-semibold text-gray-600 w-[9%]">Mã Hàng</th>
                                <th class="p-2 text-center text-sm font-semibold text-gray-600 w-[4%]">Tồn</th>
                                <th class="p-2 text-center text-sm font-semibold text-gray-600 w-[5%]">Số Lượng
                                </th>
                                <th class="p-2 text-left text-sm font-semibold text-gray-600 w-[10%]">Ghi Chú
                                </th>
                                <th class="p-2 text-center text-sm font-semibold
                                    text-gray-600 w-[7%]">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="stock-items-container" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="stock-pagination-controls" class="flex justify-center items-center gap-4 my-4"></div>

                <div class="flex justify-between items-start pt-4 border-t">
                    <button type="button" id="add-stock-item-btn"
                        class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg flex items-center"><i
                            class="fas fa-plus mr-2"></i> Thêm Dòng</button>
                    <div id="stock-summary" class="text-right text-sm">

                        <p id="summary-customer-line">Số phiếu sẽ tạo:
                            <span id="summary-total-customers" class="font-bold text-lg text-red-600">0</span>
                        </p>
                        <p>Số mã hàng: <span id="summary-unique-items" class="font-bold">0</span></p>

                        <p>Tổng số dòng: <span id="summary-total-rows" class="font-bold">0</span></p>
                        <p>Tổng số lượng:
                            <span id="summary-total-quantity" class="font-bold text-lg text-blue-600">0</span>
                        </p>
                    </div>
                </div>
                <div class="flex justify-center items-center mt-6">
                    <div class="flex gap-3">
                        <input type="file" id="stock-excel-input" class="hidden" accept=".xlsx, .xls">
                        <button type="button" id="import-stock-excel-btn"
                            class="btn bg-cyan-500 text-white font-semibold py-2 px-5 rounded-lg flex items-center btn-with-icon"><i
                                class="fas fa-file-upload mr-2"></i> Nhập từ Excel</button>
                        <button type="button" id="clear-all-stock-items-btn"
                            class="btn bg-red-500 text-white font-semibold py-2 px-5 rounded-lg flex items-center btn-with-icon">
                            <i class="fas fa-trash-alt mr-2"></i> Xóa Tất Cả Dòng
                        </button>
                        <button type="button" id="close-stock-modal-btn"
                            class="btn bg-gray-300 text-gray-800 font-semibold py-2 px-5 rounded-lg">
                            <i class="fas fa-times mr-2"></i> Hủy
                        </button>
                        <button type="submit" id="submit-stock-btn"
                            class="btn bg-green-500 text-white font-semibold py-2 px-5 rounded-lg">
                            <i class="fas fa-check mr-2"></i> Xác Nhận
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div id="validation-modal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center">

            <div id="validation-initial-wrapper">
                <h3 class="text-xl font-bold mb-4">Kiểm tra Giao dịch</h3>
                <div id="validation-loading" class="hidden"><i
                        class="fas fa-spinner fa-spin fa-2x text-blue-500"></i>
                    <p class="mt-2">Đang kiểm tra dữ liệu...</p>
                </div>

                <div id="validation-result">
                    <h2 id="stock-modal-title" class="text-2xl font-bold text-center">Tạo Phiếu</h2>

                    <div id="transaction-type-list">
                        <label class="transaction-type-label">
                            <input type="radio" name="stock-type" value="import" checked>
                            <span class="icon-wrapper text-green-600"><i class="fas fa-arrow-down"></i></span>
                            <span class="text-wrapper">
                                <span class="title">Nhập kho</span>
                                <span class="description">Tăng số lượng tồn kho.</span>
                            </span>
                        </label>

                        <label class="transaction-type-label">
                            <input type="radio" name="stock-type" value="export">
                            <span class="icon-wrapper text-red-600"><i class="fas fa-arrow-up"></i></span>
                            <span class="text-wrapper">
                                <span class="title">Xuất kho</span>
                                <span class="description">Giảm số lượng tồn kho.</span>
                            </span>
                        </label>

                        <label class="transaction-type-label">
                            <input type="radio" name="stock-type" value="return">
                            <span class="icon-wrapper text-purple-600"><i class="fas fa-undo"></i></span>
                            <span class="text-wrapper">
                                <span class="title">Trả hàng</span>
                                <span class="description">Nhận lại hàng đã xuất.</span>
                            </span>
                        </label>

                        <label class="transaction-type-label">
                            <input type="radio" name="stock-type" value="order">
                            <span class="icon-wrapper text-orange-600"><i class="fas fa-shopping-cart"></i></span>
                            <span class="text-wrapper">
                                <span class="title">Đặt hàng</span>
                                <span class="description">Ghi nhận SL cần đặt nhà cung cấp.</span>
                            </span>
                        </label>

                        <label class="transaction-type-label">
                            <input type="radio" name="stock-type" value="forecast">
                            <span class="icon-wrapper text-blue-600"><i class="fas fa-lightbulb"></i></span>
                            <span class="text-wrapper">
                                <span class="title">Dự kiến xuất</span>
                                <span class="description">Ghi nhận SL dự kiến giao cho khách.</span>
                            </span>
                        </label>
                    </div>


                    <div class="bg-gray-100 p-4 rounded-lg space-y-2 mb-6 text-left">
                        <div class="flex justify-between"><span>Số phiếu sẽ tạo:</span>
                            <span id="validation-customer-count" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between"><span>Tổng số dòng hợp lệ:</span>
                            <span id="validation-valid-count" class="font-bold text-green-600"></span>
                        </div>
                        <div class="flex justify-between"><span>Số dòng lỗi:</span>
                            <span id="validation-error-count" class="font-bold text-red-600"></span>
                        </div>
                    </div>
                    <p id="validation-message" class="mb-6"></p>
                    <div class="flex justify-center gap-4">
                        <button id="validation-close-btn"
                            class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg">Xem
                            lại</button><button id="validation-confirm-btn"
                            class="btn bg-green-500 text-white font-semibold py-2 px-6 rounded-lg">Thực hiện Giao
                            dịch</button>
                    </div>
                </div>
            </div>
            <div id="validation-processing" class="hidden">
                <h3 class="text-xl font-bold mb-4">Đang xử lý</h3><i
                    class="fas fa-cog fa-spin fa-3x text-blue-500"></i>
                <p class="mt-4 text-gray-600">Hệ thống đang ghi dữ liệu. Vui lòng chờ...</p>
            </div>
            <div id="validation-completed" class="hidden">
                <h3 class="text-xl font-bold mb-4">Hoàn tất</h3>
                <div id="completion-icon" class="mb-4">
                    <i class="fas fa-check-circle text-5xl text-green-500"></i>
                </div>
                <p id="completion-message" class="text-gray-700"></p>

                <div class="flex justify-center mt-6">
                    <button id="validation-completion-ok-btn"
                        class="btn bg-blue-600 text-white font-semibold py-2 px-8 rounded-lg">OK</button>
                </div>
            </div>
        </div>
    </div>
    <div id="history-detail-modal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl p-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-2xl font-bold mb-2">Chi tiết Giao dịch</h3>
                    <div class="text-sm text-gray-600 space-x-4">
                        <span><strong>Ngày:</strong> <span id="history-detail-date"></span></span><span><strong>Loại:</strong>
                            <span id="history-detail-type"></span></span><span><strong>Khách hàng:</strong> <span
                                id="history-detail-customer"></span></span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="history-detail-edit-btn"
                        class="btn bg-yellow-400 text-white font-semibold py-2 px-4 rounded-lg flex items-center hidden"><i
                            class="fas fa-edit mr-2"></i> Chỉnh sửa</button>
                    <button id="history-detail-export-btn"
                        class="btn bg-green-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center hidden"><i
                            class="fas fa-file-excel mr-2"></i> Xuất Excel</button>
                    <button id="history-detail-delete-btn"
                        class="btn bg-red-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center hidden"><i
                            class="fas fa-trash-alt mr-2"></i> Xóa</button>
                </div>
            </div>
            <div class="relative mb-4">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i
                        class="fas fa-search"></i></span><input type="search" id="history-detail-search"
                    placeholder="Tìm kiếm trong phiếu..."
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="max-h-[60vh] overflow-y-auto border rounded-lg">
                <table class="w-full table-fixed text-left">
                    <thead class="bg-gray-50 border-b border-gray-200 sticky top-0">
                        <tr>
                            <th class="font-semibold text-gray-600 p-3">Nhóm Hàng</th>
                            <th class="font-semibold text-gray-600 p-3 name-col">Tên Sản Phẩm</th>
                            <th class="font-semibold text-gray-600 p-3">Mã SP</th>
                            <th class="font-semibold text-gray-600 p-3 text-center">Số Lượng</th>
                            <th class="font-semibold text-gray-600 p-3 note-col">Ghi Chú</th>
                        </tr>
                    </thead>
                    <tbody id="history-detail-table-body" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6">
                <button id="close-history-detail-modal-btn"
                    class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg">Đóng</button>
            </div>
        </div>
    </div>
    <div id="status-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div id="status-confirm-wrapper"><i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>

                <h3 id="status-confirm-title" class="text-lg font-bold mb-2">Bạn có chắc chắn?</h3>
                <p id="status-confirm-message" class="text-gray-600 mb-6">Hành động này không thể hoàn tác.</p>
                <div class="flex justify-center gap-4">
                    <button id="status-cancel-btn"
                        class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg">Hủy</button><button
                        type="button" id="status-confirm-btn"
                        class="btn bg-red-600 text-white font-semibold py-2 px-6 rounded-lg">Xóa</button>
                </div>
            </div>
            <div id="status-processing-wrapper" class="hidden"><i
                    class="fas fa-cog fa-spin fa-3x text-blue-500"></i>
                <p class="mt-4 text-gray-600">Đang xử lý...</p>
            </div>
            <div id="status-completed-wrapper" class="hidden">
                <h3 class="text-xl font-bold mb-4">Hoàn tất</h3>
                <div id="completion-icon" class="mb-4">
                    <i class="fas fa-check-circle text-5xl text-green-500"></i>
                </div>
                <p id="completion-message" class="text-gray-700"></p>

                <div class="flex justify-center mt-6">
                    <button id="status-completion-ok-btn"
                        class="btn bg-blue-600 text-white font-semibold py-2 px-8 rounded-lg">OK</button>
                </div>
            </div>
        </div>
    </div>
    <div id="import-error-modal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <div class="flex items-center mb-4"><i class="fas fa-times-circle text-red-500 text-3xl mr-3"></i>

                <h3 class="text-xl font-bold">Lỗi khi nhập File Excel</h3>
            </div>
            <p class="text-gray-600 mb-4">Hệ thống đã phát hiện lỗi trong file của bạn. Vui lòng sửa các lỗi sau và
                thử
                lại:</p>
            <div class="max-h-60 overflow-y-auto bg-gray-100 p-3 rounded-lg border">
                <ul id="import-error-list" class="list-disc list-inside text-sm space-y-1"></ul>
            </div>
            <div class="flex justify-end mt-6">

                <button type="button" id="close-import-error-modal-btn"
                    class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg">Đã hiểu</button>
            </div>
        </div>
    </div>
    <div id="import-confirm-modal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center">
            <i class="fas fa-file-import text-teal-500 text-4xl mb-4"></i>

            <h3 class="text-lg font-bold mb-2">Xác nhận Nhập Dữ liệu</h3>
            <p class="text-gray-600 mb-4">Bạn sắp nhập <strong id="import-count" class="text-blue-600">0</strong>
                sản
                phẩm.</p>
            <p class="text-red-600 bg-red-100 p-3 rounded-lg mb-6">
                <i class="fas fa-exclamation-triangle mr-2"></i><strong>Cảnh báo:</strong> Toàn bộ dữ liệu sản
                phẩm hiện
                tại sẽ bị <strong class="font-bold">XÓA SẠCH</strong> trước khi nhập mới.
            </p>
            <div class="flex justify-center gap-4">
                <button type="button" id="cancel-import-btn"
                    class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg">Hủy</button><button
                    type="button" id="confirm-import-btn"
                    class="btn bg-teal-600 text-white font-semibold py-2 px-6 rounded-lg">Xác nhận & Nhập</button>
            </div>
        </div>
    </div>
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity
        duration-300 z-50">
        <p id="toast-message"></p>
    </div>
    <div id="product-selection-modal"
        class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col" style="max-height: 80vh;">
            <div class="p-4 border-b">
                <h3 class="text-xl font-bold">Chọn Sản Phẩm</h3>

                <p id="product-selection-category" class="text-sm text-gray-500 mt-1"></p>
            </div>
            <div class="p-4"><input type="text" id="product-selection-search-input"
                    placeholder="Tìm theo tên hoặc mã sản phẩm..."
                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div id="product-selection-list" class="flex-grow overflow-y-auto px-4 divide-y"></div>
            <div class="p-4 border-t flex justify-end">

                <button type="button" id="close-product-selection-modal-btn"
                    class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg">Đóng</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- CẤU HÌNH SUPABASE ---
            const supabaseUrl = 'https://vvpiemhqhxucpkheecpl.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2cGllbWhxaHh1Y3BraGVlY3BsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MzYxMDQsImV4cCI6MjA2ODMxMjEwNH0.rgxK3RarCr__O_AWs75nikzX_elPhsKx7BGaluGHc-k';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
                realtime: { params: { eventsPerSecond: 10 } },
            });
            // --- SCRIPT CHÍNH ---
            document.addEventListener('DOMContentLoaded', () => {
                // --- QUẢN LÝ CÁC DOM ELEMENTS ---
                const productModal = document.getElementById('product-modal');
                const stockModal = document.getElementById('stock-modal');
                const statusModal = document.getElementById('status-modal');
                const validationModal = document.getElementById('validation-modal');

                const importConfirmModal = document.getElementById('import-confirm-modal');
                const historyDetailModal = document.getElementById('history-detail-modal');
                const importErrorModal = document.getElementById('import-error-modal');
                const productTableBody = document.getElementById('product-table-body');
                const loadingSpinner = document.getElementById('loading-spinner');
                const categoryListDatalist = document.getElementById('category-list-datalist');
                const categoryFilterSelect = document.getElementById('category-filter');
                const historyTableBody = document.getElementById('history-table-body');
                const loadingHistorySpinner = document.getElementById('loading-history-spinner');
                const productSelectionModal = document.getElementById('product-selection-modal');
                const productSelectionList = document.getElementById('product-selection-list');
                let productSelectionSearchInput = document.getElementById('product-selection-search-input');
                const lowStockCard = document.getElementById('low-stock-card');
                const outOfStockCard = document.getElementById('out-of-stock-card');
                // --- START: VẬN CHUYỂN DOM ELEMENTS ---
                const shippingPanel = document.getElementById('panel-shipping');
                const shippingTableBody = document.getElementById('shipping-table-body');
                const loadingShippingSpinner = document.getElementById('loading-shipping-spinner');
                const shippingPaginationControls = document.getElementById('shipping-pagination-controls');
                const shippingSearchInput = document.getElementById('shipping-search-input');
                const shippingSelectAllCheckbox = document.getElementById('shipping-select-all-checkbox'); // New DOM element for select all
                const selectedShippingCountSpan = document.getElementById('selected-shipping-count'); // New DOM element for count
                const selectedShippingCountDeleteSpan = document.getElementById('selected-shipping-count-delete'); // New DOM element for delete count
                const exportSelectedShippingBtn = document.getElementById('export-selected-shipping-btn'); // New DOM element for export button
                const deleteSelectedShippingBtn = document.getElementById('delete-selected-shipping-btn'); // New DOM element for delete button
                // --- END: VẬN CHUYỂN DOM ELEMENTS ---
                // --- BIẾN TRẠNG THÁI (STATE) ---
                // Thêm các dòng này vào cùng khu vực khai báo
                const notesPanel = document.getElementById('panel-notes');
                const notesContainer = document.getElementById('notes-container');
                const loadingNotesSpinner = document.getElementById('loading-notes-spinner');
                let notesSubscription;
                let allNotes = [];
                let userId;
                let currentUserName = 'Guest'; // <-- THÊM DÒNG NÀY
                let currentUserRole = 'user'; // Mặc định là user thường
                let productSubscription;
                let transactionSubscription;
                let allProducts = [];
                let displayedProducts = [];
                let allTransactions = [];
                let displayedTransactions = [];
                let currentTransactionType = null; // NEW: State for active transaction tab ('import', 'export', etc.)
                let allCategories = [];
                let productsToImport = [];
                let selectedTransactionIds = new Set();
                let currentHistoryDetailItems = [];
                let isDataReady = false;
                let productsByCategory = new Map();
                let allStockItems = [];
                let filteredStockItems = [];
                let stockCurrentPage = 1;
                const STOCK_ITEMS_PER_PAGE = 50;
                let stockEntryMode = 'manual';
                let dashboardFilterType = 'all';
                // --- START: VẬN CHUYỂN STATE ---
                let allShipments = [];
                let displayedShipments = [];
                let selectedShippingIds = new Set(); // New Set for selected shipping items
                let shippingCurrentPage = 1;
                let SHIPPING_ITEMS_PER_PAGE = 10;
                let shipmentSubscription;
                // --- END: VẬN CHUYỂN STATE ---
                // Các biến phân trang cho bảng sản phẩm và lịch sử
                let productsCurrentPage = 1;
                let PRODUCTS_PER_PAGE = 10;
                let historyCurrentPage = 1;
                let HISTORY_ITEMS_PER_PAGE = 10;
                // CÁC BIẾN NÀY ĐƯỢC GIỮ LẠI VÌ BẠN MUỐN is_active
                let isProductBulkEditMode = false;
                let selectedProductIds = new Set();
                const dataDependentButtons = [
                    document.getElementById('open-stock-manual-btn'),
                    document.getElementById('open-stock-import-btn'),
                    document.getElementById('import-excel-btn'),
                    document.getElementById('export-excel-btn')
                ];
                dataDependentButtons.forEach(btn => { if (btn) btn.disabled = true });

                // --- HÀM HỖ TRỢ ---
                // --- START: CÁC HÀM RESET TAB ---
                const updateTransactionTabUI = () => {
                    const addToShippingBtn = document.getElementById('add-to-shipping-btn');
                    const panelTitle = document.getElementById('transaction-panel-title');

                    const isAdmin = currentUserRole === 'admin';

                    // Chỉ hiển thị nút "Đưa vào Vận chuyển" cho admin ở tab "Xuất kho"
                    if (addToShippingBtn) {
                        const showShippingButton = (currentTransactionType === 'export' && isAdmin);
                        addToShippingBtn.classList.toggle('hidden', !showShippingButton);
                    }

                    // Cập nhật tiêu đề cho panel
                    if (panelTitle) {
                        const titleMap = {
                            'import': { text: 'Lịch sử Nhập kho', icon: 'fa-arrow-down' },
                            'export': { text: 'Lịch sử Xuất kho', icon: 'fa-arrow-up' },
                            'return': { text: 'Lịch sử Trả hàng', icon: 'fa-undo' },
                            'order': { text: 'Lịch sử Đặt hàng', icon: 'fa-shopping-cart' },
                            'forecast': { text: 'Lịch sử Dự kiến', icon: 'fa-lightbulb' }
                        };
                        const info = titleMap[currentTransactionType];
                        if (info) {
                            panelTitle.innerHTML = `<i class="fas ${info.icon} mr-3"></i>${info.text}`;
                        } else {
                            panelTitle.innerHTML = '';
                        }
                    }
                };
                // --- START: CÁC HÀM QUẢN LÝ GHI CHÚ ---
                // DÁN HÀM MỚI NÀY VÀO KHU VỰC "HÀM HỖ TRỢ"
                // THAY THẾ TOÀN BỘ HÀM CŨ BẰNG HÀM MỚI NÀY
                const updateValidationMessage = () => {
                    const typeElement = document.querySelector('input[name="stock-type"]:checked');
                    const transactionType = typeElement ? typeElement.value : 'import';
                    const validItemsCount = parseInt(document.getElementById('validation-valid-count').textContent) || 0;
                    const validationMessage = document.getElementById('validation-message');

                    if (!validationMessage) return;

                    const typeTextMap = {
                        'import': 'Nhập kho',
                        'export': 'Xuất kho',
                        'return': 'Trả hàng',
                        'order': 'Đặt hàng',
                        'forecast': 'Dự kiến xuất'
                    };
                    const actionText = typeTextMap[transactionType] || 'Giao dịch';

                    if (validItemsCount === 0) {
                        validationMessage.innerHTML = `<i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i>Không có dòng hợp lệ để
    thực hiện. Vui lòng kiểm tra lại.`;
                    } else {
                        validationMessage.innerHTML = `<i class="fas fa-question-circle text-blue-500 mr-2"></i>Bạn có muốn thực hiện
    ${actionText} với <strong>${validItemsCount}</strong> dòng hợp lệ?`;
                    }

                    // Dòng này sẽ ẩn nút "Thực hiện Giao dịch" nếu không có dòng nào hợp lệ
                    document.getElementById('validation-confirm-btn')?.classList.toggle('hidden', validItemsCount === 0);
                };
                const renderNotes = () => {
                    if (!notesContainer) return;
                    loadingNotesSpinner.style.display = 'none';
                    notesContainer.innerHTML = ''; // Xóa ghi chú cũ

                    if (allNotes.length === 0) {
                        notesContainer.innerHTML = `<div class="text-center text-gray-300 col-span-full">Chưa có ghi chú nào. Nhấn "Thêm Ghi Chú
                    Mới" để bắt đầu.</div>`;
                        return;
                    }

                    allNotes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                    allNotes.forEach(note => {
                        const noteEl = document.createElement('div');
                        noteEl.className = 'note-card';
                        noteEl.dataset.noteId = note.id;

                        noteEl.innerHTML = `
                <div class="note-content">${note.content || ''}</div>
                <div class="note-footer">
                    <span>${formatDate(note.created_at, true)}</span>
                    <div class="note-actions">
                        <button class="edit-note-btn" title="Sửa"><i class="fas fa-edit"></i></button>
                        <button class="delete-note-btn" title="Xóa"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                `;
                        notesContainer.appendChild(noteEl);
                    });
                }

                const fetchNotes = async () => {
                    if (loadingNotesSpinner) loadingNotesSpinner.style.display = 'block';
                    const { data, error } = await supabase.from('notes').select('*');
                    if (error) {
                        showToast("Lỗi khi tải ghi chú.", true);
                        console.error("Fetch notes error:", error);
                        if (loadingNotesSpinner) loadingNotesSpinner.style.display = 'none';
                        return;
                    }
                    allNotes = data || [];
                    renderNotes();
                }
                // CODE MỚI ĐÃ SỬA LỖI
// CODE MỚI ĐÃ SỬA LỖI
const handleSaveNote = async (noteId, newContent) => {
if (!newContent.trim()) {
showToast("Nội dung ghi chú không được để trống.", true);
renderNotes(); // Render lại để hủy trạng thái sửa
return;
}

let error;
let updatedRecord;
if (noteId) { // Chế độ sửa
const { data, error: updateError } = await supabase.from('notes').update({ content: newContent }).eq('id',noteId).select().single();error = updateError;updatedRecord = data;
} else { // Chế độ thêm mới
const { data, error: insertError } = await supabase.from('notes').insert({ content: newContent, author_name:
currentUserName }).select().single();
error = insertError;
updatedRecord = data;
}

if (error) {
showToast("Lưu ghi chú thất bại.", true);
console.error("Save note error:", error);
} else {
showToast(noteId ? "Đã cập nhật ghi chú!" : "Đã thêm ghi chú mới!");
// THAY THẾ logic cập nhật mảng allNotes và render trực tiếp bằng cách gọi fetchNotes()
await fetchNotes(); // Dòng này sẽ đảm bảo dữ liệu được tải lại và render lại bảng
}
};

                // --- END: CÁC HÀM QUẢN LÝ GHI CHÚ ---
                const resetProductsTab = () => {
                    // Tắt chế độ sửa hàng loạt (hàm này đã tự xóa các ID được chọn)
                    if (isProductBulkEditMode) {
                        toggleProductBulkEditMode(false);
                    }
                    // Xóa bộ lọc và ô tìm kiếm
                    const searchInput = document.getElementById('search-input');
                    const categoryFilter = document.getElementById('category-filter');
                    const statusFilter = document.getElementById('product-status-filter');
                    if (searchInput) searchInput.value = '';
                    if (categoryFilter) categoryFilter.value = '';
                    if (statusFilter) statusFilter.value = 'active';

                    // Tải lại dữ liệu bảng sản phẩm với bộ lọc mặc định
                    applyFiltersAndRender();
                };

                const resetHistoryTab = () => {
                    // Xóa tất cả ID giao dịch đã chọn
                    selectedTransactionIds.clear();

                    // Bỏ check ở ô "chọn tất cả"
                    const selectAllCheckbox = document.getElementById('history-select-all-checkbox');
                    if (selectAllCheckbox) selectAllCheckbox.checked = false;

                    // Cập nhật lại giao diện các nút hành động
                    updateSelectedHistoryCount();

                    // Xóa bộ lọc và ô tìm kiếm
                    const historySearchInput = document.getElementById('history-search-input');
                    const historyTypeFilter = document.getElementById('history-type-filter');
                    if (historySearchInput) historySearchInput.value = '';
                    if (historyTypeFilter) historyTypeFilter.value = 'all';

                    // Tải lại dữ liệu bảng lịch sử với bộ lọc mặc định
                    applyHistoryFilterAndRender();
                };

                const resetShippingTab = () => {
                    // Xóa ô tìm kiếm
                    const shippingSearchInput = document.getElementById('shipping-search-input');
                    if (shippingSearchInput) shippingSearchInput.value = '';

                    // Clear selected shipping IDs
                    selectedShippingIds.clear();
                    const selectAllCheckbox = document.getElementById('shipping-select-all-checkbox');
                    if (selectAllCheckbox) selectAllCheckbox.checked = false;
                    updateSelectedShippingCount(); // Update UI after clearing selection

                    // Tải lại dữ liệu bảng vận chuyển
                    applyShippingFilterAndRender();
                };
                // --- END: CÁC HÀM RESET TAB ---
                const productBulkActionsBar = document.getElementById('product-bulk-actions-bar');
                const toggleBulkEditProductsBtn = document.getElementById('toggle-bulk-edit-products-btn');
                const cancelBulkEditProductsBtn = document.getElementById('cancel-bulk-edit-products-btn');
                const productSelectAllCheckbox = document.getElementById('product-select-all-checkbox');
                const selectedProductsCountSpan = document.getElementById('selected-products-count');
                const bulkDeactivateProductsBtn = document.getElementById('bulk-deactivate-products-btn');
                const bulkActivateProductsBtn = document.getElementById('bulk-activate-products-btn');
                const bulkDeleteProductsBtn = document.getElementById('bulk-delete-products-btn');
                const bulkOrderProductsBtn = document.getElementById('bulk-order-products-btn');

                const updateProductStatusBulk = async (isActive) => {
                    if (selectedProductIds.size === 0) {
                        showToast("Vui lòng chọn sản phẩm để cập nhật.", true);
                        return;
                    }
                    const idsArray = Array.from(selectedProductIds).map(id => parseInt(id));
                    await handleAsyncAction(async () => {
                        const { error } = await supabase.from('products')
                            .update({ is_active: isActive })
                            .in('id', idsArray);
                        if (error) throw error;
                    }, {
                        confirmTitle: `Xác nhận ${isActive ? 'Kích hoạt lại' : 'Ngưng bán'} Sản phẩm`,
                        confirmMessage: `Bạn có chắc muốn ${isActive ? 'kích hoạt lại' : 'Ngưng bán'} ${selectedProductIds.size} sản phẩm đã chọn?`,
                        successMessage: `${isActive ? 'Kích hoạt lại' : 'Ngưng bán'} ${selectedProductIds.size} sản phẩm thành công!`,
                        errorMessage: `Lỗi khi ${isActive ? 'Kích hoạt lại' : 'Ngưng bán'} sản phẩm.`
                    });
                    toggleProductBulkEditMode(false);
                };
                const toggleProductBulkEditMode = (enable) => {
                    isProductBulkEditMode = enable;
                    selectedProductIds.clear();

                    const productSelectCols = document.querySelectorAll('.product-select-col');
                    productSelectCols.forEach(col => col.classList.toggle('hidden', !enable));

                    const importExcelBtn = document.getElementById('import-excel-btn');
                    const openStockManualBtn = document.getElementById('open-stock-manual-btn');
                    const openStockImportBtn = document.getElementById('open-stock-import-btn');
                    const openProductModalBtn = document.getElementById('open-product-modal-btn');
                    const toggleBulkEditProductsBtn = document.getElementById('toggle-bulk-edit-products-btn');

                    if (enable) {
                        if (productBulkActionsBar) productBulkActionsBar.classList.remove('hidden');
                        if (productBulkActionsBar) productBulkActionsBar.classList.add('flex');

                        if (importExcelBtn) importExcelBtn.classList.add('hidden');
                        if (openStockManualBtn) openStockManualBtn.classList.add('hidden');
                        if (openStockImportBtn) openStockImportBtn.classList.add('hidden');
                        if (openProductModalBtn) openProductModalBtn.classList.add('hidden');
                        if (toggleBulkEditProductsBtn) toggleBulkEditProductsBtn.classList.add('hidden');
                    } else {
                        if (productBulkActionsBar) productBulkActionsBar.classList.add('hidden');
                        if (productBulkActionsBar) productBulkActionsBar.classList.remove('flex');

                        if (importExcelBtn) importExcelBtn.classList.remove('hidden');
                        if (openStockManualBtn) openStockManualBtn.classList.remove('hidden');
                        if (openStockImportBtn) openStockImportBtn.classList.remove('hidden');
                        if (openProductModalBtn) openProductModalBtn.classList.remove('hidden');
                        if (toggleBulkEditProductsBtn) toggleBulkEditProductsBtn.classList.remove('hidden');
                    }

                    displayCurrentProductsPage();
                    updateProductBulkActionsUI();
                };
                const updateProductBulkActionsUI = () => {
                    const count = selectedProductIds.size;
                    if (selectedProductsCountSpan) selectedProductsCountSpan.textContent = count;

                    const disableButtons = count === 0;
                    if (bulkDeactivateProductsBtn) bulkDeactivateProductsBtn.disabled = disableButtons;
                    if (bulkActivateProductsBtn) bulkActivateProductsBtn.disabled = disableButtons;
                    if (bulkDeleteProductsBtn) bulkDeleteProductsBtn.disabled = disableButtons;
                    if (bulkOrderProductsBtn) bulkOrderProductsBtn.disabled = disableButtons;
                    if (productSelectAllCheckbox) {
                        const totalProductsOnPage = document.querySelectorAll('.product-checkbox').length;
                        productSelectAllCheckbox.indeterminate = count > 0 && count < totalProductsOnPage;
                    }
                };
                const deleteProductsBulk = async () => {
                    if (selectedProductIds.size === 0) {
                        showToast("Vui lòng chọn sản phẩm để xóa.", true);
                        return;
                    }
                    const idsArray = Array.from(selectedProductIds).map(id => parseInt(id));
                    await handleAsyncAction(async () => {
                        const { error } = await supabase.from('products')
                            .delete()
                            .in('id', idsArray);
                        if (error) throw error;
                    }, {
                        confirmTitle: `Xác nhận Xóa ${selectedProductIds.size} Sản phẩm`,
                        confirmMessage: `Bạn có chắc muốn xóa ${selectedProductIds.size} sản phẩm đã chọn? Hành động này không thể hoàn tác.`,
                        successMessage: `Đã xóa ${selectedProductIds.size} sản phẩm thành công!`,
                        errorMessage: `Lỗi khi xóa sản phẩm.`
                    });
                    toggleProductBulkEditMode(false);
                };
                const createOrderForSelectedProducts = () => {
                    if (selectedProductIds.size === 0) {
                        showToast("Vui lòng chọn sản phẩm để đặt hàng.", true);
                        return;
                    }

                    const productsToOrder = allProducts.filter(p => selectedProductIds.has(String(p.id)));

                    allStockItems = productsToOrder.map(product => ({
                        id: Date.now() + Math.random(),
                        customer: '',
                        category: product.category,
                        productId: product.id,
                        name: product.name,
                        code: product.code,
                        quantity: null,
                        note: 'Đặt hàng bổ sung',
                        isValid: true,
                        created_at: new Date().toISOString()
                    }));

                    stockEntryMode = 'order';
                    openStockModal();
                    toggleProductBulkEditMode(false);
                };
                // --- START: CÁC HÀM LIÊN QUAN ĐẾN VẬN CHUYỂN ---
const confirmAndCloseStockModal = () => {
    // Kiểm tra xem người dùng đã nhập dữ liệu vào bất kỳ dòng nào chưa
    const hasData = allStockItems.length > 0 && allStockItems.some(item => item.category || item.name || item.quantity > 0);

    if (hasData) {
        // Nếu có dữ liệu, gọi hộp thoại xác nhận
        handleAsyncAction(async () => {
            // Hành động sẽ thực hiện nếu người dùng bấm "Xác nhận"
            closeModal(stockModal);
        }, {
            confirmTitle: 'Xác nhận Hủy',
            confirmMessage: 'Dữ liệu đã nhập sẽ bị mất. Bạn có chắc chắn muốn đóng cửa sổ này không?',
            successMessage: 'Đã hủy.', // Sẽ không hiển thị vì modal đóng ngay
            errorMessage: 'Lỗi.'
        }).catch(err => {
            // Bắt lỗi khi người dùng bấm "Hủy" trên hộp thoại xác nhận, không làm gì cả
            console.log("Hủy hành động đóng modal.");
        });
    } else {
        // Nếu chưa có dữ liệu, đóng luôn không cần hỏi
        closeModal(stockModal);
    }
};
                // Hàm fetch dữ liệu từ bảng shipments và join với transactions
                const fetchShippingData = async () => {
                    if (loadingShippingSpinner) loadingShippingSpinner.style.display = 'block';
                    const { data, error } = await supabase
                        .from('shipments')
                        .select(`
                            id,
                            carrier,
                            tracking_code,
                            status,
                            shipping_notes,
                            transaction:transactions (
                                id,
                                created_at,
                                customer,
                                items
                            )
                        `)
                        .order('created_at', { referencedTable: 'transactions', ascending: false });

                    if (loadingShippingSpinner) loadingShippingSpinner.style.display = 'none';
                    if (error) {
                        console.error("Lỗi khi tải dữ liệu vận chuyển:", error);
                        showToast("Không thể tải dữ liệu vận chuyển.", true);
                        return;
                    }
                    allShipments = data || [];
                    allShipments.forEach(s => {
                        // Đảm bảo cờ isEditing được đặt lại về false mỗi khi dữ liệu được fetch/re-render
                        s.isEditing = false;
                    });
                    applyShippingFilterAndRender();
                };
                const shippingStatusMap = {
                    'pending': 'Đang chờ xử lý',
                    'in_transit': 'Đang vận chuyển',
                    'delivered': 'Đã giao thành công',
                    'failed': 'Giao hàng thất bại',
                    'cancelled': 'Đã hủy'
                };
                // Hàm render bảng dữ liệu vận chuyển
                const renderShippingTable = (shipmentsToRender) => {
                    if (!shippingTableBody) return;
                    shippingTableBody.innerHTML = '';

                    if (shipmentsToRender.length === 0) {
                        shippingTableBody.innerHTML = `<tr>
                            <td colspan="8" class="text-center p-8 text-gray-500">Không có đơn hàng nào trong mục vận chuyển.</td>
                        </tr>`;
                        return;
                    }

                    const statusOptions = ['pending', 'in_transit', 'delivered', 'failed', 'cancelled']
                        .map(s => `<option value="${s}">${shippingStatusMap[s] || s.replace('_', ' ')}</option>`).join('');

                    // Các tùy chọn cho đơn vị vận chuyển
                    const carrierOptions = ['ViettelPost']
                        .map(c => `<option value="${c}">${c}</option>`).join('');


                    const rowsHtml = shipmentsToRender.map(shipment => {
                        const transaction = shipment.transaction;
                        if (!transaction) return '';

                        // Khắc phục lỗi hiển thị trùng lặp mã vận đơn
                        const displayTrackingCode = shipment.tracking_code || 'Chưa có';
                        const trackingCodeDisplayHtml = shipment.tracking_code
                            ? `<span class="tracking-code-display cursor-pointer text-blue-600 hover:underline" data-tracking-code="${shipment.tracking_code}" title="Click để sao chép và tra cứu">${displayTrackingCode}</span>`
                            : `<span>${displayTrackingCode}</span>`;


                        return `
                            <tr data-shipment-id="${shipment.id}" class="hover:bg-gray-50">
                                <td class="p-3 text-center"><input type="checkbox" class="shipping-checkbox" data-id="${shipment.id}" ${selectedShippingIds.has(String(shipment.id)) ? 'checked' : ''}></td>
                                <td class="p-3">${formatDate(transaction.created_at, false)}</td>
                                <td class="p-3 name-col">${transaction.customer}</td>
                                <td class="p-3">
                                    <span class="view-mode ${shipment.isEditing ? 'hidden' : ''}">${shipment.carrier || 'Viettelpost'}</span>
                                    <select class="w-full p-2 border border-gray-300 rounded-lg bg-white shipment-carrier-input ${shipment.isEditing ? '' : 'hidden'}">
                                        ${carrierOptions.replace(`value="${shipment.carrier}"`, `value="${shipment.carrier}" selected`)}
                                    </select>
                                </td>
                                <td class="p-3">
                                    <span class="view-mode ${shipment.isEditing ? 'hidden' : ''}">${trackingCodeDisplayHtml}</span>
                                    <input type="text" value="${shipment.tracking_code || ''}" class="w-full p-2 border border-gray-300 rounded-lg bg-white shipment-tracking-input ${shipment.isEditing ? '' : 'hidden'}" placeholder="Nhập mã vận đơn...">
                                </td>
                                <td class="p-3">
                                    <span class="view-mode ${shipment.isEditing ? 'hidden' : ''}" title="${shipment.shipping_notes || 'Chưa có'}">${shipment.shipping_notes || 'Chưa có'}</span>
                                    <input type="text" value="${shipment.shipping_notes || ''}" class="w-full p-2 border border-gray-300 rounded-lg bg-white shipment-notes-input ${shipment.isEditing ? '' : 'hidden'}" placeholder="Ghi chú vận chuyển...">
                                </td>
                                <td class="p-3">
                                    <span class="view-mode ${shipment.isEditing ? 'hidden' : ''}">${shippingStatusMap[shipment.status || 'pending'] || (shipment.status || 'pending').replace('_', ' ')}</span>
                                    <select class="w-full p-2 border border-gray-300 rounded-lg bg-white shipment-status-select ${shipment.isEditing ? '' : 'hidden'}">
                                        ${statusOptions.replace(`value="${shipment.status}"`, `value="${shipment.status}" selected`)}
                                    </select>
                                </td>
                                <td class="p-3 text-center">
                                    <div class="flex justify-center items-center gap-1">
                                        <!-- Nút XEM: Icon mắt -->
                                        <button data-transaction-id="${transaction.id}" class="view-transaction-detail-btn btn p-2 text-blue-600 hover:bg-blue-100 rounded-full" title="Xem chi tiết đơn hàng">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <!-- Nút SỬA: Icon bút chì (Chỉ hiển thị khi KHÔNG ở chế độ chỉnh sửa) -->
                                        <button class="btn edit-shipment-btn p-2 text-yellow-500 hover:bg-yellow-100 rounded-full ${shipment.isEditing ? 'hidden' : ''}" title="Chỉnh sửa đơn">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <!-- Nút LƯU: Icon đĩa mềm (Chỉ hiển thị khi ở chế độ chỉnh sửa) -->
                                        <button class="btn save-shipment-btn bg-blue-500 text-white p-2 rounded-lg ${shipment.isEditing ? '' : 'hidden'}" title="Lưu thay đổi">
                                            <i class="fas fa-save"></i>
                                        </button>
                                        <!-- Nút HỦY: (MỚI) (Chỉ hiển thị khi ở chế độ chỉnh sửa) -->
                                        <button class="btn cancel-shipment-edit-btn bg-gray-300 text-gray-800 p-2 rounded-lg ${shipment.isEditing ? '' : 'hidden'}" title="Hủy chỉnh sửa">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <!-- Nút XÓA: Icon thùng rác -->
                                        <button data-shipment-id="${shipment.id}" class="delete-shipment-btn btn p-2 text-red-600 hover:bg-red-100 rounded-full ml-1" title="Xóa đơn vận chuyển">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    shippingTableBody.innerHTML = rowsHtml;
                    updateSelectedShippingCount(); // Cập nhật trạng thái checkbox "Chọn tất cả" sau khi render
                };

                const applyShippingFilterAndRender = () => {
                    const searchTerm = shippingSearchInput?.value.toLowerCase().trim();
                    if (!searchTerm) {
                        displayedShipments = allShipments;
                    } else {
                        displayedShipments = allShipments.filter(s =>
                            s.transaction?.customer?.toLowerCase().includes(searchTerm) ||
                            s.tracking_code?.toLowerCase().includes(searchTerm)
                        );
                    }
                    shippingCurrentPage = 1;
                    displayCurrentShippingPage();
                };

                const displayCurrentShippingPage = () => {
                    const startIndex = (shippingCurrentPage - 1) * SHIPPING_ITEMS_PER_PAGE;
                    const endIndex = startIndex + SHIPPING_ITEMS_PER_PAGE;
                    const pageItems = displayedShipments.slice(startIndex, endIndex);
                    renderShippingTable(pageItems);
                    renderShippingPagination(); // Gọi hàm render phân trang
                };

                const renderShippingPagination = () => {
                    const totalItems = displayedShipments.length;
                    const totalPages = Math.ceil(totalItems / SHIPPING_ITEMS_PER_PAGE);
                    if (shippingPaginationControls) shippingPaginationControls.innerHTML = '';


                    const startIndex = (shippingCurrentPage - 1) * SHIPPING_ITEMS_PER_PAGE;
                    const endIndex = Math.min(startIndex + SHIPPING_ITEMS_PER_PAGE, totalItems);

                    let paginationHtml = `
                        <div class="flex-grow text-gray-600 text-sm">
                            Hiển thị ${startIndex + 1} tới ${endIndex} của ${totalItems} dữ liệu
                        </div>
                        <div class="flex items-center gap-1">
                            <button id="shipping-prev-btn" class="btn px-3 py-1 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 ${shippingCurrentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${shippingCurrentPage === 1 ?
                            'disabled' : ''}>
                                Trước
                            </button>
                    `;
                    const maxPagesToShow = 5;
                    let startPage = Math.max(1, shippingCurrentPage - Math.floor(maxPagesToShow / 2));
                    let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

                    if (endPage - startPage + 1 < maxPagesToShow) {
                        startPage = Math.max(1, endPage - maxPagesToShow + 1);
                    }

                    if (startPage > 1) {
                        paginationHtml += `<button class="btn px-3 py-1 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-100" data-page="1">1</button>`;
                        if (startPage > 2) {
                            paginationHtml += `<span class="px-2">...</span>`;
                        }
                    }

                    for (let i = startPage; i <= endPage; i++) {
                        paginationHtml += `
                            <button class="btn px-3 py-1 mx-1 rounded-lg border border-gray-300 ${i === shippingCurrentPage ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}" data-page="${i}">
                                ${i}
                            </button>
                        `;
                    }

                    if (endPage < totalPages) {
                        if (endPage < totalPages - 1) {
                            paginationHtml += `<span class="px-2">...</span>`;
                        }
                        paginationHtml += `<button class="btn px-3 py-1 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-100" data-page="${totalPages}">${totalPages}</button>`;
                    }

                    paginationHtml += `
                            <button id="shipping-next-btn" class="btn px-3 py-1 ml-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 ${shippingCurrentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${shippingCurrentPage === totalPages ?
                            'disabled' : ''}>
                                Sau
                            </button>
                        </div>
                    `;
                    shippingPaginationControls.innerHTML = paginationHtml;

                    shippingPaginationControls.querySelectorAll('button[data-page]').forEach(button => {
                        button.addEventListener('click', () => {
                            shippingCurrentPage = parseInt(button.dataset.page);
                            displayCurrentShippingPage();
                        });
                    });
                    document.getElementById('shipping-prev-btn')?.addEventListener('click', () => {
                        if (shippingCurrentPage > 1) {
                            shippingCurrentPage--;
                            displayCurrentShippingPage();
                        }
                    });
                    document.getElementById('shipping-next-btn')?.addEventListener('click', () => {
                        if (shippingCurrentPage < totalPages) {
                            shippingCurrentPage++;
                            displayCurrentShippingPage();
                        }
                    });
                };
                // --- END: CÁC HÀM LIÊN QUAN ĐẾN VẬN CHUYỂN ---
                const formatCurrency = (value) => new Intl.NumberFormat('vi-VN', { style: 'decimal' }).format(value || 0);
                const formatDate = (dateString, includeTime = true) => {
                    if (!dateString) return 'N/A';
                    let date;
                    const excelDateNum = parseFloat(dateString);

                    if (!isNaN(excelDateNum) && excelDateNum > 0 && typeof dateString === 'number') {
                        date = new Date(Math.round((excelDateNum - 25569) * 86400 * 1000));
                    } else {
                        const dateStr = String(dateString).trim();
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                        } else {
                            date = new Date(dateStr);
                        }
                    }

                    if (isNaN(date.getTime())) {
                        return 'N/A';
                    }

                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    if (includeTime) {
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        return `${hours}:${minutes} ${day}/${month}/${year}`;
                    } else {
                        return `${day}/${month}/${year}`;
                    }
                };
                const showToast = (message, isError = false) => {
                    const toast = document.getElementById('toast');
                    toast.textContent = message;
                    toast.className = `fixed top-5 right-5 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50 ${isError ?
                        'bg-red-500' : 'bg-green-500'}`;
                    toast.classList.remove('opacity-0');
                    setTimeout(() => { toast.classList.add('opacity-0'); }, 4000);
                };
                const getTodayDate = () => new Date().toISOString().split('T')[0];
                const debounce = (func, delay) => {
                    let timeoutId;
                    return (...args) => {
                        clearTimeout(timeoutId);
                        timeoutId = setTimeout(() => { func.apply(this, args); }, delay);
                    };
                };
                const showGlobalError = (message) => {
                    const globalErrorBanner = document.getElementById('global-error-banner');
                    const globalErrorMessage = document.getElementById('global-error-message');
                    globalErrorMessage.textContent = message;
                    globalErrorBanner.classList.remove('hidden');
                };
                const groupProductsByCategory = () => {
                    productsByCategory.clear();
                    for (const product of allProducts) {
                        if (!productsByCategory.has(product.category)) {
                            productsByCategory.set(product.category, []);
                        }
                        productsByCategory.get(product.category).push(product);
                    }
                };
                const refreshUI = () => {
                    groupProductsByCategory();
                    updateCategoryLists();
                    applyFiltersAndRender();
                    updateDashboard();
                };
                const debouncedRefreshUI = debounce(refreshUI, 50);
                const openModal = (modal) => modal.classList.add('is-open');
                const closeModal = (modal) => modal.classList.remove('is-open');

                // --- QUẢN LÝ VAI TRÒ & GIAO DIỆN ---
                const updateUIForRole = () => {
                    const isAdmin = currentUserRole === 'admin';
                    console.log(`Current user role: ${currentUserRole}. Is Admin: ${isAdmin}`);

                    // Danh sách các ID của element chỉ dành cho Admin
                    const adminOnlyElements = [
                        'open-product-modal-btn', 'toggle-bulk-edit-products-btn',
                        'open-stock-manual-btn', 'open-stock-import-btn', 'import-excel-btn',
                        'product-bulk-actions-bar', 'delete-selected-history-btn'
                    ];

                    adminOnlyElements.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.style.display = isAdmin ? '' : 'none';
                        }
                    });

                    // Cập nhật lại bảng để ẩn/hiện cột Hành động
                    displayCurrentProductsPage();
                    displayCurrentHistoryPage();
                };

                // --- QUẢN LÝ SẢN PHẨM (CRUD) ---
                const productForm = document.getElementById('product-form');
                const openAddModal = () => {
                    productForm.reset();
                    document.getElementById('product-id').value = '';
                    document.getElementById('modal-title').textContent = 'Thêm Sản Phẩm Mới';
                    document.getElementById('product-quantity').disabled = false;
                    document.getElementById('product-ordered').disabled = false;
                    document.getElementById('product-forecast').disabled = false;
                    document.getElementById('product-is-active').checked = true;
                    openModal(productModal);
                };
                const openEditModal = (product) => {
                    productForm.reset();
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('modal-title').textContent = 'Cập Nhật Sản Phẩm';

                    document.getElementById('product-category').value = product.category;
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-code').value = product.code;
                    document.getElementById('product-price').value = product.price;
                    document.getElementById('product-quantity').value = product.quantity;
                    document.getElementById('product-ordered').value = product.ordered_quantity || 0;
                    document.getElementById('product-forecast').value = product.expected_ship_quantity || 0;
                    document.getElementById('product-notes').value = product.notes || '';
                    document.getElementById('product-is-active').checked = product.is_active ?? true;

            // --- BẮT ĐẦU ĐOẠN CODE MỚI THAY THẾ CHO VIỆC ĐIỀU KHIỂN TRƯỜNG DISABLED ---
            
            // Lấy tất cả các trường input, select, và textarea BÊN TRONG form #product-form
            const productFormElements = document.querySelectorAll('#product-form input, #product-form select, #product-form textarea');
            
            // Vô hiệu hóa TẤT CẢ các trường nhập liệu này theo mặc định khi mở modal sửa
            productFormElements.forEach(el => {
            // Đảm bảo không vô hiệu hóa hidden input 'product-id' (nếu có)
            // và cũng không vô hiệu hóa các nút (chỉ nhắm vào input/select/textarea)
            if (el.id !== 'product-id' && el.tagName !== 'BUTTON') {
            el.disabled = true;
            }
            });
            
            // Kích hoạt (enable) riêng trường Ghi chú (product-notes)
            const productNotesElement = document.getElementById('product-notes');
            if (productNotesElement) {
            productNotesElement.disabled = false; // BẬT Ghi chú cho MỌI người dùng (admin và user thường)
            }
            
            // Các trường số lượng tồn kho (product-quantity, product-ordered, product-forecast)
            // đã bị vô hiệu hóa bởi vòng lặp phía trên.
            // Dòng này không còn cần thiết nếu vòng lặp trên đã làm việc đó,
            // nhưng để chắc chắn và rõ ràng, ta có thể giữ lại hoặc bỏ tùy ý.
            // Nếu giữ lại, nó sẽ ghi đè lên và đảm bảo chúng bị khóa.
            document.getElementById('product-quantity').disabled = true;
            document.getElementById('product-ordered').disabled = true;
            document.getElementById('product-forecast').disabled = true;
            
            // --- KẾT THÚC ĐOẠN CODE MỚI THAY THẾ ---

                    openModal(productModal);
                };
        productForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const productId = document.getElementById('product-id').value;
    const productData = {
        name: document.getElementById('product-name').value.trim(),
        code: document.getElementById('product-code').value.trim(),
        category: document.getElementById('product-category').value.trim() || 'Chưa phân loại',
        price: Number(document.getElementById('product-price').value),
        notes: document.getElementById('product-notes').value.trim(),
        user_id: userId,
        is_active: document.getElementById('product-is-active').checked,
        searchable_name: `${document.getElementById('product-name').value.trim().toLowerCase()} ${document.getElementById('product-code').value.trim().toLowerCase()}`,
    };
    try {
        if (productId) {
            // Lấy sản phẩm hiện tại để giữ original_order
            const existingProduct = allProducts.find(p => String(p.id) === productId);
            let updateData = { ...productData };
            if (existingProduct && existingProduct.original_order !== undefined) {
                updateData.original_order = existingProduct.original_order;
            }
            // Các trường này KHÔNG ĐƯỢC PHÉP cập nhật thủ công, nên loại bỏ
            delete updateData.quantity;
            delete updateData.ordered_quantity;
            delete updateData.expected_ship_quantity;
            const { error } = await supabase.from('products').update(updateData).eq('id', productId);
            if (error) throw error;
            showToast('Cập nhật sản phẩm thành công!');
        } else {
            productData.quantity = Number(document.getElementById('product-quantity').value) || 0;
            productData.ordered_quantity = Number(document.getElementById('product-ordered').value) || 0;
            productData.expected_ship_quantity = Number(document.getElementById('product-forecast').value) || 0;
            // Gán original_order khi thêm mới thủ công để tránh bị nhảy vị trí
            productData.original_order = allProducts.length > 0 ? Math.max(...allProducts.map(p => p.original_order || 0)) + 1 : 0;
            const { error } = await supabase.from('products').insert([productData]);
            if (error) throw error;
            showToast('Thêm sản phẩm thành công!');
        }
        closeModal(productModal);
    } catch (error) {
        console.error("Error saving product: ", error);
        showToast(`Đã xảy ra lỗi khi lưu sản phẩm: ${error.message}`, true);
    }
});
                // --- QUẢN LÝ NHẬP/XUẤT KHO ---
                const stockForm = document.getElementById('stock-form');
                const stockItemsContainer = document.getElementById('stock-items-container');
                const stockPaginationControls = document.getElementById('stock-pagination-controls');
                const updateStockFormSummary = () => {
                    let totalQuantity = 0;
                    const uniqueProductIds = new Set();
                    const uniqueCustomers = new Set();
                    allStockItems.forEach(item => {
                        if (item.isValid && item.quantity > 0) {
                            totalQuantity += (item.quantity || 0);
                            if (item.productId) uniqueProductIds.add(item.productId);
                            if (stockEntryMode === 'import' && item.customer) { uniqueCustomers.add(item.customer.trim()); }
                        }
                    });
                    const summaryCustomerLine = document.getElementById('summary-customer-line');
                    if (summaryCustomerLine) {
                        if (stockEntryMode === 'manual' || stockEntryMode === 'order') {
                            summaryCustomerLine.classList.add('hidden');
                        } else {
                            summaryCustomerLine.classList.remove('hidden');
                            const summaryTotalCustomers = document.getElementById('summary-total-customers');
                            if (summaryTotalCustomers) summaryTotalCustomers.textContent = uniqueCustomers.size ||
                                (allStockItems.some(i => i.isValid && i.quantity > 0) ? 1 : 0);
                        }
                    }
                    const summaryUniqueItems = document.getElementById('summary-unique-items');
                    if (summaryUniqueItems) summaryUniqueItems.textContent = uniqueProductIds.size;
                    const summaryTotalRows = document.getElementById('summary-total-rows');
                    if (summaryTotalRows) summaryTotalRows.textContent = allStockItems.length;
                    const summaryTotalQuantity = document.getElementById('summary-total-quantity');
                    if (summaryTotalQuantity) summaryTotalQuantity.textContent = totalQuantity;
                };
                const displayCurrentStockPage = () => {
                    if (stockItemsContainer) stockItemsContainer.innerHTML = '';
                    const pageItems = filteredStockItems.slice((stockCurrentPage - 1) * STOCK_ITEMS_PER_PAGE, stockCurrentPage * STOCK_ITEMS_PER_PAGE);
                    pageItems.forEach(item => { if (stockItemsContainer) stockItemsContainer.appendChild(createStockItemRowDOM(item)); });
                    renderStockPagination();
                    updateStockFormSummary();
                };
                const renderStockPagination = () => {
                    const totalPages = Math.ceil(filteredStockItems.length / STOCK_ITEMS_PER_PAGE);
                    if (stockPaginationControls) stockPaginationControls.innerHTML = '';
                    if (totalPages <= 1) return;
                    if (stockPaginationControls) {
                        stockPaginationControls.innerHTML = `
                            <button id="stock-prev-btn" class="btn p-2 ${stockCurrentPage === 1 ? 'text-gray-300' : 'text-gray-700'}" ${stockCurrentPage === 1 ?
                            'disabled' : ''}><i class="fas fa-chevron-left"></i></button>
                            <span class="font-medium text-sm">Trang ${stockCurrentPage} / ${totalPages}</span>
                            <button id="stock-next-btn" class="btn p-2 ${stockCurrentPage === totalPages ? 'text-gray-300' : 'text-gray-700'}" ${stockCurrentPage === totalPages ?
                            'disabled' : ''}><i class="fas fa-chevron-right"></i></button>
                        `;
                        document.getElementById('stock-prev-btn')?.addEventListener('click', () => { if (stockCurrentPage > 1) { stockCurrentPage--; displayCurrentStockPage(); } });
                        document.getElementById('stock-next-btn')?.addEventListener('click', () => { if (stockCurrentPage < totalPages) { stockCurrentPage++; displayCurrentStockPage(); } });
                    }
                };
                const createStockItemRowDOM = (item) => {
                    const row = document.createElement('tr');
                    row.className = 'stock-item-row';
                    row.dataset.itemId = item.id;
                    if (!item.isValid) {
                        row.classList.add('invalid-row');
                        row.title = "Dòng này có lỗi và sẽ không được xử lý.";
                    }

                    const dateCell = row.insertCell();
                    const dateTextSpan = document.createElement('span');
                    dateTextSpan.textContent = formatDate(item.created_at, false);
                    dateCell.appendChild(dateTextSpan);
                    // Ẩn/hiện cột Ngày của từng dòng: chỉ hiển thị khi ở chế độ import
            dateCell.style.display = (stockEntryMode === 'import') ? '' : 'none';

                    const customerCell = row.insertCell();
                    const customerInput = document.createElement('input');
                    customerInput.type = 'text';
                    customerInput.value = item.customer || '';
                    customerInput.className = 'stock-customer-input w-full p-2 border border-gray-300 rounded-lg';
                    customerInput.placeholder = 'Tên khách hàng...';
                    customerCell.appendChild(customerInput);
                    // Ẩn/hiện cột Khách hàng của từng dòng: chỉ hiện khi ở chế độ import
            customerCell.style.display = (stockEntryMode === 'import') ? '' : 'none';
                    const categoryCell = row.insertCell();
                    const categorySelect = document.createElement('select');
                    categorySelect.className = 'stock-category-select w-full p-2 border border-gray-300 rounded-lg bg-white';
                    let categoryOptions = '<option value="">-- Chọn Nhóm --</option>';
                    categoryOptions += allCategories.map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`).join('');
                    categorySelect.innerHTML = categoryOptions;
                    categoryCell.appendChild(categorySelect);

                    const productCell = row.insertCell();
                    const productSearchInput = document.createElement('input');
                    productSearchInput.type = 'text';
                    productSearchInput.className = 'stock-product-search w-full p-2 border border-gray-300 rounded-lg cursor-pointer bg-white';
                    productSearchInput.readOnly = true;
                    if (item.name) {
                        productSearchInput.value = item.name;
                    } else {
                        productSearchInput.placeholder = item.category ?
                            'Nhấn để chọn sản phẩm' : 'Chọn nhóm hàng trước';
                    }
                    productCell.appendChild(productSearchInput);

                    const codeCell = row.insertCell();
                    codeCell.className = 'p-2 text-sm text-gray-500';
                    if (item.code) {
                        codeCell.textContent = item.code;
                    }

                    const stockCell = row.insertCell();
                    stockCell.className = 'p-2 text-center font-medium';
                    if (item.productId) {
                        const product = allProducts.find(p => p.id === item.productId);
                        if (product) {
                            stockCell.textContent = product.quantity;
                        } else {
                            stockCell.textContent = 'N/A (SP không tìm thấy)';
                        }
                    } else {
                        stockCell.textContent = 'N/A';
                    }

                    const quantityCell = row.insertCell();
                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'number';
                    quantityInput.min = '0';
                    quantityInput.value = item.quantity ?? '';
                    quantityInput.className = 'stock-quantity-input w-24 p-2 border border-gray-300 rounded-lg text-center';
                    quantityInput.placeholder = 'SL';
                    quantityCell.appendChild(quantityInput);

                    const noteCell = row.insertCell();
                    const noteInput = document.createElement('input');
                    noteInput.type = 'text';
                    noteInput.value = item.note || '';
                    noteInput.className = 'stock-note-input w-full p-2 border border-gray-300 rounded-lg';
                    noteInput.placeholder = 'Ghi chú...';
                    noteCell.appendChild(noteInput);

                    const actionCell = row.insertCell();
                    actionCell.className = 'text-center';
                    const duplicateBtn = document.createElement('button');
                    duplicateBtn.type = 'button';
                    duplicateBtn.innerHTML = '<i class="fas fa-copy text-blue-500 hover:text-blue-700"></i>';
                    duplicateBtn.title = 'Nhân bản dòng';
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'ml-2';
                    removeBtn.innerHTML = '<i class="fas fa-trash-alt text-red-500 hover:text-red-700"></i>';
                    removeBtn.title = 'Xóa dòng';
                    actionCell.append(duplicateBtn, removeBtn);

                    productSearchInput.disabled = !item.category;
                    let productsInSelectedCategory = item.category ? (productsByCategory.get(item.category) || []) : [];
                    const findItemInAll = () => allStockItems.findIndex(i => i.id === item.id);
                    const updateItemData = (key, value) => {
                        const itemIndex = findItemInAll();
                        if (itemIndex > -1) allStockItems[itemIndex][key] = value;
                    };
                    const selectProduct = (product) => {
                        updateItemData('productId', product.id);
                        updateItemData('name', product.name);
                        updateItemData('code', product.code);
                        updateItemData('isValid', true);
                        productSearchInput.value = product.name;
                        codeCell.textContent = product.code;
                        stockCell.textContent = product.quantity;
                        row.classList.remove('invalid-row');
                        updateStockFormSummary();
                    };
                    categorySelect.addEventListener('change', (e) => {
                        const newCategory = e.target.value;
                        selectProduct({ id: null, name: '', code: '', quantity: '' }); // Reset sản phẩm khi đổi nhóm
                        updateItemData('category', newCategory);
                        updateItemData('isValid', !!newCategory);

                        productSearchInput.disabled = !newCategory;
                        productSearchInput.placeholder = newCategory ? 'Nhấn để chọn sản phẩm' : 'Chọn nhóm hàng trước';
                        row.classList.toggle('invalid-row', !newCategory);
                        productsInSelectedCategory = newCategory ? (productsByCategory.get(newCategory) || []) : [];
                    });
                    customerInput.addEventListener('input', debounce((e) => {
                        updateItemData('customer', e.target.value);
                        updateStockFormSummary();
                    }, 300));
                    productSearchInput.addEventListener('click', () => {
                        if (productSearchInput.disabled) return;
                        openProductSelectionModal(productsInSelectedCategory, selectProduct, categorySelect.value);
                    });
                    quantityInput.addEventListener('input', debounce((e) => {
                        updateItemData('quantity', Number(e.target.value));
                        updateStockFormSummary();
                    }, 300));
                    noteInput.addEventListener('input', debounce((e) => {
                        updateItemData('note', e.target.value);
                    }, 300));
                    removeBtn.onclick = () => {
                        allStockItems = allStockItems.filter(i => i.id !== item.id);
                        handleStockItemFilter();
                    };
                    duplicateBtn.onclick = () => {
                        const itemIndex = findItemInAll();
                        if (itemIndex > -1) {
                            const originalItem = allStockItems[itemIndex];
                            const newItem = { ...originalItem, id: Date.now() + Math.random(), quantity: null, note: '' };
                            allStockItems.splice(itemIndex + 1, 0, newItem);
                            handleStockItemFilter();
                        }
                    };
                    return row;
                };
                const renderProductSelectionList = (products, onSelectCallback) => {
                    if (productSelectionList) productSelectionList.innerHTML = '';
                    if (!products || products.length === 0) {
                        if (productSelectionList) productSelectionList.innerHTML = '<div class="p-4 text-center text-gray-500">Không có sản phẩm trong nhóm này.</div>';
                        return;
                    }
                    const fragment = document.createDocumentFragment();
                    products.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'p-3 hover:bg-blue-50 cursor-pointer flex justify-between items-center';
                        div.innerHTML = `<div><div class="font-medium">${p.name}</div><div class="text-sm text-gray-500">Mã: ${p.code}</div></div><div class="text-sm text-right"><div>Tồn: <span class="font-bold">${p.quantity}</span></div><div class="text-gray-500">${formatCurrency(p.price)}</div></div>`;

                        div.addEventListener('click', () => { onSelectCallback(p); closeModal(productSelectionModal); });
                        fragment.appendChild(div);
                    });
                    if (productSelectionList) productSelectionList.appendChild(fragment);
                };
                const openProductSelectionModal = (products, onSelectCallback, categoryName) => {
                    const productSelectionModal = document.getElementById('product-selection-modal');
                    const productSelectionCategory = document.getElementById('product-selection-category');
                    const productSelectionList = document.getElementById('product-selection-list');
                    const productSelectionSearchInput = document.getElementById('product-selection-search-input');
                    const closeProductSelectionModalBtn = document.getElementById('close-product-selection-modal-btn');

                    if (!productSelectionModal || !productSelectionSearchInput || !closeProductSelectionModalBtn) {
                        console.error("Lỗi: Không tìm thấy các thành phần của cửa sổ chọn sản phẩm.");
                        return;
                    }

                    let highlightedIndex = -1;
                    productSelectionCategory.textContent = `Nhóm hàng: ${categoryName}`;
                    productSelectionSearchInput.value = '';

                    const updateHighlight = () => {
                        const items = productSelectionList.querySelectorAll('.p-3.hover\\:bg-blue-50');
                        items.forEach((item, index) => {
                            if (index === highlightedIndex) {
                                item.classList.add('highlighted-item');
                                item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                            } else {
                                item.classList.remove('highlighted-item');
                            }
                        });
                    };

                    const searchHandler = () => {
                        highlightedIndex = -1;
                        const searchTerm = productSelectionSearchInput.value.toLowerCase().trim();
                        const filtered = products.filter(p =>
                            (p.name || '').toLowerCase().includes(searchTerm) ||
                            (p.code || '').toLowerCase().includes(searchTerm)
                        );
                        renderProductSelectionList(filtered, (selectedProduct) => {
                            onSelectCallback(selectedProduct);
                            cleanupAndClose();
                        });
                    };
                    const debouncedSearchHandler = debounce(searchHandler, 200);

                    const keydownHandler = (e) => {
                        const items = productSelectionList.querySelectorAll('.p-3.hover\\:bg-blue-50');
                        if (items.length === 0) return;

                        switch (e.key) {
                            case 'ArrowDown':
                                e.preventDefault();
                                highlightedIndex = (highlightedIndex < items.length - 1) ?
                                    highlightedIndex + 1 : 0;
                                updateHighlight();
                                break;
                            case 'ArrowUp':
                                e.preventDefault();
                                highlightedIndex = (highlightedIndex > 0) ?
                                    highlightedIndex - 1 : items.length -
                                    1;
                                updateHighlight();
                                break;
                            case 'Enter':
                                e.preventDefault();
                                if (highlightedIndex > -1 && items[highlightedIndex]) {
                                    items[highlightedIndex].click();
                                }
                                break;
                            case 'Escape':
                                cleanupAndClose();
                                break;
                        }
                    };

                    const cleanupAndClose = () => {
                        productSelectionSearchInput.removeEventListener('input', debouncedSearchHandler);
                        document.removeEventListener('keydown', keydownHandler);
                        closeProductSelectionModalBtn.removeEventListener('click', cleanupAndClose);

                        closeModal(productSelectionModal);
                    };

                    productSelectionSearchInput.addEventListener('input', debouncedSearchHandler);
                    document.addEventListener('keydown', keydownHandler);
                    closeProductSelectionModalBtn.addEventListener('click', cleanupAndClose);

                    renderProductSelectionList(products, (selectedProduct) => {
                        onSelectCallback(selectedProduct);
                        cleanupAndClose();
                    });

                    openModal(productSelectionModal);
                    setTimeout(() => productSelectionSearchInput.focus(), 50);
                };

                document.getElementById('close-product-selection-modal-btn')?.addEventListener('click', () => closeModal(productSelectionModal));
                const addStockItemRow = () => {
                    const newItem = { id: Date.now() + Math.random(), isValid: true, created_at: new Date().toISOString() };
                    allStockItems.push(newItem);
                    handleStockItemFilter();
                    stockCurrentPage = Math.ceil(filteredStockItems.length / STOCK_ITEMS_PER_PAGE) || 1;
                    displayCurrentStockPage();
                    if (stockItemsContainer?.parentElement) {
                        stockItemsContainer.parentElement.scrollTop = stockItemsContainer.parentElement.scrollHeight;
                    }
                };
                document.getElementById('clear-all-stock-items-btn')?.addEventListener('click', () => {
                    handleAsyncAction(async () => {
                        allStockItems = [];
                    }, {
                        confirmTitle: 'Xác nhận xóa tất cả',
                        confirmMessage: 'Bạn có chắc chắn muốn xóa tất cả các dòng hiện có?',
                        successMessage: 'Tất cả các dòng đã được xóa thành công.',
                        errorMessage: 'Lỗi khi xóa các dòng.'
                    })
                        .then(() => {
                            stockEntryMode = 'manual';
                            toggleStockModalView();
                            addStockItemRow();
                        })
                        .catch(error => {
                            console.log("Hành động xóa đã bị hủy hoặc có lỗi:", error.message);
                        });
                });
                document.getElementById('add-stock-item-btn')?.addEventListener('click', addStockItemRow);
       const toggleStockModalView = () => {
    const singleCustomerWrapper = document.getElementById('single-customer-wrapper');
    const stockDateWrapper = document.getElementById('stock-date-wrapper');
    const importStockBtn = document.getElementById('import-stock-excel-btn');
    const modalTitle = document.getElementById('stock-modal-title');

    const dateColHeader = document.getElementById('date-col-header');
    const customerColHeader = document.getElementById('customer-col-header');
    const showTableDateCustomer = stockEntryMode === 'import';
    const showCommonDateCustomer = stockEntryMode === 'manual' || stockEntryMode === 'order' || stockEntryMode === 'edit';

    if (stockDateWrapper) stockDateWrapper.style.display = showCommonDateCustomer ? 'block' : 'none';
    if (singleCustomerWrapper) singleCustomerWrapper.style.display = showCommonDateCustomer ? 'block' : 'none';

// Cột Ngày trong bảng (tiêu đề): chỉ hiển thị khi ở chế độ 'import'
if (dateColHeader) dateColHeader.style.display = (stockEntryMode === 'import') ? '' : 'none';

// Cột Khách hàng trong bảng (tiêu đề): chỉ hiển thị khi ở chế độ 'import'
if (customerColHeader) customerColHeader.style.display = (stockEntryMode === 'import') ? '' : 'none';

                    if (importStockBtn) importStockBtn.style.display = stockEntryMode === 'manual' ? 'flex' : 'none';

                    if (modalTitle) {
                        if (stockEntryMode === 'manual') modalTitle.textContent = '';
                        else if (stockEntryMode === 'import') modalTitle.textContent = 'Nhập Phiếu từ File Excel';
                        else if (stockEntryMode === 'order') modalTitle.textContent = 'Tạo Phiếu Đặt Hàng';
                        else if (stockEntryMode === 'export') modalTitle.textContent = 'Tạo Phiếu Xuất Kho';
                        else if (stockEntryMode === 'return') modalTitle.textContent = 'Tạo Phiếu Trả Hàng';
                        else if (stockEntryMode === 'forecast') modalTitle.textContent = 'Tạo Phiếu Dự kiến xuất';
                        else modalTitle.textContent = 'Tạo Phiếu';
                    }

                    document.querySelectorAll('.stock-item-row').forEach(row => {
                        const cells = row.querySelectorAll('td');

                        if (cells[0]) {
                            cells[0].style.display = showTableDateCustomer ? '' : 'none';
                        }
                        if (cells[1]) {
                            cells[1].style.display = showTableDateCustomer ? '' : 'none';
                        }
                    });
                    displayCurrentStockPage();
                };
            // THAY THẾ TOÀN BỘ HÀM handleAsyncAction CŨ BẰNG HÀM NÀY
const handleAsyncAction = (actionFn, { confirmTitle, confirmMessage, successMessage, errorMessage }) => {
    const statusModal = document.getElementById('status-modal');
    const confirmWrapper = document.getElementById('status-confirm-wrapper');
    const processingWrapper = document.getElementById('status-processing-wrapper');
    const completedWrapper = document.getElementById('status-completed-wrapper');

    const statusConfirmTitle = document.getElementById('status-confirm-title');
    if (statusConfirmTitle) statusConfirmTitle.textContent = confirmTitle;

    const statusConfirmMessage = document.getElementById('status-confirm-message');
    if (statusConfirmMessage) statusConfirmMessage.textContent = confirmMessage;

    // --- PHẦN QUAN TRỌNG NHẤT ĐỂ SỬA LỖI ---
    // Đảm bảo chỉ hiện phần xác nhận, và ẩn 2 phần còn lại
    if (confirmWrapper) confirmWrapper.classList.remove('hidden');
    if (processingWrapper) processingWrapper.classList.add('hidden');
    if (completedWrapper) completedWrapper.classList.add('hidden');
    // --- KẾT THÚC PHẦN SỬA LỖI ---

    openModal(statusModal);

    return new Promise((resolve, reject) => {
        const confirmBtn = document.getElementById('status-confirm-btn');
        const cancelBtn = document.getElementById('status-cancel-btn');
        const statusCompletionOkBtn = document.getElementById('status-completion-ok-btn');

        const cleanup = () => {
            if (confirmBtn) confirmBtn.onclick = null;
            if (cancelBtn) cancelBtn.onclick = null;
            if (statusCompletionOkBtn) statusCompletionOkBtn.onclick = null;
        };

        if (cancelBtn) {
            cancelBtn.onclick = () => {
                cleanup();
                closeModal(statusModal);
                reject(new Error("Action cancelled by user."));
            };
        }

        if (statusCompletionOkBtn) {
            statusCompletionOkBtn.onclick = () => {
                cleanup();
                closeModal(statusModal);
                resolve(true);
            };
        }

        if (confirmBtn) {
            confirmBtn.onclick = async () => {
                if (confirmWrapper) confirmWrapper.classList.add('hidden');
                if (processingWrapper) processingWrapper.classList.remove('hidden');

                try {
                    await actionFn();
                    const statusCompletionIcon = document.getElementById('status-completion-icon');
                    const statusCompletionMessage = document.getElementById('status-completed-wrapper')?.querySelector('p');
                    if (statusCompletionMessage) statusCompletionMessage.textContent = successMessage;

                    // --- BẮT ĐẦU PHẦN BỔ SUNG/SỬA ĐỂ TỰ ĐỘNG ĐÓNG MODAL ---
                    if (statusCompletionIcon) {
                        // Kiểm tra nếu icon hiển thị là icon thành công (check-circle)
                        const isSuccessIcon = statusCompletionIcon.innerHTML.includes('fa-check-circle');

                        if (isSuccessIcon) {
                            if (statusCompletionOkBtn) statusCompletionOkBtn.style.display = 'none'; // Ẩn nút OK
                            setTimeout(() => {
                                cleanup();
                                closeModal(statusModal);
                                resolve(true); // Hoàn thành promise
                            }, 2000); // Tự động đóng sau 2 giây
                        } else {
                            // Nếu là icon lỗi, vẫn hiển thị nút OK
                            if (statusCompletionOkBtn) {
                                statusCompletionOkBtn.style.display = ''; // Đảm bảo nút OK hiển thị
                                statusCompletionOkBtn.onclick = () => {
                                    cleanup();
                                    closeModal(statusModal);
                                    resolve(false); // Hoặc reject nếu bạn muốn xử lý lỗi rõ ràng hơn bên ngoài
                                };
                            }
                        }
                    }
                    // --- KẾT THÚC PHẦN BỔ SUNG/SỬA ---

                } catch (error) {
                    console.error(errorMessage, error);
                    const statusCompletionIcon = document.getElementById('status-completion-icon'); // Lấy lại icon
                    if (statusCompletionIcon) statusCompletionIcon.innerHTML = `<i class="fas fa-times-circle text-5xl text-red-500"></i>`; // Đảm bảo icon lỗi
                    const statusCompletionMessage = document.getElementById('status-completed-wrapper')?.querySelector('p');
                    if (statusCompletionMessage) statusCompletionMessage.textContent = `${errorMessage} ${error.message}`;

                    // Dù có lỗi, vẫn phải hiển thị nút OK để người dùng đóng
                    if (statusCompletionOkBtn) {
                        statusCompletionOkBtn.style.display = ''; // Đảm bảo nút OK hiển thị
                        statusCompletionOkBtn.onclick = () => {
                            cleanup();
                            closeModal(statusModal);
                            reject(error); // Reject promise khi có lỗi và người dùng nhấn OK
                        };
                    }
                } finally {
                    if (processingWrapper) processingWrapper.classList.add('hidden');
                    if (completedWrapper) completedWrapper.classList.remove('hidden');
                }
            };
        }
    });
};
                document.getElementById('open-stock-manual-btn')?.addEventListener('click', () => { stockEntryMode = 'manual'; openStockModal(); });
                // document.getElementById('open-stock-import-btn')?.addEventListener('click', () => { stockEntryMode = 'import'; openStockModal(); });

                const executeTransaction = async () => {
                    const typeElement = document.querySelector('input[name="stock-type"]:checked');
                    const type = typeElement ? typeElement.value : 'import';
                    const editingId = document.getElementById('editing-transaction-id')?.value;
                    const validItems = allStockItems.filter(item => item.isValid && item.productId && item.quantity > 0);
                    if (validItems.length === 0) {
                        return {
                            successCount: 0, errorCount: 1, message: "Không có dòng hợp lệ để xử lý. Giao dịch không được lưu."
                        };
                    }

        const customerDateGroups = validItems.reduce((acc, item) => {
        const stockSingleCustomerElement = document.getElementById('stock-single-customer');
        const stockDateElement = document.getElementById('stock-date');
        
        let customerName;
        let transactionDate;
        
        // Bổ sung xử lý cho chế độ 'edit' và 'manual/order'
        if (stockEntryMode === 'manual' || stockEntryMode === 'order' || stockEntryMode === 'edit') {
        customerName = stockSingleCustomerElement?.value.trim() || 'Khách lẻ';
        transactionDate = stockDateElement?.value || getTodayDate();
        } else { // Xử lý chế độ 'import'
        customerName = (item.customer || 'Khách lẻ').trim();
        transactionDate = (new Date(item.created_at).toISOString().split('T')[0]);
        }
        
        const groupKey = `${customerName}_${transactionDate}`;
        
        if (!acc[groupKey]) {
        acc[groupKey] = { customer: customerName, date: transactionDate, items: [] };
        }
        acc[groupKey].items.push(item);
        return acc;
        }, {});

                    if (type === 'export') {
                        const productQuantitiesNeeded = new Map();
                        for (const groupKey in customerDateGroups) {
                            for (const item of customerDateGroups[groupKey].items) {
                                const needed = (productQuantitiesNeeded.get(item.productId) || 0) + item.quantity;
                                productQuantitiesNeeded.set(item.productId, needed);
                            }
                        }
                        for (const [productId, needed] of productQuantitiesNeeded.entries()) {
                            const product = allProducts.find(p => p.id === productId);
                            const available = product?.quantity || 0;
                            if (available < needed) {
                                return { successCount: 0, errorCount: 1, message: `Tồn kho không đủ cho SP "${product?.name || 'không rõ'}" (cần ${needed}, có ${available}).` };
                            }
                        }
                    }

                    try {
                        if (editingId) {
                            const { error: deleteOldTransactionError } = await supabase.rpc('delete_transactions', { p_transaction_ids: [parseInt(editingId)] });
                            if (deleteOldTransactionError) throw deleteOldTransactionError;
                        }

                        const pTransactions = Object.values(customerDateGroups).map(group => ({
                            type: type,
                            customer: group.customer,
                            created_at: new Date(group.date).toISOString(),
                            user_id: userId, // Thêm user_id vào đây
                            items: group.items.map(item => ({
                                product_id: item.productId,
                                name: item.name,
                                code: item.code,
                                category: item.category,
                                quantity: item.quantity,
                                price_at_transaction: allProducts.find(p => p.id === item.productId)?.price || 0,
                                note: item.note || ''
                            }))
                        }));
                        const { error } = await supabase.rpc('process_transactions', {
                            p_transactions: pTransactions
                        });
                        if (error) {
                            throw error;
                        }

                        return { successCount: pTransactions.length, errorCount: 0 };

                    } catch (error) {
                        let userFriendlyMessage = `Lỗi hệ thống khi ghi dữ liệu: ${error.message}`;
                        if (error.message.includes("check_product_stock")) {
                            userFriendlyMessage = "Lỗi tồn kho không đủ. Giao dịch đã bị hủy.";
                        }
                        if (editingId) {
                            return { successCount: 0, errorCount: 1, message: `${userFriendlyMessage} LƯU Ý: Giao dịch gốc đã bị xóa. Vui lòng tải lại trang để đảm bảo dữ liệu chính xác.` };
                        }
                        return { successCount: 0, errorCount: 1, message: userFriendlyMessage };
                    }
                };

                // Mã đã được sửa
                document.getElementById('validation-completion-ok-btn')?.addEventListener('click', () => {
                    closeModal(validationModal);

                    // Kiểm tra xem giao dịch có thành công không
                    if (document.getElementById('completion-icon')?.innerHTML.includes('fa-check-circle')) {

                        // *** BỔ SUNG: Xóa dữ liệu của phiếu cũ tại đây ***
                        allStockItems = [];
                        filteredStockItems = [];
                        handleStockItemFilter(); // Cập nhật lại giao diện bảng (trở nên rỗng)

                        // Đóng modal nhập liệu chính
                        closeModal(stockModal);
                    }
                });
                // --- LẮNG NGHE DATA & HIỂN THỊ ---
                const updateDashboard = () => {
                    const totalProductsElement = document.getElementById('total-products');
                    if (totalProductsElement) totalProductsElement.textContent = allProducts.length;
                    const totalQuantityElement = document.getElementById('total-quantity');
                    if (totalQuantityElement) totalQuantityElement.textContent = allProducts.reduce((sum, p) => sum + (p.quantity || 0), 0);
                    const lowStockCountElement = document.getElementById('low-stock-count');
                    if (lowStockCountElement) lowStockCountElement.textContent = allProducts.filter(p => p.quantity > 0 && p.quantity <= 20).length;
                    const outOfStockCountElement = document.getElementById('out-of-stock-count');
                    if (outOfStockCountElement) outOfStockCountElement.textContent = allProducts.filter(p => p.quantity === 0).length;
                };
                const updateCategoryLists = () => {
                    allCategories = [...new Set(allProducts.map(p => p.category))].sort();
                    const categoryListDatalistElement = document.getElementById('category-list-datalist');
                    if (categoryListDatalistElement) categoryListDatalistElement.innerHTML = allCategories.map(cat => `<option value="${cat}"></option>`).join('');
                    const currentFilterValue = categoryFilterSelect?.value;
                    if (categoryFilterSelect) {
                        categoryFilterSelect.innerHTML = '<option value="">Tất cả nhóm hàng</option>' + allCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                        categoryFilterSelect.value = currentFilterValue;
                    }
                };
                const renderProducts = (productsToRender) => {
                    if (productTableBody) productTableBody.innerHTML = '';
                    if (productsToRender.length === 0) {
                        if (productTableBody) productTableBody.innerHTML = `<tr><td colspan="10" class="text-center p-8 text-gray-500">Không có sản phẩm nào.</td></tr>`;
                        return;
                    }

                    const isAdmin = currentUserRole === 'admin';
                    const productSelectAllCheckboxHeader = document.querySelector('.product-select-col');
                    if (productSelectAllCheckboxHeader) {
                        productSelectAllCheckboxHeader.style.display = isAdmin && isProductBulkEditMode ? '' : 'none';
                    }

                    const rowsHtml = productsToRender.map(product => `
                        <tr class="hover:bg-gray-50 ${product.quantity === 0 ? 'bg-red-50' : ''} ${product.quantity > 0 && product.quantity <= 20 ? 'bg-orange-50' : ''} ${product.is_active === false ? 'opacity-70 italic text-gray-500' : ''}">
                            <td class="p-3 text-center product-select-col" style="display: ${isAdmin && isProductBulkEditMode ? '' : 'none'}">
                                <input type="checkbox" class="product-checkbox" data-id="${product.id}" ${selectedProductIds.has(String(product.id)) ? 'checked' : ''}>
                            </td>
                            <td class="p-3">${product.category}</td>
                            <td class="p-3 name-col">${product.name} ${product.is_active === false ? '<span class="text-xs bg-red-100 text-red-700 px-1 py-0.5 rounded ml-1">Ngưng bán</span>' : ''}</td>
                            <td class="p-3 font-mono text-sm text-gray-500">${product.code}</td>
                            <td class="p-3 text-right">${formatCurrency(product.price)}</td>
                            <td class="p-3 text-sm text-gray-600 note-col" title="${product.notes || ''}">${product.notes || ''}</td>
                            <td class="p-3 text-center font-bold ${product.quantity <= 20 ? 'text-red-600' : 'text-green-600'}">${product.quantity}</td>
                            <td class="p-3 text-center font-medium text-blue-600">${product.ordered_quantity || 0}</td>
                            <td class="p-3 text-center font-medium text-purple-600">${product.expected_ship_quantity || 0}</td>
                            <td class="p-3 text-center" style="display: ${isAdmin ? '' : 'none'}">
                                <button data-id="${product.id}" class="edit-btn text-blue-600 hover:text-blue-800 p-2"><i class="fas fa-edit"></i></button>
                                <button data-id="${product.id}" class="delete-btn text-red-600 hover:text-red-800 p-2 ml-2"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `).join('');
                    if (productTableBody) productTableBody.innerHTML = rowsHtml;
                };
                const renderTransactionHistory = (transactionsToRender) => {
                    if (loadingHistorySpinner) loadingHistorySpinner.style.display = 'none';
                    if (historyTableBody) historyTableBody.innerHTML = '';
                    if (transactionsToRender.length === 0) {
                        if (historyTableBody) historyTableBody.innerHTML = `<tr>
    <td colspan="8" class="text-center p-8 text-gray-500">Không tìm thấy giao dịch.</td>
</tr>`;
                        return;
                    }
                    const isAdmin = currentUserRole === 'admin';

                    // Ánh xạ màu sắc cho từng loại giao dịch
                    const transactionTypeColorMap = {
                        'import': 'text-green-600', // Nhập kho: Xanh lá
                        'export': 'text-red-600', // Xuất kho: Đỏ
                        'return': 'text-purple-600', // Trả hàng: Tím
                        'order': 'text-yellow-700', // Đặt hàng: Vàng đậm
                        'forecast': 'text-blue-600' // Dự kiến xuất: Xanh dương
                    };

                    const rowsHtml = transactionsToRender.map(trans => {
                        const typeText = { 'import': 'Nhập kho', 'export': 'Xuất kho', 'return': 'Trả hàng', 'order': 'Đặt hàng', 'forecast':
                            'Dự kiến xuất' }[trans.type] || trans.type;
                        // Lấy màu sắc từ ánh xạ, nếu không có thì mặc định là text-gray-800
                        const typeColor = transactionTypeColorMap[trans.type] || 'text-gray-800';

                        const numUniqueItems = new Set(trans.items.map(item => item.product_id || item.code)).size;
                        const totalQuantity = trans.items.reduce((sum, item) => sum + (item.quantity || 0), 0);

                        const notesSummary = [...new Set(trans.items.map(i => i.note).filter(Boolean))].join('; ');
                        return `
<tr class="hover:bg-gray-50">
    <td class="p-3 text-center"><input type="checkbox" class="history-checkbox" data-id="${trans.id}" style="display: ${isAdmin ? '' : 'none'}">
    </td>
    <td class="p-3">${formatDate(trans.created_at, false)}</td>
    <td class="p-3 font-medium ${typeColor}">${typeText}</td>
    <td class="p-3 name-col">${trans.customer || 'N/A'}</td>
    <td class="p-3 text-center">${numUniqueItems}</td>
    <td class="p-3 text-center font-bold">${totalQuantity}</td>
    <td class="p-3 note-col" title="${notesSummary}">${notesSummary}</td>
    <td class="p-3 text-center">
        <div class="flex justify-center items-center gap-1">
            <button data-id="${trans.id}" class="view-history-btn btn p-2 text-blue-600 hover:bg-blue-100 rounded-full" title="Xem chi tiết"><i class="fas fa-eye"></i></button>
            ${isAdmin ? `
            <button data-id="${trans.id}" class="edit-history-btn btn p-2 text-yellow-500 hover:bg-yellow-100 rounded-full" title="Chỉnh sửa"><i class="fas fa-edit"></i></button>
            <button data-id="${trans.id}" class="export-history-btn btn p-2 text-green-600 hover:bg-green-100 rounded-full" title="Xuất Excel"><i class="fas fa-file-excel"></i></button>
            <button data-id="${trans.id}" class="delete-history-btn btn p-2 text-red-600 hover:bg-red-100 rounded-full" title="Xóa"><i class="fas fa-trash-alt"></i></button>
            ` : ''}
        </div>
    </td>
</tr>
`;
                    }).join('');
                    if (historyTableBody) historyTableBody.innerHTML = rowsHtml;
                };


                // --- TÌM KIẾM VÀ LỌC ---
                const searchInput = document.getElementById('search-input');
                const historySearchInput = document.getElementById('history-search-input');
                const historyTypeFilter = document.getElementById('history-type-filter');
                const productStatusFilter = document.getElementById('product-status-filter');
                const applyFiltersAndRender = () => {
                    const minQuantity = parseInt(document.getElementById('min-quantity-filter')?.value);
                    const maxQuantity = parseInt(document.getElementById('max-quantity-filter')?.value);
                    const searchTerm = searchInput?.value.toLowerCase().trim();
                    const selectedCategory = categoryFilterSelect?.value;
                    const selectedStatus = productStatusFilter?.value;

                    let filtered = allProducts;

                    if (selectedStatus === 'active') {
                        filtered = filtered.filter(p => p.is_active === true);
                    } else if (selectedStatus === 'inactive') {
                        filtered = filtered.filter(p => p.is_active === false);
                    }

                    if (selectedCategory) {
                        filtered = filtered.filter(p => p.category === selectedCategory);
                    }

                    if (searchTerm) {
                        filtered = filtered.filter(p => (p.searchable_name || '').includes(searchTerm) || (p.notes || '').toLowerCase().includes(searchTerm));
                    }
                    // === BỔ SUNG: LỌC THEO KHOẢNG TỒN KHO ===
                    if (!isNaN(minQuantity) && minQuantity >= 0) {
                        filtered = filtered.filter(p => p.quantity >= minQuantity);
                    }
                    if (!isNaN(maxQuantity) && maxQuantity >= 0) {
                        filtered = filtered.filter(p => p.quantity <= maxQuantity);
                    } //===KẾT THÚC BỔ SUNG===
                    if (dashboardFilterType === 'low-stock') {
                        filtered = filtered.filter(p => p.quantity > 0 && p.quantity <= 20);
                    } else if (dashboardFilterType === 'out-of-stock') {
                        filtered = filtered.filter(p => p.quantity === 0);
                    }

                    displayedProducts = filtered;
                    productsCurrentPage = 1;
                    displayCurrentProductsPage();
                };
                const displayCurrentProductsPage = () => {
                    let pageItems = [];
                    if (PRODUCTS_PER_PAGE === -1) {
                        pageItems = displayedProducts;
                    } else {
                        const startIndex = (productsCurrentPage - 1) * PRODUCTS_PER_PAGE;
                        const endIndex = startIndex + PRODUCTS_PER_PAGE;
                        pageItems = displayedProducts.slice(startIndex, endIndex);
                    }
                    renderProducts(pageItems);
                    renderProductsPagination();
                };
                const renderProductsPagination = () => {
                    const productsPaginationControls = document.getElementById('products-pagination-controls');
                    if (!productsPaginationControls) return;

                    const totalItems = displayedProducts.length;
                    const totalPages = Math.ceil(totalItems / PRODUCTS_PER_PAGE);

                    productsPaginationControls.innerHTML = '';
                    if (totalItems === 0) {
                        productsPaginationControls.innerHTML = `<span class="text-gray-500">Không có dữ liệu để hiển thị.</span>`;
                        return;
                    }

                    if (PRODUCTS_PER_PAGE === -1) {
                        productsPaginationControls.innerHTML = `
                            <div class="flex-grow text-gray-600 text-sm">
                                Hiển thị tất cả ${totalItems} dữ liệu
                            </div>
                        `;
                        return;
                    }

                    const startIndex = (productsCurrentPage - 1) * PRODUCTS_PER_PAGE;
                    const endIndex = Math.min(startIndex + PRODUCTS_PER_PAGE, totalItems);

                    let paginationHtml = `
                        <div class="flex-grow text-gray-600 text-sm">
                            Hiển thị ${startIndex + 1} tới ${endIndex} của ${totalItems} dữ liệu
                        </div>
                        <div class="flex items-center gap-1">
                            <button id="products-prev-btn" class="btn px-3 py-1 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 ${productsCurrentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${productsCurrentPage === 1 ?
                            'disabled' : ''}>
                                Trước
                            </button>
                    `;
                    const maxPagesToShow = 5;
                    let startPage = Math.max(1, productsCurrentPage - Math.floor(maxPagesToShow / 2));
                    let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

                    if (endPage - startPage + 1 < maxPagesToShow) {
                        startPage = Math.max(1, endPage - maxPagesToShow + 1);
                    }

                    if (startPage > 1) {
                        paginationHtml += `<button class="btn px-3 py-1 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-100" data-page="1">1</button>`;
                        if (startPage > 2) {
                            paginationHtml += `<span class="px-2">...</span>`;
                        }
                    }

                    for (let i = startPage; i <= endPage; i++) {
                        paginationHtml += `
                            <button class="btn px-3 py-1 mx-1 rounded-lg border border-gray-300 ${i === productsCurrentPage ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}" data-page="${i}">
                                ${i}
                            </button>
                        `;
                    }

                    if (endPage < totalPages) {
                        if (endPage < totalPages - 1) {
                            paginationHtml += `<span class="px-2">...</span>`;
                        }
                        paginationHtml += `<button class="btn px-3 py-1 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-100" data-page="${totalPages}">${totalPages}</button>`;
                    }

                    paginationHtml += `
                            <button id="products-next-btn" class="btn px-3 py-1 ml-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 ${productsCurrentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${productsCurrentPage === totalPages ?
                            'disabled' : ''}>
                                Sau
                            </button>
                        </div>
                    `;
                    productsPaginationControls.innerHTML = paginationHtml;

                    productsPaginationControls.querySelectorAll('button[data-page]').forEach(button => {
                        button.addEventListener('click', () => {
                            productsCurrentPage = parseInt(button.dataset.page);
                            displayCurrentProductsPage();
                        });
                    });
                    document.getElementById('products-prev-btn')?.addEventListener('click', () => {
                        if (productsCurrentPage > 1) {
                            productsCurrentPage--;
                            displayCurrentProductsPage();
                        }
                    });
                    document.getElementById('products-next-btn')?.addEventListener('click', () => {
                        if (productsCurrentPage < totalPages) {
                            productsCurrentPage++;
                            displayCurrentProductsPage();
                        }
                    });
                };
                const transactionTypeMap = {
                    'import': 'nhập kho',
                    'export': 'xuất kho',
                    'return': 'trả hàng',
                    'order': 'đặt hàng',
                    'forecast': 'dự kiến xuất'
                };
                const applyHistoryFilterAndRender = () => {
                    const searchTerm = historySearchInput?.value.toLowerCase().trim();
                    let filtered = [];

                    if (currentTransactionType) {
                        // Lọc theo tab đang hoạt động trước
                        filtered = allTransactions.filter(t => t.type === currentTransactionType);

                        // Sau đó mới áp dụng bộ lọc tìm kiếm
                        if (searchTerm) {
                            const transactionTypeMap = { 'import': 'nhập kho', 'export': 'xuất kho', 'return': 'trả hàng', 'order': 'đặt hàng', 'forecast': 'dự kiến xuất' };
                            filtered = filtered.filter(t =>
                                (t.customer && t.customer.toLowerCase().includes(searchTerm)) ||
                                (transactionTypeMap[t.type] || t.type).toLowerCase().includes(searchTerm) ||
                                t.items.some(item =>
                                    (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                                    (item.code && item.code.toLowerCase().includes(searchTerm)) ||
                                    (item.note && item.note.toLowerCase().includes(searchTerm)) ||
                                    (item.category && item.category.toLowerCase().includes(searchTerm))
                                )
                            );
                        }
                    }

                    displayedTransactions = filtered;
                    historyCurrentPage = 1;
                    displayCurrentHistoryPage();

                    const historySelectAllCheckbox = document.getElementById('history-select-all-checkbox');
                    selectedTransactionIds.clear();
                    if (historySelectAllCheckbox) historySelectAllCheckbox.checked = false;
                    updateSelectedHistoryCount();
                };
                const displayCurrentHistoryPage = () => {
                    let pageItems = [];
                    if (HISTORY_ITEMS_PER_PAGE === -1) {
                        pageItems = displayedTransactions;
                    } else {
                        const startIndex = (historyCurrentPage - 1) * HISTORY_ITEMS_PER_PAGE;
                        const endIndex = startIndex + HISTORY_ITEMS_PER_PAGE;
                        pageItems = displayedTransactions.slice(startIndex, endIndex);
                    }
                    renderTransactionHistory(pageItems);
                    renderHistoryPagination();
                };
                const renderHistoryPagination = () => {
                    const historyPaginationControls = document.getElementById('history-pagination-controls');
                    if (!historyPaginationControls) return;

                    const totalItems = displayedTransactions.length;
                    const totalPages = Math.ceil(totalItems / HISTORY_ITEMS_PER_PAGE);

                    historyPaginationControls.innerHTML = '';
                    if (totalItems === 0) {
                        historyPaginationControls.innerHTML = `<span class="text-gray-500">Không có dữ liệu để hiển thị.</span>`;
                        return;
                    }

                    if (HISTORY_ITEMS_PER_PAGE === -1) {
                        historyPaginationControls.innerHTML = `
                            <div class="flex-grow text-gray-600 text-sm">
                                Hiển thị tất cả ${totalItems} dữ liệu
                            </div>
                        `;
                        return;
                    }

                    const startIndex = (historyCurrentPage - 1) * HISTORY_ITEMS_PER_PAGE;
                    const endIndex = Math.min(startIndex + HISTORY_ITEMS_PER_PAGE, totalItems);

                    let paginationHtml = `
                        <div class="flex-grow text-gray-600 text-sm">
                            Hiển thị ${startIndex + 1} tới ${endIndex} của ${totalItems} dữ liệu
                        </div>
                        <div class="flex items-center gap-1">
                            <button id="history-prev-btn" class="btn px-3 py-1 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 ${historyCurrentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${historyCurrentPage === 1 ?
                            'disabled' : ''}>
                                Trước
                            </button>
                    `;
                    const maxPagesToShow = 5;
                    let startPage = Math.max(1, historyCurrentPage - Math.floor(maxPagesToShow / 2));
                    let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

                    if (endPage - startPage + 1 < maxPagesToShow) {
                        startPage = Math.max(1, endPage - maxPagesToShow + 1);
                    }

                    if (startPage > 1) {
                        paginationHtml += `<button class="btn px-3 py-1 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-100" data-page="1">1</button>`;
                        if (startPage > 2) {
                            paginationHtml += `<span class="px-2">...</span>`;
                        }
                    }

                    for (let i = startPage; i <= endPage; i++) {
                        paginationHtml += `
                            <button class="btn px-3 py-1 mx-1 rounded-lg border border-gray-300 ${i === historyCurrentPage ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}" data-page="${i}">
                                ${i}
                            </button>
                        `;
                    }

                    if (endPage < totalPages) {
                        if (endPage < totalPages - 1) {
                            paginationHtml += `<span class="px-2">...</span>`;
                        }
                        paginationHtml += `<button class="btn px-3 py-1 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-100" data-page="${totalPages}">${totalPages}</button>`;
                    }

                    paginationHtml += `
                            <button id="history-next-btn" class="btn px-3 py-1 ml-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 ${historyCurrentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${historyCurrentPage === totalPages ?
                            'disabled' : ''}>
                                Sau
                            </button>
                        </div>
                    `;
                    historyPaginationControls.innerHTML = paginationHtml;

                    historyPaginationControls.querySelectorAll('button[data-page]').forEach(button => {
                        button.addEventListener('click', () => {
                            historyCurrentPage = parseInt(button.dataset.page);
                            displayCurrentHistoryPage();
                        });
                    });
                    document.getElementById('history-prev-btn')?.addEventListener('click', () => {
                        if (historyCurrentPage > 1) {
                            historyCurrentPage--;
                            displayCurrentHistoryPage();
                        }
                    });
                    document.getElementById('history-next-btn')?.addEventListener('click', () => {
                        if (historyCurrentPage < totalPages) {
                            historyCurrentPage++;
                            displayCurrentHistoryPage();
                        }
                    });
                };
                searchInput?.addEventListener('input', debounce(() => {
                    dashboardFilterType = 'all';
                    applyFiltersAndRender();
                }, 300));
                categoryFilterSelect?.addEventListener('change', () => {
                    dashboardFilterType = 'all';
                    applyFiltersAndRender();
                });
                productStatusFilter?.addEventListener('change', () => {
                    dashboardFilterType = 'all';
                    applyFiltersAndRender();
                });
                historySearchInput?.addEventListener('input', debounce(applyHistoryFilterAndRender, 300));
                historyTypeFilter?.addEventListener('change', applyHistoryFilterAndRender);
                const importExcelBtn = document.getElementById('import-excel-btn');
                const excelFileInput = document.getElementById('excel-file-input');
                const importStockExcelBtn = document.getElementById('import-stock-excel-btn');
                const stockExcelInput = document.getElementById('stock-excel-input');
                const exportExcelBtn = document.getElementById('export-excel-btn');
                importExcelBtn?.addEventListener('click', () => excelFileInput?.click());
                importStockExcelBtn?.addEventListener('click', () => stockExcelInput?.click());
                excelFileInput?.addEventListener('change', (event) => handleProductImport(event.target.files[0]));
                stockExcelInput?.addEventListener('change', (event) => handleStockImport(event.target.files[0]));
                const findKey = (obj, aliases) => {
                    for (const alias of aliases) {
                        const key = Object.keys(obj).find(k => k.trim().toLowerCase() === alias.toLowerCase());
                        if (key) return key;
                    }
                    return null;
                };
                const handleProductImport = (file) => {
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                            if (json.length === 0) {
                                showToast("File Excel rỗng.", true);
                                return;
                            }

                            productsToImport = json.map((row, index) => {
                                let priceString = String(row['Đơn giá'] || '0').trim();
                                priceString = priceString.replace(/\./g, '');
                                priceString = priceString.replace(/,/g, '.');
                                priceString = priceString.replace(/₫/g, '');
                                priceString = priceString.replace(/đ/g, '');
                                priceString = priceString.replace(/\s/g, '');

                                let parsedPrice = Number(priceString);
                                const price = isNaN(parsedPrice) ? 0 : parsedPrice;

                                const product = {
                                    category: String(row['Nhóm hàng'] || 'Chưa phân loại').trim(),
                                    code: String(row['Mã hàng'] || '').trim(),
                                    name: String(row['Tên hàng'] || '').trim(),
                                    price: price,
                                    quantity: Number(row['Tồn kho'] || 0),
                                    ordered_quantity: 0,
                                    expected_ship_quantity: 0,
                                    notes: String(row['Ghi chú'] || '').trim(),
                                    user_id: userId,
                                    searchable_name: `${String(row['Tên hàng'] || '').trim().toLowerCase()} ${String(row['Mã hàng'] || '').trim().toLowerCase()}`,
                                    original_order: index,
                                    is_active: true
                                };
                                return product;
                            }).filter(p => p.name && p.code);

                            if (productsToImport.length > 0) {
                                const importCountElement = document.getElementById('import-count');
                                if (importCountElement) importCountElement.textContent = productsToImport.length;
                                openModal(importConfirmModal);
                            } else {
                                showToast("Không có sản phẩm hợp lệ để nhập.", true);
                            }
                        } catch (error) {
                            showToast("Lỗi khi đọc file DS sản phẩm.", true);
                        } finally {
                            if (excelFileInput) excelFileInput.value = '';
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };
                const executeConfirmedImport = async () => {
                    if (productsToImport.length === 0) return;
                    // Xóa tất cả sản phẩm cũ
                    const { error: deleteError } = await supabase.from('products').delete().neq('id', -1);
                    if (deleteError) throw deleteError;
                    const { error: insertError } = await supabase.from('products').insert(productsToImport);
                    if (insertError) throw insertError;
                };
                document.getElementById('confirm-import-btn')?.addEventListener('click', () => {
                    closeModal(importConfirmModal);
                    handleAsyncAction(executeConfirmedImport, {
                        confirmTitle: 'Xác nhận Nhập Sản phẩm', confirmMessage: 'Hành động này sẽ xóa toàn bộ sản phẩm cũ và thay thế bằng dữ liệu mới. Không thể hoàn tác.',
                        successMessage: `Đã nhập thành công ${productsToImport.length} sản phẩm!`, errorMessage: 'Quá trình nhập đã xảy ra lỗi.'
                    }).finally(() => { productsToImport = []; });
                });
                document.getElementById('cancel-import-btn')?.addEventListener('click', () => { productsToImport = []; closeModal(importConfirmModal); });

                const handleStockImport = (file) => {
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                            if (json.length > 0) {
                                stockEntryMode = 'import'; // Thay đổi trạng thái sang chế độ nhập Excel
                                toggleStockModalView(); // Gọi hàm để cập nhật lại giao diện
                            }
                            const errors = [];
                            let lastCustomer = "";
                            allStockItems = json.map((row, index) => {
                                const dateKey = findKey(row, ['ngày', 'date', 'ngay lap phieu', 'ngày lập phiếu', 'ngay']);
                                const customerKey = findKey(row, ['khách hàng', 'khach hang', 'customer']);
                                const codeKey = findKey(row, ['mã hàng', 'ma hang', 'code', 'mã sp']);
                                const quantityKey = findKey(row, ['số lượng', 'so luong', 'sl', 'quantity']);
                                const noteKey = findKey(row, ['ghi chú', 'ghi chu', 'notes']);

                                let customer = customerKey ? String(row[customerKey]).trim() : '';
                                if (customer) { lastCustomer = customer; } else { customer = lastCustomer; }
                                const code = codeKey ? String(row[codeKey]).trim() : '';
                                const quantity = quantityKey ? Number(row[quantityKey]) : NaN;
                                const note = noteKey ? String(row[noteKey]).trim() : '';

                                let itemDate = new Date();
                                let dateParseError = false;
                                if (dateKey && row[dateKey]) {
                                    try {
                                        if (typeof row[dateKey] === 'number') {
                                            itemDate = new Date(Math.round((row[dateKey] - 25569) * 86400 * 1000));
                                        } else {
                                            const dateStringValue = String(row[dateKey]).trim();
                                            const parts = dateStringValue.split('/');
                                            if (parts.length === 3) {
                                                itemDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                                            } else {
                                                itemDate = new Date(dateStringValue);
                                            }
                                        }
                                        if (isNaN(itemDate.getTime())) { dateParseError = true; }
                                    } catch (e) { dateParseError = true; }
                                }
                                if (dateParseError) {
                                    errors.push(`Dòng ${index + 2}: Ngày "${row[dateKey]}" không hợp lệ. Sử dụng ngày hiện tại.`);
                                    itemDate = new Date();
                                }

                                let isValid = true;
                                if (!code && (isNaN(quantity) || row[quantityKey] === '') && !customer) { return null; }
                                if (!code) {
                                    errors.push(`Dòng ${index + 2}: Thiếu Mã SP.`);
                                    isValid = false;
                                } else {
                                    const product = allProducts.find(p => p.code === code);
                                    if (!product) { errors.push(`Dòng ${index + 2}: Mã SP "${code}" không tồn tại.`); isValid = false; }
                                }
                                if (isNaN(quantity) || quantity < 0) {
                                    errors.push(`Dòng ${index + 2}: Số lượng "${row[quantityKey]}" không hợp lệ.`);
                                    isValid = false;
                                }
                                return {
                                    id: Date.now() + Math.random(),
                                    customer,
                                    category: (allProducts.find(p => p.code === code)?.category) || 'Lỗi',
                                    productId: (allProducts.find(p => p.code === code)?.id) || null,
                                    name: (allProducts.find(p => p.code === code)?.name) || `Không tìm thấy: ${code}`,
                                    code,
                                    quantity,
                                    note,
                                    isValid,
                                    created_at: itemDate.toISOString()
                                };
                            }).filter(item => item !== null);

                            if (errors.length > 0) {
                                const importErrorList = document.getElementById('import-error-list');
                                if (importErrorList) importErrorList.innerHTML = errors.map(err => `<li>${err}</li>`).join('');
                                openModal(importErrorModal);
                                allStockItems = [];
                            } else { showToast(`Đã tải thành công ${allStockItems.length} dòng từ file.`); }
                            handleStockItemFilter();
                        } catch (error) {
                            console.error("Error in handleStockImport:", error);
                            showToast(`Lỗi khi đọc file phiếu Nhập/Xuất: ${error.message}`, true);
                        } finally {
                            if (stockExcelInput) stockExcelInput.value = '';
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };
                const exportToExcel = (data, filename) => {
                    const worksheet = XLSX.utils.json_to_sheet(data);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Data");
                    XLSX.writeFile(workbook, `${filename}_${getTodayDate()}.xlsx`);
                };
                const exportProductList = () => {
                    let productsToExport = [];

                    // Nếu đang ở chế độ chỉnh sửa hàng loạt và có sản phẩm được chọn
                    if (isProductBulkEditMode && selectedProductIds.size > 0) {
                        productsToExport = allProducts.filter(p => selectedProductIds.has(String(p.id)));
                    } else {
                        // Nếu không ở chế độ chỉnh sửa hàng loạt, xuất DỮ LIỆU ĐÃ ĐƯỢC LỌC VÀ HIỂN THỊ
                        // Sử dụng mảng 'displayedProducts' đã chứa tất cả các bộ lọc hiện tại
                        productsToExport = displayedProducts;
                    }

                    if (productsToExport.length === 0) {
                        showToast("Không có sản phẩm nào để xuất với các điều kiện hiện tại.", true);
                        return;
                    }

                    const dataToExport = productsToExport.map(p => ({
                        'Nhóm hàng': p.category,
                        'Tên hàng': p.name,
                        'Mã hàng': p.code,
                        'Tồn kho': p.quantity,
                        'Đơn giá': p.price,
                        'Giá trị tồn': p.quantity * p.price,
                        'Ghi chú': p.notes || '',
                        'Đang kinh doanh': p.is_active ? 'Có' : 'Không'
                    }));

                    exportToExcel(dataToExport, "DanhSachSanPham");

                    let exportMessage = '';
                    if (isProductBulkEditMode && selectedProductIds.size > 0) {
                        exportMessage = `Đã xuất thành công ${productsToExport.length} sản phẩm đã chọn!`;
                        selectedProductIds.clear();
                        const productCheckboxes = document.querySelectorAll('.product-checkbox');
                        productCheckboxes.forEach(checkbox => {
                            checkbox.checked = false;
                        });
                        updateProductBulkActionsUI();
                    } else {
                        exportMessage = `Đã xuất thành công ${productsToExport.length} sản phẩm theo các điều kiện lọc hiện tại!`;
                    }
                    showToast(exportMessage);
                };

                // --- SỰ KIỆN CHO DROPDOWN XUẤT EXCEL (GIAO DỊCH) ---
                const historyExportDropdownBtn = document.getElementById('history-export-dropdown-btn');
                const historyExportDropdownMenu = document.getElementById('history-export-dropdown-menu');

                historyExportDropdownBtn?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    historyExportDropdownMenu.classList.toggle('hidden');
                });

                document.getElementById('export-filtered-history-btn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    exportHistory(displayedTransactions, currentTransactionType);
                    historyExportDropdownMenu.classList.add('hidden');
                });

                document.getElementById('export-all-tab-history-btn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    const allOfType = allTransactions.filter(t => t.type === currentTransactionType);
                    exportHistory(allOfType, currentTransactionType);
                    historyExportDropdownMenu.classList.add('hidden');
                });

                document.getElementById('export-selected-history-btn-new')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (e.currentTarget.classList.contains('cursor-not-allowed')) return;
                    const selected = allTransactions.filter(t => selectedTransactionIds.has(String(t.id)));
                    exportHistory(selected, currentTransactionType);
                    historyExportDropdownMenu.classList.add('hidden');
                });

                // --- SỰ KIỆN CHO DROPDOWN XUẤT EXCEL (VẬN CHUYỂN) ---
                const shippingExportDropdownBtn = document.getElementById('shipping-export-dropdown-btn');
                const shippingExportDropdownMenu = document.getElementById('shipping-export-dropdown-menu');

                shippingExportDropdownBtn?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    shippingExportDropdownMenu.classList.toggle('hidden');
                });

                document.getElementById('export-filtered-shipping-btn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    exportShipments(displayedShipments);
                    shippingExportDropdownMenu.classList.add('hidden');
                });

                document.getElementById('export-all-tab-shipping-btn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    exportShipments(allShipments);
                    shippingExportDropdownMenu.classList.add('hidden');
                });

                document.getElementById('export-selected-shipping-btn-new')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (e.currentTarget.classList.contains('cursor-not-allowed')) return;
                    const selected = allShipments.filter(s => selectedShippingIds.has(String(s.id)));
                    exportShipments(selected);
                    shippingExportDropdownMenu.classList.add('hidden');
                });

                // Đóng dropdown khi click ra ngoài
                window.addEventListener('click', (e) => {
                    if (!historyExportDropdownBtn?.contains(e.target)) {
                        historyExportDropdownMenu?.classList.add('hidden');
                    }
                    if (!shippingExportDropdownBtn?.contains(e.target)) {
                        shippingExportDropdownMenu?.classList.add('hidden');
                    }
                });
                const exportHistory = (transactions, type = 'GiaoDich') => {
                    if (transactions.length === 0) {
                        showToast("Không có giao dịch nào để xuất.", true);
                        return;
                    }
                    const dataToExport = [];
                    transactions.forEach(t => {
                        t.items.forEach(item => {
                            dataToExport.push({
                                'ID Giao dịch': t.id,
                                'Ngày': formatDate(t.created_at, false),
                                'Loại phiếu': { 'import': 'Nhập kho', 'export': 'Xuất kho', 'return': 'Trả hàng', 'order': 'Đặt hàng', 'forecast': 'Dự kiến xuất' }[t.type] || t.type,
                                'Khách hàng': t.customer, 'Nhóm hàng': item.category, 'Tên hàng': item.name, 'Mã hàng': item.code,
                                'Số lượng': item.quantity, 'Ghi chú': item.note
                            });
                        });
                    });

                    const filename = `LichSu${type.charAt(0).toUpperCase() + type.slice(1)}`;
                    exportToExcel(dataToExport, filename);
                    showToast("Xuất file Excel thành công!");


                    const historySelectAllCheckbox = document.getElementById('history-select-all-checkbox');
                    if (historySelectAllCheckbox) { historySelectAllCheckbox.checked = false; }
                    const checkboxes = historyTableBody?.querySelectorAll('.history-checkbox');
                    if (checkboxes) { checkboxes.forEach(cb => { cb.checked = false; }); }
                    selectedTransactionIds.clear();
                    updateSelectedHistoryCount();
                };
                exportExcelBtn?.addEventListener('click', exportProductList);
                // --- CÁC HÀM HÀNH ĐỘNG KHÁC ---
                const handleStockItemFilter = () => {
                    const stockItemSearch = document.getElementById('stock-item-search');
                    const searchTerm = stockItemSearch?.value.toLowerCase().trim();
                    if (!searchTerm) {
                        filteredStockItems = [...allStockItems];
                    } else {
                        filteredStockItems = allStockItems.filter(item =>
                            `${item.customer || ''} ${item.name || ''} ${item.code || ''} ${item.category || ''} ${item.note || ''}`.toLowerCase().includes(searchTerm)
                        );
                    }
                    stockCurrentPage = 1;
                    displayCurrentStockPage();
                };
                const updateSelectedHistoryCount = () => {
                    const count = selectedTransactionIds.size;

                    // Cập nhật số đếm và trạng thái cho nút "Xóa đã chọn"
                    const selectedHistoryCountDeleteElement = document.getElementById('selected-history-count-delete');
                    if (selectedHistoryCountDeleteElement) selectedHistoryCountDeleteElement.textContent = count;
                    const deleteSelectedHistoryBtnElement = document.getElementById('delete-selected-history-btn');
                    if (deleteSelectedHistoryBtnElement) deleteSelectedHistoryBtnElement.disabled = count === 0;

                    // Cập nhật số đếm và trạng thái cho nút "Đưa vào vận chuyển"
                    const selectedHistoryCountShipping = document.getElementById('selected-history-count-shipping');
                    if (selectedHistoryCountShipping) selectedHistoryCountShipping.textContent = count;
                    const addToShippingBtn = document.getElementById('add-to-shipping-btn');
                    if (addToShippingBtn) addToShippingBtn.disabled = count === 0;
                };
                const updateSelectedShippingCount = () => {
                    const count = selectedShippingIds.size;
                    if (selectedShippingCountSpan) selectedShippingCountSpan.textContent = count;
                    if (selectedShippingCountDeleteSpan) selectedShippingCountDeleteSpan.textContent = count;

                    const disableButtons = count === 0;
                    if (exportSelectedShippingBtn) exportSelectedShippingBtn.disabled = disableButtons;
                    if (deleteSelectedShippingBtn) deleteSelectedShippingBtn.disabled = disableButtons;

                    // Update the "select all" checkbox state
                    const totalShippingItemsOnPage = document.querySelectorAll('.shipping-checkbox').length;
                    if (shippingSelectAllCheckbox) {
                        shippingSelectAllCheckbox.checked = count > 0 && count === totalShippingItemsOnPage;
                        shippingSelectAllCheckbox.indeterminate = count > 0 && count < totalShippingItemsOnPage;
                    }
                };
                const deleteTransactions = async (idsToDelete, showSuccessToast = true) => {
                    const idsArray = Array.from(idsToDelete).map(id => parseInt(id));
                    if (idsArray.length === 0) return;
                    try {
                        const { error } = await supabase.rpc('delete_transactions', { p_transaction_ids: idsArray });
                        if (error) throw error;
                        if (showSuccessToast) showToast(`Đã xóa thành công ${idsArray.length} giao dịch.`);
                    } catch (error) {
                        console.error("Error deleting transactions:", error);
                        showToast(`Lỗi khi xóa phiếu. Tồn kho có thể không chính xác. Message: ${error.message}`, true);
                    }
                };

                const deleteShipments = async (idsToDelete) => {
                    const idsArray = Array.from(idsToDelete).map(id => parseInt(id));
                    if (idsArray.length === 0) return;
                    try {
                        const { error } = await supabase.from('shipments')
                            .delete()
                            .in('id', idsArray);
                        if (error) throw error;
                        showToast(`Đã xóa thành công ${idsArray.length} đơn vận chuyển.`);
                    } catch (error) {
                        console.error("Error deleting shipments:", error);
                        showToast(`Lỗi khi xóa đơn vận chuyển: ${error.message}`, true);
                    } finally {
                        selectedShippingIds.clear(); // Clear selection after delete
                        updateSelectedShippingCount(); // Update UI
                        fetchShippingData(); // Re-fetch data
                    }
                };

                const exportShipments = (shipmentsToExport) => {
                    if (shipmentsToExport.length === 0) {
                        showToast("Không có đơn vận chuyển nào để xuất.", true);
                        return;
                    }
                    const dataToExport = shipmentsToExport.map(s => ({
                        'ID Đơn vận chuyển': s.id,
                        'Ngày tạo': formatDate(s.transaction?.created_at, false),
                        'Khách hàng': s.transaction?.customer,
                        'Đơn vị vận chuyển': s.carrier,
                        'Mã vận đơn': s.tracking_code,
                        'Ghi chú': s.shipping_notes,
                        'Trạng thái': s.status,
                    }));
                    exportToExcel(dataToExport, "DanhSachDonVanChuyen");
                    showToast(`Xuất file Excel thành công ${shipmentsToExport.length} đơn vận chuyển!`);
                    selectedShippingIds.clear();
                    updateSelectedShippingCount();
                    displayCurrentShippingPage(); // <--- THÊM DÒNG NÀY VÀO ĐÂY
                };

                const filterHistoryDetailItems = () => {
                    const historyDetailSearchElement = document.getElementById('history-detail-search');
                    const searchTerm = historyDetailSearchElement?.value.toLowerCase().trim();
                    if (!searchTerm) {
                        renderHistoryDetailItems(currentHistoryDetailItems);
                        return;
                    }
                    const filtered = currentHistoryDetailItems.filter(item =>
                        (item.name || '').toLowerCase().includes(searchTerm) ||
                        (item.code || '').toLowerCase().includes(searchTerm) ||
                        (item.category || '').toLowerCase().includes(searchTerm)
                    );
                    renderHistoryDetailItems(filtered);
                };
                const renderHistoryDetailItems = (itemsToRender) => {
                    const detailBody = document.getElementById('history-detail-table-body');
                    if (detailBody) detailBody.innerHTML = '';
                    if (itemsToRender.length === 0) {
                        if (detailBody) detailBody.innerHTML = `<tr><td colspan="5" class="text-center p-6 text-gray-500">Không tìm thấy sản phẩm.</td></tr>`;
                        return;
                    }
                    itemsToRender.forEach(item => {
                        if (detailBody) {
                            const row = detailBody.insertRow();
                            row.innerHTML = `
                                <td class="p-3">${item.category}</td>
                                <td class="p-3 name-col">${item.name}</td>
                                <td class="p-3 font-mono text-sm">${item.code}</td>
                                <td class="p-3 text-center font-bold">${item.quantity}</td>
                                <td class="p-3 note-col">${item.note || ''}</td>
                            `;
                        }
                    });
                };
                const openTransactionDetailModal = (transaction) => {
                    const historyDetailDateElement = document.getElementById('history-detail-date');
                    if (historyDetailDateElement) historyDetailDateElement.textContent = formatDate(transaction.created_at, false);
                    const historyDetailTypeElement = document.getElementById('history-detail-type');
                    if (historyDetailTypeElement) historyDetailTypeElement.textContent = { 'import': 'Nhập kho', 'export': 'Xuất kho', 'return': 'Trả hàng', 'order': 'Đặt hàng', 'forecast': 'Dự kiến xuất' }[transaction.type] ||
                        transaction.type;
                    const historyDetailCustomerElement = document.getElementById('history-detail-customer');
                    if (historyDetailCustomerElement) historyDetailCustomerElement.textContent = transaction.customer || 'N/A';
                    const historyDetailSearchElement = document.getElementById('history-detail-search');
                    if (historyDetailSearchElement) historyDetailSearchElement.value = '';
                    currentHistoryDetailItems = transaction.items;
                    renderHistoryDetailItems(currentHistoryDetailItems);

                    // ẨN CÁC NÚT HÀNH ĐỘNG TRONG MODAL CHI TIẾT GIAO DỊCH
                    document.getElementById('history-detail-edit-btn').classList.add('hidden');
                    document.getElementById('history-detail-export-btn').classList.add('hidden');
                    document.getElementById('history-detail-delete-btn').classList.add('hidden');

                    openModal(historyDetailModal);
                };
    // Tìm hàm openTransactionForEdit và thay thế đoạn mapping allStockItems
const openTransactionForEdit = (transaction) => {
    const submitBtn = document.getElementById('submit-stock-btn');
    if (submitBtn) {
        submitBtn.textContent = 'Xác Nhận';
        submitBtn.classList.remove('bg-blue-600');
        submitBtn.classList.add('bg-green-500');
    }

    stockEntryMode = 'edit';
    openStockModal();
    const stockModalTitle = document.getElementById('stock-modal-title');
    if (stockModalTitle) stockModalTitle.textContent = 'Chỉnh sửa Phiếu';
    const editingTransactionId = document.getElementById('editing-transaction-id');
    if (editingTransactionId) editingTransactionId.value = transaction.id;
    const stockSingleCustomer = document.getElementById('stock-single-customer');
    if (stockSingleCustomer) stockSingleCustomer.value = transaction.customer;

    const stockDate = document.getElementById('stock-date');
    if (stockDate) {
        stockDate.value = new Date(transaction.created_at).toISOString().split('T')[0];
        stockDate.disabled = false; // THÊM DÒNG NÀY ĐỂ BẬT LẠI Ô NGÀY THÁNG
    }
    
    // ************ ĐOẠN CODE CẦN SỬA ĐỔI ************
    allStockItems = transaction.items.map(item => {
    // Tìm sản phẩm khớp trong allProducts (dữ liệu hiện tại của kho)
    const matchedProduct = allProducts.find(p => p.id === item.product_id || p.code === item.code);
    
    // Đánh dấu isValid dựa trên việc tìm thấy sản phẩm
    const isValidItem = !!matchedProduct; // true nếu tìm thấy, false nếu không
    
    return {
    id: Date.now() + Math.random(), // Cần ID duy nhất cho mỗi dòng trong modal
    customer: transaction.customer,
    category: matchedProduct ? matchedProduct.category : (item.category || 'Lỗi'), // Lấy từ sản phẩm khớp hoặc từ item cũ
    productId: matchedProduct ? matchedProduct.id : null,
    name: matchedProduct ? matchedProduct.name : `Lỗi: ${item.name} (mã: ${item.code})`, // Hiển thị rõ lỗi nếu không tìm thấy
    code: matchedProduct ? matchedProduct.code : (item.code || 'Lỗi'),
    quantity: item.quantity,
    note: item.note || '',
    isValid: isValidItem, // Gán trạng thái isValid đã tính toán
    created_at: item.created_at || transaction.created_at
    };
    });
    // ************ KẾT THÚC ĐOẠN CODE CẦN SỬA ĐỔI ************
    
    const stockTypeRadio = document.querySelector(`input[name="stock-type"][value="${transaction.type}"]`);
    if (stockTypeRadio) stockTypeRadio.checked = true;
    
    // Sau khi cập nhật allStockItems, lọc và hiển thị lại bảng
    handleStockItemFilter();
    };
               
    const openStockModal = () => {
    if (!isDataReady) {
        showToast("Dữ liệu sản phẩm đang được tải, vui lòng chờ giây lát.", true);
        return;
    }
    if (allProducts.length === 0 && isDataReady && stockEntryMode !== 'import') {
        showToast("Kho đang trống. Vui lòng thêm sản phẩm trước khi tạo phiếu.", true);
        return;
    }
    const editingTransactionId = document.getElementById('editing-transaction-id')?.value;
    if (!editingTransactionId) {
        if (stockEntryMode !== 'order' && stockEntryMode !== 'edit') {
            allStockItems = [];
            filteredStockItems = [];
        }
    }
    stockCurrentPage = 1;
    const stockItemSearch = document.getElementById('stock-item-search');
    if (stockItemSearch) stockItemSearch.value = '';
    const stockDate = document.getElementById('stock-date');
    if (stockDate) {
        stockDate.value = getTodayDate();
        stockDate.disabled = false; // Đảm bảo ô ngày được bật
    }
    const stockSingleCustomer = document.getElementById('stock-single-customer');
    if (stockSingleCustomer) stockSingleCustomer.value = '';

    document.querySelectorAll('input[name="stock-type"]').forEach(radio => {
        radio.checked = false;
    });

    toggleStockModalView();
    if (allStockItems.length > 0) {
        handleStockItemFilter();
    } else if (stockEntryMode === 'manual') {
        addStockItemRow();
    }

    openModal(stockModal);
};
                // --- GÁN SỰ KIỆN BAN ĐẦU ---
    function setupListeners() {
    const tabs = document.querySelectorAll('.sidebar-tab-btn');
    const panels = {
    'tab-notes': document.getElementById('panel-notes'),
    'tab-products': document.getElementById('panel-products'),
    'open-stock-manual-btn': document.getElementById('panel-stock-manual'),
    'tab-import': document.getElementById('panel-history'),
    'tab-export': document.getElementById('panel-history'),
    'tab-return': document.getElementById('panel-history'),
    'tab-order': document.getElementById('panel-history'),
    'tab-forecast': document.getElementById('panel-history'),
    'tab-shipping': document.getElementById('panel-shipping'),
    };
    
    tabs.forEach(tab => {
    tab.addEventListener('click', () => {
    Object.values(panels).forEach(p => { if(p) p.classList.add('hidden') });
    tabs.forEach(t => {
    t.classList.remove('active', 'bg-blue-600', 'text-white', 'font-semibold', 'border-l-4', 'border-blue-200',
    'pl-[calc(1.5rem-4px)]');
    t.classList.add('text-gray-300', 'hover:bg-gray-700', 'hover:text-white', 'pl-6');
    });
    
    tab.classList.add('active', 'bg-blue-600', 'text-white', 'font-semibold', 'border-l-4', 'border-blue-200',
    'pl-[calc(1.5rem-4px)]');
    tab.classList.remove('text-gray-300', 'hover:bg-gray-700', 'hover:text-white', 'pl-6');
    
    if (panels[tab.id]) {
    panels[tab.id].classList.remove('hidden');
    }
    
    if (tab.id === 'tab-products') {
    currentTransactionType = null;
    resetHistoryTab();
    resetShippingTab();
    applyFiltersAndRender();
    } else if (tab.id === 'tab-shipping') {
    currentTransactionType = null;
    resetProductsTab();
    resetHistoryTab();
    fetchShippingData();
    } else if (tab.id === 'tab-notes') {
    currentTransactionType = null;
    resetProductsTab();
    resetHistoryTab();
    resetShippingTab();
    fetchNotes();
    } else if (tab.id === 'open-stock-manual-btn') {
    currentTransactionType = null;
    stockEntryMode = 'manual';
    openStockModal();
    resetProductsTab();
    resetHistoryTab();
    resetShippingTab();
    } else {
    currentTransactionType = tab.id.replace('tab-', '');
    resetProductsTab();
    resetShippingTab();
    applyHistoryFilterAndRender();
    updateTransactionTabUI();
    }
    });
    });
    // =================================================================
// === BẮT ĐẦU: LOGIC TÌM KIẾM BẰNG GEMINI (FUNCTION CALLING) ===
// =================================================================

// 1. Định nghĩa các "công cụ" mà Gemini có thể sử dụng
// Hiện tại, chúng ta có công cụ tìm kiếm sản phẩm.
const tools = [{
    "functionDeclarations": [{
        "name": "tim_kiem_san_pham",
        "description": "Tìm kiếm sản phẩm trong kho dựa trên từ khóa và tùy chọn kiểm tra tồn kho. Trả về một danh sách các sản phẩm khớp.",
        "parameters": {
            "type": "OBJECT",
            "properties": {
                "tu_khoa": {
                    "type": "ARRAY",
                    "description": "Danh sách các từ khóa để tìm kiếm, ví dụ: ['đôi 3 chấu', 'vàng']",
                    "items": { "type": "STRING" }
                },
                "chi_kiem_tra_ton_kho": {
                    "type": "BOOLEAN",
                    "description": "Nếu là true, chỉ trả về các sản phẩm có số lượng tồn kho lớn hơn 0."
                }
            },
            "required": ["tu_khoa"]
        }
    }]
}];

// 2. Hàm thực thi việc tìm kiếm sản phẩm trong dữ liệu `allProducts` của bạn
function executeProductSearch(args) {
    let keywords = args.tu_khoa || [];
    let checkInventory = args.chi_kiem_tra_ton_kho || false;

    if (keywords.length === 0) {
        return [];
    }

    let results = allProducts;

    // Lọc qua từng từ khóa
    keywords.forEach(keyword => {
        const lowerKeyword = keyword.toLowerCase();
        results = results.filter(p => (p.searchable_name || '').toLowerCase().includes(lowerKeyword));
    });

    // Lọc theo tồn kho nếu được yêu cầu
    if (checkInventory) {
        results = results.filter(p => p.quantity > 0);
    }
    return results;
}

// 3. Lấy các DOM element của ô tìm kiếm
const geminiSearchInput = document.getElementById('gemini-search-input');
const geminiSearchBtn = document.getElementById('gemini-search-btn');
const geminiSearchResultsDiv = document.getElementById('gemini-search-results');

// 4. Hàm chính xử lý yêu cầu tìm kiếm
async function handleGeminiSearch() {
    const userQuery = geminiSearchInput.value.trim();
    if (!userQuery) {
        showToast("Vui lòng nhập câu hỏi.", true);
        return;
    }

    geminiSearchBtn.disabled = true;
    geminiSearchBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang xử lý...';
    geminiSearchResultsDiv.innerHTML = '<p class="text-gray-500">Gemini đang phân tích câu hỏi của bạn...</p>';

    try {
        // **PHẦN QUAN TRỌNG: GỌI SUPABASE EDGE FUNCTION**
        // Đây là nơi bạn sẽ gọi đến Edge Function của mình, không gọi Gemini API trực tiếp.
        const { data, error } = await supabase.functions.invoke('gemini-function-calling', {
            body: {
                prompt: userQuery,
                tools: tools
            },
        });

        if (error) throw new Error(error.message);

        const responseContent = data; // Giả sử function trả về nội dung của Gemini

        // 5. Xử lý phản hồi từ Gemini
        const functionCall = responseContent.candidates[0].content.parts[0].functionCall;

        if (functionCall) {
            if (functionCall.name === 'tim_kiem_san_pham') {
                const searchResults = executeProductSearch(functionCall.args);
                displaySearchResults(searchResults, userQuery);
            }
        } else {
            // Nếu Gemini không gọi hàm mà trả lời văn bản, hiển thị trực tiếp
            const textResponse = responseContent.candidates[0].content.parts[0].text;
            geminiSearchResultsDiv.innerHTML = `<p class="text-gray-700">${textResponse}</p>`;
        }

    } catch (error) {
        console.error("Lỗi khi tìm kiếm bằng Gemini:", error);
        geminiSearchResultsDiv.innerHTML = `<p class="text-red-500">Đã xảy ra lỗi: ${error.message}. Vui lòng kiểm tra lại Edge Function và API Key.</p>`;
    } finally {
        geminiSearchBtn.disabled = false;
        geminiSearchBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Gửi';
    }
}

// 6. Hàm hiển thị kết quả tìm kiếm ra giao diện
function displaySearchResults(results, originalQuery) {
    if (results.length === 0) {
        geminiSearchResultsDiv.innerHTML = `<p class="text-gray-500">Không tìm thấy sản phẩm nào khớp với yêu cầu: "<strong>${originalQuery}</strong>"</p>`;
        return;
    }

    let resultsHtml = `<p class="text-gray-700 mb-3">Kết quả cho: "<strong>${originalQuery}</strong>"</p>
                       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;

    results.forEach(p => {
        resultsHtml += `
            <div class="border p-4 rounded-lg bg-white shadow-sm">
                <p class="font-bold text-blue-700">${p.name}</p>
                <p class="text-sm text-gray-500">Mã: ${p.code} | Nhóm: ${p.category}</p>
                <p class="mt-2">Tồn kho: <strong class="text-xl ${p.quantity > 0 ? 'text-green-600' : 'text-red-600'}">${p.quantity}</strong></p>
            </div>
        `;
    });

    resultsHtml += `</div>`;
    geminiSearchResultsDiv.innerHTML = resultsHtml;
}

// 7. Gán sự kiện cho nút bấm và phím Enter
geminiSearchBtn.addEventListener('click', handleGeminiSearch);
geminiSearchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        handleGeminiSearch();
    }
});

// ===============================================================
// === KẾT THÚC: LOGIC TÌM KIẾM BẰNG GEMINI (FUNCTION CALLING) ===
// ===============================================================
        // DÁN VÀO TRONG HÀM setupListeners()
        document.getElementById('transaction-type-list')?.addEventListener('change', () => {
        updateValidationMessage();
        });
        // --- EVENT LISTENERS CHO GHI CHÚ ---
        document.getElementById('add-note-btn')?.addEventListener('click', () => {
        const newNoteEl = document.createElement('div');
        newNoteEl.className = 'note-card';
        newNoteEl.innerHTML = `
        <div class="note-content">
            <textarea class="note-content-edit" placeholder="Nhập nội dung ghi chú..."></textarea>
        </div>
        <div class="note-footer">
            <span>Đang soạn...</span>
            <div class="note-actions">
                <button class="save-new-note-btn" title="Lưu"><i class="fas fa-save"></i></button>
                <button class="cancel-new-note-btn" title="Hủy"><i class="fas fa-times"></i></button>
            </div>
        </div>
        `;
        notesContainer.insertBefore(newNoteEl, notesContainer.firstChild);
        newNoteEl.querySelector('textarea').focus();
        });
        
        notesContainer?.addEventListener('click', (e) => {
        const card = e.target.closest('.note-card');
        if (!card) return;
        
        const isEditBtn = e.target.closest('.edit-note-btn');
        const isDeleteBtn = e.target.closest('.delete-note-btn');
        const isSaveEditBtn = e.target.closest('.save-edit-note-btn');
        const isCancelEditBtn = e.target.closest('.cancel-edit-note-btn');
        const isSaveNewBtn = e.target.closest('.save-new-note-btn');
        const isCancelNewBtn = e.target.closest('.cancel-new-note-btn');
        
        if (isEditBtn) {
        const contentDiv = card.querySelector('.note-content');
        const originalContent = contentDiv.textContent;
        contentDiv.innerHTML = `<textarea class="note-content-edit">${originalContent}</textarea>`;
        const textarea = contentDiv.querySelector('textarea');
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
        
        const actionsDiv = card.querySelector('.note-actions');
        actionsDiv.innerHTML = `
        <button class="save-edit-note-btn" title="Lưu"><i class="fas fa-save"></i></button>
        <button class="cancel-edit-note-btn" title="Hủy"><i class="fas fa-times"></i></button>
        `;
        } else if (isSaveEditBtn) {
        const noteId = card.dataset.noteId;
        const newContent = card.querySelector('.note-content-edit').value;
        handleSaveNote(noteId, newContent);
        } else if (isCancelEditBtn) {
        renderNotes();
        } 
        // CODE MỚI ĐÃ SỬA LỖI
        else if (isDeleteBtn) {
        const noteId = card.dataset.noteId;
        handleAsyncAction(
        async () => {
        const { error } = await supabase.from('notes').delete().eq('id', noteId);
        if (error) throw error;
        },
        {
        confirmTitle: 'Xác nhận Xóa Ghi chú',
        confirmMessage: 'Bạn có chắc chắn muốn xóa ghi chú này? Hành động này không thể hoàn tác.',
        successMessage: 'Đã xóa ghi chú thành công!',
        errorMessage: 'Lỗi khi xóa ghi chú.'
        }
        ).then(() => {
        fetchNotes(); // <-- THÊM DÒNG NÀY ĐỂ LÀM MỚI DANH SÁCH
         });
          }
        else if (isSaveNewBtn) {
        const newContent = card.querySelector('.note-content-edit').value;
        handleSaveNote(null, newContent);
        } else if (isCancelNewBtn) {
        card.remove();
        }
        });
        
        // --- CÁC EVENT LISTENERS KHÁC ---
        // (Phần code này giữ nguyên như cũ, đây là phiên bản sạch của nó)
        
        document.getElementById('stock-items-container')?.addEventListener('keydown', (e) => {
        if (e.target.classList.contains('stock-quantity-input') && e.key === 'Enter') {
        e.preventDefault();
        const currentRow = e.target.closest('tr');
        if (!currentRow) return;
        const nextRow = currentRow.nextElementSibling;
        if (nextRow) {
        const nextQuantityInput = nextRow.querySelector('.stock-quantity-input');
        if (nextQuantityInput) {
        nextQuantityInput.focus();
        nextQuantityInput.select();
        }
        } else {
        addStockItemRow();
        setTimeout(() => {
        const lastRow = document.getElementById('stock-items-container').lastElementChild;
        if (lastRow) {
        lastRow.querySelector('.stock-quantity-input')?.focus();
        }
        }, 50);
        }
        }
        });
        
        document.getElementById('min-quantity-filter')?.addEventListener('input', debounce(() => {
        dashboardFilterType = 'all';
        applyFiltersAndRender();
        }, 300));
        document.getElementById('max-quantity-filter')?.addEventListener('input', debounce(() => {
        dashboardFilterType = 'all';
        applyFiltersAndRender();
        }, 300));
                // === KẾT THÚC BỔ SUNG ===
                    document.getElementById('open-product-modal-btn')?.addEventListener('click', openAddModal);
                    document.getElementById('close-product-modal-btn')?.addEventListener('click', () => closeModal(productModal));
               
                    // Dán đoạn mã này vào trong hàm setupListeners()
                document.getElementById('close-stock-modal-x-btn')?.addEventListener('click', confirmAndCloseStockModal);
                     
                // Thay thế mã cũ bằng dòng này
document.getElementById('close-stock-modal-btn')?.addEventListener('click', confirmAndCloseStockModal);
                    document.getElementById('close-history-detail-modal-btn')?.addEventListener('click', () => closeModal(historyDetailModal));
                    document.getElementById('close-import-error-modal-btn')?.addEventListener('click', () => closeModal(importErrorModal));
                    [productModal, stockModal, statusModal, validationModal, importConfirmModal, historyDetailModal, importErrorModal].forEach(modal => {
                        if (modal) {
                           // modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
                        }
                    });
                    toggleBulkEditProductsBtn?.addEventListener('click', () => toggleProductBulkEditMode(true));
                    cancelBulkEditProductsBtn?.addEventListener('click', () => toggleProductBulkEditMode(false));

                    lowStockCard?.addEventListener('click', () => {
                        dashboardFilterType = 'low-stock';
                        applyFiltersAndRender();
                        document.getElementById('tab-products')?.click();
                    });

                    outOfStockCard?.addEventListener('click', () => {
                        dashboardFilterType = 'out-of-stock';
                        applyFiltersAndRender();
                        document.getElementById('tab-products')?.click();
                    });
                    productSelectAllCheckbox?.addEventListener('change', (e) => {
                        const isChecked = e.target.checked;
                        document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                            checkbox.checked = isChecked;
                            if (isChecked) {
                                selectedProductIds.add(checkbox.dataset.id);
                            } else {
                                selectedProductIds.delete(checkbox.dataset.id);
                            }
                        });
                        updateProductBulkActionsUI();
                    });
                    productTableBody?.addEventListener('change', (e) => {
                        const checkbox = e.target.closest('.product-checkbox');
                        if (checkbox) {
                            if (checkbox.checked) {
                                selectedProductIds.add(checkbox.dataset.id);
                            } else {
                                selectedProductIds.delete(checkbox.dataset.id);
                            }
                            updateProductBulkActionsUI();
                        }
                    });
                    bulkDeactivateProductsBtn?.addEventListener('click', () => updateProductStatusBulk(false));
                    bulkActivateProductsBtn?.addEventListener('click', () => updateProductStatusBulk(true));
                    bulkDeleteProductsBtn?.addEventListener('click', deleteProductsBulk);
                    bulkOrderProductsBtn?.addEventListener('click', createOrderForSelectedProducts);
                    productTableBody?.addEventListener('click', (e) => {
                        const editBtn = e.target.closest('.edit-btn');
                        const deleteBtn = e.target.closest('.delete-btn');
                        if (editBtn) { const product = allProducts.find(p => p.id === parseInt(editBtn.dataset.id)); if (product) openEditModal(product); }

                        if (deleteBtn) {
                            handleAsyncAction(() => supabase.from('products').delete().eq('id', deleteBtn.dataset.id), {
                                confirmTitle: 'Xác nhận Xóa Sản phẩm', confirmMessage: 'Hành động này sẽ xóa vĩnh viễn sản phẩm. Không thể hoàn tác.',
                                successMessage: 'Xóa sản phẩm thành công!', errorMessage: 'Lỗi khi xóa sản phẩm.'
                            });
                        }
                    });
                    const submitStockBtn = document.getElementById('submit-stock-btn');
                    submitStockBtn?.addEventListener('click', async (e) => {
    e.preventDefault();

    const typeElement = document.querySelector('input[name="stock-type"]:checked');
    const transactionType = typeElement ? typeElement.value : 'import'; // Đây là biến dùng cho thông báo kiểm tra ban đầu

    const totalRows = allStockItems.length;
    const validItemsCount = allStockItems.filter(item => item.isValid && item.productId && item.quantity > 0).length;
    const errorItemsCount = totalRows - validItemsCount;
    const uniqueCustomersCount = new Set(allStockItems.filter(item =>
        item.isValid && item.quantity > 0).map(item => item.customer)).size || (validItemsCount > 0 ? 1 : 0);

    const validationCustomerCount = document.getElementById('validation-customer-count');
    const validationValidCount = document.getElementById('validation-valid-count');
    const validationErrorCount = document.getElementById('validation-error-count');
    const validationMessage = document.getElementById('validation-message');

    if (validationCustomerCount) validationCustomerCount.textContent = uniqueCustomersCount;
    if (validationValidCount) validationValidCount.textContent = validItemsCount;
    if (validationErrorCount) validationErrorCount.textContent = errorItemsCount;

    // Gọi hàm duy nhất để cập nhật mọi thứ trên modal xác nhận ban đầu
    updateValidationMessage();
    document.getElementById('validation-initial-wrapper')?.classList.remove('hidden');
    document.getElementById('validation-processing')?.classList.add('hidden');
    document.getElementById('validation-completed')?.classList.add('hidden');
    openModal(validationModal);

    const validationConfirmBtn = document.getElementById('validation-confirm-btn');
    const validationCloseBtn = document.getElementById('validation-close-btn');

    validationConfirmBtn.onclick = null;
    validationCloseBtn.onclick = null;

    if (validItemsCount > 0) {
        validationConfirmBtn.onclick = async () => {
            document.getElementById('validation-initial-wrapper')?.classList.add('hidden');
            document.getElementById('validation-processing')?.classList.remove('hidden');

            const { successCount, errorCount, message } = await executeTransaction();

            const completionIcon = document.getElementById('completion-icon');
            const completionMessage = document.getElementById('completion-message');

            // BẮT ĐẦU PHẦN ĐÃ SỬA: Đảm bảo finalActionText được lấy lại chính xác
            const finalTransactionTypeElement = document.querySelector('input[name="stock-type"]:checked');
            const finalTransactionType = finalTransactionTypeElement ? finalTransactionTypeElement.value : 'import';
            const typeTextMapForCompletion = { // Sử dụng một biến khác để tránh nhầm lẫn
                'import': 'Nhập kho', 'export': 'Xuất kho', 'return': 'Trả hàng',
                'order': 'Đặt hàng', 'forecast': 'Dự kiến xuất'
            };
            const finalActionText = typeTextMapForCompletion[finalTransactionType] || 'Giao dịch';
            // KẾT THÚC PHẦN ĐÃ SỬA

            if (errorCount > 0) {
                if (completionIcon) completionIcon.innerHTML = `<i class="fas fa-times-circle text-5xl text-red-500"></i>`;
                if (completionMessage) completionMessage.innerHTML = `Thất bại! <strong>${message || `Không thể tạo phiếu ${finalActionText}.`}</strong>`;
            } else {
                await fetchInitialData();
                if (completionIcon) completionIcon.innerHTML = `<i class="fas fa-check-circle text-5xl text-green-500"></i>`;
                if (completionMessage) completionMessage.textContent = `Tất cả ${successCount} phiếu ${finalActionText} đã được tạo thành công!`;
            }

            document.getElementById('validation-processing')?.classList.add('hidden');
            document.getElementById('validation-completed')?.classList.remove('hidden');

            if (errorCount === 0) {
                setTimeout(() => {
                    closeModal(validationModal);
                    closeModal(stockModal);
                }, 2000);
            }
        };
    }
    validationCloseBtn.onclick = () => { closeModal(validationModal); };
});

                    document.getElementById('stock-item-search')?.addEventListener('input', debounce(handleStockItemFilter, 300));
                    historyTableBody?.addEventListener('click', (e) => {
                        const viewBtn = e.target.closest('.view-history-btn');
                        const editBtn = e.target.closest('.edit-history-btn');
                        const exportBtn = e.target.closest('.export-history-btn');
                        const deleteBtn = e.target.closest('.delete-history-btn');
                        const checkbox = e.target.closest('.history-checkbox');
                        const transId = viewBtn?.dataset.id || editBtn?.dataset.id || exportBtn?.dataset.id || deleteBtn?.dataset.id || checkbox?.dataset.id;
                        if (!transId) return;
                        const transaction = allTransactions.find(t => t.id === parseInt(transId));

                        if (viewBtn && transaction) openTransactionDetailModal(transaction);
                        else if (editBtn && transaction) openTransactionForEdit(transaction);
                        else if (exportBtn && transaction) exportHistory([transaction]);
                        else if (deleteBtn) {
                            handleAsyncAction(() => deleteTransactions(new Set([transId])), {
                                confirmTitle: 'Xác nhận Xóa Giao dịch', confirmMessage: 'Bạn có chắc muốn xóa giao dịch này? Tồn kho sẽ được hoàn lại. Hành động này không thể hoàn tác.',
                                successMessage: 'Xóa giao dịch thành công!', errorMessage: 'Lỗi khi xóa giao dịch.'
                            });
                        } else if (checkbox) {
                            if (checkbox.checked) selectedTransactionIds.add(transId);
                            else selectedTransactionIds.delete(transId);
                            updateSelectedHistoryCount();
                        }
                    });
                    document.getElementById('logout-btn')?.addEventListener('click', async () => {
                        const { error } = await supabase.auth.signOut();
                        if (error) {
                            console.error("Lỗi đăng xuất:", error.message);
                            showToast(`Đăng xuất thất bại: ${error.message}`, true);
                        } else {
                            showToast("Đăng xuất thành công! Đang chuyển hướng...");
                            window.location.href = 'login.html';
                        }
                    });
                    document.getElementById('history-select-all-checkbox')?.addEventListener('change', (e) => {
                        const isChecked = e.target.checked;
                        const checkboxes = historyTableBody?.querySelectorAll('.history-checkbox');
                        if (checkboxes) {
                            checkboxes.forEach(cb => {
                                cb.checked = isChecked;
                                const transId = cb.dataset.id;
                                if (isChecked) { selectedTransactionIds.add(transId); } else { selectedTransactionIds.delete(transId); }
                            });
                        }
                        updateSelectedHistoryCount();
                    });
                    document.getElementById('export-all-history-btn')?.addEventListener('click', () => exportHistory(allTransactions));
                    document.getElementById('export-selected-history-btn')?.addEventListener('click', () => {
                        const selected = allTransactions.filter(t => selectedTransactionIds.has(String(t.id)));
                        exportHistory(selected);
                    });
                    document.getElementById('delete-selected-history-btn')?.addEventListener('click', () => {
                        if (selectedTransactionIds.size === 0) return;
                        handleAsyncAction(() => deleteTransactions(new Set(selectedTransactionIds)), {
                            confirmTitle: `Xác nhận Xóa ${selectedTransactionIds.size} Giao dịch`,
                            confirmMessage: `Bạn có chắc muốn xóa ${selectedTransactionIds.size} giao dịch đã chọn? Tồn kho sẽ được hoàn lại. Hành động này không thể hoàn tác.`,
                            successMessage: `Đã xóa thành công ${selectedTransactionIds.size} giao dịch.`,
                            errorMessage: 'Có lỗi xảy ra khi xóa các giao dịch.'
                        });
                    });
                    document.getElementById('history-detail-search')?.addEventListener('input', debounce(filterHistoryDetailItems, 300));

                    const productsPerPageSelect = document.getElementById('products-per-page-select');
                    if (productsPerPageSelect) {
                        productsPerPageSelect.value = PRODUCTS_PER_PAGE;
                        productsPerPageSelect.addEventListener('change', (e) => {
                            PRODUCTS_PER_PAGE = parseInt(e.target.value);
                            productsCurrentPage = 1;
                            displayCurrentProductsPage();
                        });
                    }
const totalProductsCard = document.getElementById('total-products-card');
const totalQuantityCard = document.getElementById('total-quantity-card'); // Chỉ giữ lại một lần khai báo này

lowStockCard?.addEventListener('click', () => {
dashboardFilterType = 'low-stock';
applyFiltersAndRender();
document.getElementById('tab-products')?.click();
});

outOfStockCard?.addEventListener('click', () => {
dashboardFilterType = 'out-of-stock';
applyFiltersAndRender();
document.getElementById('tab-products')?.click();
});

// Listener cho "Tổng số sản phẩm"
totalProductsCard?.addEventListener('click', () => {
dashboardFilterType = 'all'; // Đặt lại bộ lọc về "all"
document.getElementById('product-status-filter').value = 'all'; // Đảm bảo hiển thị tất cả trạng thái
applyFiltersAndRender();
document.getElementById('tab-products')?.click(); // Đảm bảo chuyển về tab Sản phẩm
});

// Thêm listener mới cho "Tổng số lượng tồn"
// XÓA DÒNG KHAI BÁO const totalQuantityCard = document.getElementById('total-quantity-card'); ở đây
totalQuantityCard?.addEventListener('click', () => { // Sử dụng biến đã được khai báo ở trên
dashboardFilterType = 'all'; // Đặt lại bộ lọc về "all"
document.getElementById('product-status-filter').value = 'all'; // Đảm bảo hiển thị tất cả trạng thái
applyFiltersAndRender();
document.getElementById('tab-products')?.click(); // Đảm bảo chuyển về tab Sản phẩm
});
                    const historyPerPageSelect = document.getElementById('history-per-page-select');
                    if (historyPerPageSelect) {
                        historyPerPageSelect.value = HISTORY_ITEMS_PER_PAGE;
                        historyPerPageSelect.addEventListener('change', (e) => {
                            HISTORY_ITEMS_PER_PAGE = parseInt(e.target.value);
                            historyCurrentPage = 1;
                            displayCurrentHistoryPage();
                        });
                    }

                    const productStatusFilter = document.getElementById('product-status-filter');
                    if (productStatusFilter) {
                        productStatusFilter.value = 'active';
                        productStatusFilter.addEventListener('change', applyFiltersAndRender);
                    }

                    const urlParams = new URLSearchParams(window.location.search);
                    const initialFilter = urlParams.get('filter');
                    if (initialFilter === 'low-stock') {
                        dashboardFilterType = 'low-stock';
                        document.getElementById('tab-products')?.click();
                    } else if (initialFilter === 'out-of-stock') {
                        dashboardFilterType = 'out-of-stock';
                        document.getElementById('tab-products')?.click();
                    }
                }

                // --- REALTIME & KHỞI TẠO ---
                const listenForData = () => {
                    const handleProductChange = (payload) => {
                        const { eventType, new: newRecord, old: oldRecord } = payload;
                        let needsUpdate = false;
                        if (eventType === 'INSERT') {
                            if (!allProducts.some(p => p.id === newRecord.id)) {
                                allProducts.push(newRecord);
                                needsUpdate = true;
                            }
                        } else if (eventType === 'UPDATE') {
                            const index = allProducts.findIndex(p => p.id === newRecord.id);
                            if (index !== -1) {
                                allProducts[index] = newRecord;
                                needsUpdate = true;
                            }
                        } else if (eventType === 'DELETE') {
                            const initialLength = allProducts.length;
                            allProducts = allProducts.filter(p => p.id !== oldRecord.id);
                            if (allProducts.length < initialLength) needsUpdate = true;
                        }
                        if (needsUpdate) {
                            allProducts.sort((a, b) => (a.original_order || 0) - (b.original_order || 0));
                            debouncedRefreshUI();
                        }
                    };
                    const handleTransactionChange = () => fetchInitialTransactions();
                    if (productSubscription) supabase.removeChannel(productSubscription);
                    productSubscription = supabase.channel('public:products').on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, handleProductChange).subscribe();
                    if (transactionSubscription) supabase.removeChannel(transactionSubscription);
                    transactionSubscription = supabase.channel('public:transactions').on('postgres_changes', { event: '*', schema: 'public', table: 'transactions' }, handleTransactionChange).subscribe();
                    // Thêm listener cho bảng shipments
                    if (shipmentSubscription) supabase.removeChannel(shipmentSubscription);
                    shipmentSubscription = supabase.channel('public:shipments')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'shipments' }, (payload) => {
                            // Nếu đang ở tab vận chuyển thì mới fetch lại
                            if (!shippingPanel?.classList.contains('hidden')) {
                                fetchShippingData();
                            }
                        })
                        .subscribe();
                };
                // --- START: REAL-TIME CHO GHI CHÚ ---
                
                const handleNotesChange = (payload) => {
                const { eventType, new: newRecord, old: oldRecord } = payload;
                if (eventType === 'INSERT') {
                if (!allNotes.some(n => n.id === newRecord.id)) {
                allNotes.push(newRecord);
                }
                } else if (eventType === 'UPDATE') {
                const index = allNotes.findIndex(n => n.id === newRecord.id);
                if (index !== -1) allNotes[index] = newRecord;
                } else if (eventType === 'DELETE') {
                allNotes = allNotes.filter(n => n.id !== oldRecord.id);
                }
                renderNotes();
                }
                
                if (notesSubscription) supabase.removeChannel(notesSubscription);
                notesSubscription = supabase.channel('public:notes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'notes' }, handleNotesChange)
                .subscribe();
                
                // --- END: REAL-TIME CHO GHI CHÚ ---
                const fetchInitialTransactions = async () => {
                    // Không cần lọc theo user_id nữa
                    const { data, error } = await supabase.from('transactions')
                        .select(`*, items`)
                        .order('created_at', { ascending: false });
                    if (error) {
                        console.error("Error fetching transactions:", error);
                        return;
                    }
                    allTransactions = data || [];
                    applyHistoryFilterAndRender();
                };
                // --- SỰ KIỆN CHO NÚT XUẤT EXCEL MỚI (GIAO DỊCH) ---
                document.getElementById('export-history-btn')?.addEventListener('click', () => {
                let transactionsToExport = [];
                // Kiểm tra xem có giao dịch nào được chọn không
                if (selectedTransactionIds.size > 0) {
                transactionsToExport = allTransactions.filter(t => selectedTransactionIds.has(String(t.id)));
                } else {
                // Nếu không, xuất các giao dịch đang được hiển thị
                transactionsToExport = displayedTransactions;
                }
                
                if (transactionsToExport.length === 0) {
                showToast("Không có dữ liệu để xuất.", true);
                return;
                }
                exportHistory(transactionsToExport, currentTransactionType);
                });
                
                // --- SỰ KIỆN CHO NÚT XUẤT EXCEL MỚI (VẬN CHUYỂN) ---
                document.getElementById('export-shipping-btn')?.addEventListener('click', () => {
                let shipmentsToExport = [];
                // Kiểm tra xem có đơn vận chuyển nào được chọn không
                if (selectedShippingIds.size > 0) {
                shipmentsToExport = allShipments.filter(s => selectedShippingIds.has(String(s.id)));
                } else {
                // Nếu không, xuất các đơn đang được hiển thị
                shipmentsToExport = displayedShipments;
                }
                
                if (shipmentsToExport.length === 0) {
                showToast("Không có dữ liệu để xuất.", true);
                return;
                }
                exportShipments(shipmentsToExport);
                });

                const fetchInitialData = async () => {
                    try {
                        // Không cần lọc theo user_id nữa
                        const { data, error } = await supabase.from('products').select('*');
                        if (error) throw error;
                        if (loadingSpinner) loadingSpinner.style.display = 'none';
                        allProducts = data || [];
                        allProducts.sort((a, b) => (a.original_order || 0) - (b.original_order || 0));
                        refreshUI();
                        if (!isDataReady) {
                            isDataReady = true;
                            dataDependentButtons.forEach(btn => { if (btn) btn.disabled = false });
                        }
                        await fetchInitialTransactions();
                    } catch (error) {
                        console.error("Error fetching initial data: ", error);
                        showGlobalError(`Lỗi tải dữ liệu ban đầu: ${error.message}`);
                        if (loadingSpinner) loadingSpinner.innerHTML = `<p class="text-red-500">Không thể tải dữ liệu. Lỗi: ${error.message}</p>`;
                    }
                }
async function main() {
try {
const { data: { session }, error: sessionError } = await supabase.auth.getSession();
if (sessionError || !session) {
window.location.href = 'login.html';
return;
}

userId = session.user.id;
const userIdDisplay = document.getElementById('user-id-display'); // Vẫn giữ để thay đổi nội dung

// Lấy thông tin profile của user
const { data: profile, error: profileError } = await supabase
.from('profiles')
.select('role, full_name') // Thêm 'full_name' vào đây, giả sử bạn có cột này
.eq('id', userId)
.single();

if (profileError && profileError.code !== 'PGRST116') { // Ignore 'exact one row' error for non-admins
console.error("Error fetching user role or name:", profileError);
}

if (profile) {
currentUserRole = profile.role; // Giữ nguyên dòng này để lấy vai trò
    currentUserName = profile.full_name || session.user.email;
if (userIdDisplay) {
// Hiển thị full_name nếu có, nếu không thì hiển thị email hoặc ID
userIdDisplay.textContent = profile.full_name || session.user.email || userId;
}
} else {
// Trường hợp không tìm thấy profile, vẫn hiển thị email hoặc ID
if (userIdDisplay) userIdDisplay.textContent = session.user.email || userId;
}

setupListeners();
await fetchInitialData();
listenForData();
updateUIForRole(); // Cập nhật UI dựa trên vai trò
        document.getElementById('tab-notes')?.click(); // <-- THÊM DÒNG NÀY
} catch (error) {
console.error("Authentication or Initialization failed:", error);
showGlobalError(`Lỗi khởi tạo: ${error.message}`);
}
                    // --- START: CÁC LISTENER MỚI CHO VẬN CHUYỂN ---

                    // Listener cho nút "Đưa vào vận chuyển"
                    document.getElementById('add-to-shipping-btn')?.addEventListener('click', async () => {
                        const idsToShip = Array.from(selectedTransactionIds);
                        if (idsToShip.length === 0) {
                            showToast("Vui lòng chọn giao dịch.", true);
                            return;
                        }

                        // Tạm thời vô hiệu hóa nút để tránh click liên tục
                        const addToShippingBtn = document.getElementById('add-to-shipping-btn');
                        if (addToShippingBtn) {
                            addToShippingBtn.disabled = true;
                            addToShippingBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang xử lý...';
                        }

                        try {
                            // Gọi hàm RPC đã được sửa đổi
                            const { data, error } = await supabase.rpc('create_shipments_from_transactions', { p_transaction_ids: idsToShip });

                            if (error) {
                                showToast(`Lỗi khi đưa vào vận chuyển: ${error.message}`, true);
                                console.error("Lỗi khi tạo shipments:", error);
                                return;
                            }

                            // Phân loại kết quả
                            const createdCount = data.filter(item => item.created_shipment_id !== null).length;
                            const existingTransactionIds = data.filter(item => item.existing_transaction_id !== null).map(item =>
                                item.existing_transaction_id);

                            let successMessage = '';
                            if (createdCount > 0) {
                                successMessage += `Đã thêm thành công ${createdCount} giao dịch vào mục vận chuyển.`;
                            }

                            if (existingTransactionIds.length > 0) {
                                // Lấy thông tin khách hàng từ allTransactions để hiển thị trong thông báo
                                const existingCustomers = allTransactions
                                    .filter(trans => existingTransactionIds.includes(trans.id))
                                    .map(trans => trans.customer || 'Khách lẻ');

                                const uniqueExistingCustomers = [...new Set(existingCustomers)];

                                let customerList = uniqueExistingCustomers.length > 3
                                    ? `${uniqueExistingCustomers.slice(0, 3).join(', ')} và ${uniqueExistingCustomers.length - 3} khách hàng khác`
                                    : uniqueExistingCustomers.join(', ');

                                if (successMessage) {
                                    successMessage += `\nLƯU Ý: Có ${existingTransactionIds.length} giao dịch của khách hàng (${customerList}) đã được đưa vào vận chuyển trước đó và không được thêm lại.`;
                                } else {
                                    successMessage = `Có ${existingTransactionIds.length} giao dịch của khách hàng (${customerList}) đã được đưa vào vận chuyển trước đó và không được thêm lại.`;
                                }
                                showToast(successMessage, true); // Hiển thị màu đỏ hoặc cam cho thông báo có lưu ý
                            } else {
                                showToast(successMessage || `Đã đưa ${idsToShip.length} giao dịch vào mục vận chuyển!`);
                            }


                            selectedTransactionIds.clear(); // Xóa các lựa chọn đã đưa vào vận chuyển
                            updateSelectedHistoryCount(); // Cập nhật lại số lượng đã chọn trên UI
                            document.getElementById('tab-shipping')?.click(); // Chuyển sang tab vận chuyển
                        } finally {
                            // Luôn re-enable nút và reset text
                            if (addToShippingBtn) {
                                addToShippingBtn.disabled = false;
                                addToShippingBtn.innerHTML = '<i class="fas fa-truck-fast mr-2"></i> Đưa vào Vận chuyển (<span id="selected-history-count-shipping">0</span>)';
                            }
                        }
                    });

                    // Listener cho các nút trong bảng vận chuyển (save, edit, view, delete)
                    shippingTableBody?.addEventListener('click', async (e) => {
                        const saveBtn = e.target.closest('.save-shipment-btn');
                        const editBtn = e.target.closest('.edit-shipment-btn');
                        const viewDetailBtn = e.target.closest('.view-transaction-detail-btn');
                        const deleteShipmentBtn = e.target.closest('.delete-shipment-btn');
                        const shippingCheckbox = e.target.closest('.shipping-checkbox');
                        const trackingCodeDisplay = e.target.closest('.tracking-code-display'); // For clicking tracking code

                        const row = e.target.closest('tr');
                        if (!row) return;

                        const shipmentId = row.dataset.shipmentId;

                        // Hàm để chuyển đổi giữa chế độ xem và chỉnh sửa cho một hàng cụ thể
                        const toggleRowEditMode = (enableEdit) => {
                            row.querySelectorAll('.view-mode').forEach(el => el.classList.toggle('hidden', enableEdit));
                            row.querySelectorAll('.shipment-carrier-input, .shipment-tracking-input, .shipment-notes-input, .shipment-status-select').forEach(el => el.classList.toggle('hidden', !enableEdit));

                            row.querySelector('.edit-shipment-btn')?.classList.toggle('hidden', enableEdit);
                            row.querySelector('.save-shipment-btn')?.classList.toggle('hidden', !enableEdit);
                        };

                        if (saveBtn) {
                            const carrier = row.querySelector('.shipment-carrier-input').value;
                            const tracking_code = row.querySelector('.shipment-tracking-input').value;
                            const shipping_notes = row.querySelector('.shipment-notes-input').value;
                            const status = row.querySelector('.shipment-status-select').value;

                            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                            saveBtn.disabled = true;

                            const { error } = await supabase
                                .from('shipments')
                                .update({ carrier, tracking_code, shipping_notes, status })
                                .eq('id', shipmentId);

                            if (error) {
                                showToast(`Lỗi khi cập nhật: ${error.message}`, true);
                                saveBtn.innerHTML = '<i class="fas fa-save"></i>';
                                saveBtn.disabled = false;
                            } else {
                                showToast('Đã lưu thông tin vận chuyển!');
                                toggleRowEditMode(false); // Chuyển về chế độ xem sau khi lưu thành công
                                fetchShippingData(); // Tải lại để cập nhật link và giá trị hiển thị
                            }
                        } else if (editBtn) {
                            toggleRowEditMode(true); // Chuyển sang chế độ chỉnh sửa cho hàng này
                        } else if (viewDetailBtn) {
                            const transactionId = parseInt(viewDetailBtn.dataset.transactionId);
                            const transaction = allTransactions.find(t => t.id === transactionId);
                            if (transaction) {
                                openTransactionDetailModal(transaction);
                            } else {
                                showToast("Không tìm thấy thông tin chi tiết giao dịch.", true);
                            }
                        } else if (deleteShipmentBtn) {
                            const shipmentIdToDelete = deleteShipmentBtn.dataset.shipmentId;
                            if (!shipmentIdToDelete) return;

                            handleAsyncAction(async () => {
                                await deleteShipments(new Set([shipmentIdToDelete])); // Use new deleteShipments function
                            }, {
                                confirmTitle: 'Xác nhận xóa đơn vận chuyển',
                                confirmMessage: 'Bạn có chắc chắn muốn xóa đơn vận chuyển này? Điều này sẽ không ảnh hưởng đến lịch sử giao dịch gốc.',
                                successMessage: 'Đã xóa đơn vận chuyển thành công!',
                                errorMessage: 'Lỗi khi xóa đơn vận chuyển.'
                            });
                        } else if (shippingCheckbox) {
                            const id = shippingCheckbox.dataset.id;
                            if (shippingCheckbox.checked) {
                                selectedShippingIds.add(id);
                            } else {
                                selectedShippingIds.delete(id);
                            }
                            updateSelectedShippingCount();
                            
                        } else if (trackingCodeDisplay) {
                            const trackingCode = trackingCodeDisplay.dataset.trackingCode;
                            if (trackingCode) {
                                // Copy to clipboard
                                navigator.clipboard.writeText(trackingCode).then(() => {
                                    showToast('Đã sao chép mã vận đơn!');
                                }).catch(err => {
                                    console.error('Không thể sao chép mã vận đơn: ', err);
                                    showToast('Không thể sao chép mã vận đơn.', true);
                                });
                                // Open Viettel Post link
                                window.open(`https://viettelpost.com.vn/tra-cuu-hanh-trinh-don/?id=${trackingCode}`, '_blank');
                            }
                        }
                    });

                    // Listener cho checkbox "Chọn tất cả"
                    shippingSelectAllCheckbox?.addEventListener('change', (e) => {
                        const isChecked = e.target.checked;
                        document.querySelectorAll('.shipping-checkbox').forEach(checkbox => {
                            checkbox.checked = isChecked;
                            if (isChecked) {
                                selectedShippingIds.add(checkbox.dataset.id);
                            } else {
                                selectedShippingIds.delete(checkbox.dataset.id);
                            }
                        });
                        updateSelectedShippingCount();
                    });
const shippingPerPageSelect = document.getElementById('shipping-per-page-select'); // Lấy element mới
if (shippingPerPageSelect) {
shippingPerPageSelect.value = SHIPPING_ITEMS_PER_PAGE; // Gán giá trị ban đầu
shippingPerPageSelect.addEventListener('change', (e) => {
SHIPPING_ITEMS_PER_PAGE = parseInt(e.target.value); // Cập nhật biến State
shippingCurrentPage = 1; // Đặt lại về trang 1
displayCurrentShippingPage(); // Hiển thị lại trang
});
}
                    // Listener cho nút "Xóa Đã Chọn"
                    deleteSelectedShippingBtn?.addEventListener('click', () => {
                        if (selectedShippingIds.size === 0) return;
                        handleAsyncAction(async () => {
                            await deleteShipments(selectedShippingIds);
                        }, {
                            confirmTitle: `Xác nhận xóa ${selectedShippingIds.size} đơn vận chuyển`,
                            confirmMessage: `Bạn có chắc chắn muốn xóa ${selectedShippingIds.size} đơn vận chuyển đã chọn? Điều này sẽ không ảnh hưởng đến lịch sử giao dịch gốc.`,
                            successMessage: `Đã xóa thành công ${selectedShippingIds.size} đơn vận chuyển.`,
                            errorMessage: 'Lỗi khi xóa các đơn vận chuyển.'
                        });
                    });

                    // Listener cho nút "Xuất Đã Chọn"
                    exportSelectedShippingBtn?.addEventListener('click', () => {
                        if (selectedShippingIds.size === 0) return;
                        const shipmentsToExport = allShipments.filter(s => selectedShippingIds.has(String(s.id)));
                        exportShipments(shipmentsToExport);
                    });


                    shippingSearchInput?.addEventListener('input', debounce(applyShippingFilterAndRender, 300));
                    // --- END: CÁC LISTENER MỚI CHO VẬN CHUYỂN ---
                }
                main();
            });
    </script>

</body>

</html>